{"version":3,"sources":["../src/panels.tsx"],"names":["PSRouter","roomid","panelState","currentRoomid","location","pathname","slice","subscribeHash","extractRoomID","url","startsWith","document","origin","length","host","PS","server","id","replace","test","redirects","hash","join","subscribeAndRun","room","window","addEventListener","e","possibleRoomid","subscribeHistory","history","leftRoomWidth","leftRoom","rightRoom","pushState","title","replaceState","state","split","leftRoomid","rightRoomid","router","PSRoomPanel","subscriptions","componentDidMount","props","focus","onParentEvent","push","subscribe","args","forceUpdate","receiveLine","base","setDimensions","offsetWidth","offsetHeight","componentDidUpdate","includes","componentWillUnmount","subscription","unsubscribe","chooseParentValue","value","dropdownButton","parentElem","changeEvent","Event","dispatchEvent","closePopup","render","preact","Component","PSPanelWrapper","children","style","PSMain","getPopupStyle","width","posStyle","scrollable","elem","target","className","preventDefault","stopImmediatePropagation","clickedRoom","name","getAttribute","userid","toID","addRoom","parentRoomid","containingRoomid","rightPopup","username","update","tagName","href","getRoom","leave","handleButtonClick","rooms","parentElement","popups","isTextInput","type","modifierKey","ctrlKey","altKey","metaKey","shiftKey","keyCode","arrowKeysUsed","focusLeftRoom","focusRightRoom","colorSchemeQuery","matchMedia","media","cs","prefs","theme","body","matches","key","dark","curElem","mainmenu","send","isEmptyClick","selection","getSelection","err","BattleTooltips","hideTooltip","pos","activePanel","top","right","left","display","height","bottom","RangeError","position","visibility","margin","offset","getBoundingClientRect","sourceWidth","sourceHeight","availableHeight","documentElement","clientHeight","Math","max","offsetLeft","clientWidth","availableWidth","maxWidth","renderRoom","roomType","roomTypes","Panel","renderPopup","map","SanitizedHTML","__html","BattleLog","sanitizeHTML"],"mappings":"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","sourcesContent":["/**\n * Panels\n *\n * Main view - sets up the frame, and the generic panels.\n *\n * Also sets up most global event listeners.\n *\n * @author Guangcong Luo <guangcongluo@gmail.com>\n * @license AGPLv3\n */\n\nclass PSRouter {\n\troomid = '' as RoomID;\n\tpanelState = '';\n\tconstructor() {\n\t\tconst currentRoomid = location.pathname.slice(1);\n\t\t// if (/^[a-z0-9-]+$/.test(currentRoomid)) {\n\t\t//\tthis.subscribeHistory();\n\t\t// } else if (location.pathname.endsWith('.html')) {\n\t\t\tthis.subscribeHash();\n\t\t// }\n\t}\n\textractRoomID(url: string) {\n\t\tif (url.startsWith(document.location.origin)) {\n\t\t\turl = url.slice(document.location.origin.length);\n\t\t} else {\n\t\t\tif (url.startsWith('http://')) {\n\t\t\t\turl = url.slice(7);\n\t\t\t} else if (url.startsWith('https://')) {\n\t\t\t\turl = url.slice(8);\n\t\t\t}\n\t\t\tif (url.startsWith(document.location.host)) {\n\t\t\t\turl = url.slice(document.location.host.length);\n\t\t\t} else if (PS.server.id === 'showdown' && url.startsWith('play.pokemonshowdown.com')) {\n\t\t\t\turl = url.slice(24);\n\t\t\t} else if (PS.server.id === 'showdown' && url.startsWith('psim.us')) {\n\t\t\t\turl = url.slice(7);\n\t\t\t} else if (PS.server.id === 'showdown' && url.startsWith('swagpc.github.io')) {\n\t\t\t\turl = url.slice(16);\n\t\t\t} else if (url.startsWith('replay.pokemonshowdown.com')) {\n\t\t\t\turl = url.slice(26).replace('/', '/battle-');\n\t\t\t}\n\t\t}\n\t\tif (url.startsWith('/')) url = url.slice(1);\n\n\t\tif (!/^[a-z0-9-]*$/.test(url)) return null;\n\n\t\tconst redirects = /^(appeals?|rooms?suggestions?|suggestions?|adminrequests?|bugs?|bugreports?|rules?|faq|credits?|privacy|contact|dex|insecure)$/;\n\t\tif (redirects.test(url)) return null;\n\n\t\treturn url as RoomID;\n\t}\n\tsubscribeHash() {\n\t\tif (location.hash) {\n\t\t\tconst currentRoomid = location.hash.slice(1);\n\t\t\tif (/^[a-z0-9-]+$/.test(currentRoomid)) {\n\t\t\t\tPS.join(currentRoomid as RoomID);\n\t\t\t} else {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tPS.subscribeAndRun(() => {\n\t\t\tconst roomid = PS.room.id;\n\t\t\tlocation.hash = roomid ? '#' + roomid : '';\n\t\t});\n\t\twindow.addEventListener('hashchange', e => {\n\t\t\tconst possibleRoomid = location.hash.slice(1);\n\t\t\tlet currentRoomid: RoomID | null = null;\n\t\t\tif (/^[a-z0-9-]*$/.test(possibleRoomid)) {\n\t\t\t\tcurrentRoomid = possibleRoomid as RoomID;\n\t\t\t}\n\t\t\tif (currentRoomid !== null) {\n\t\t\t\tPS.join(currentRoomid);\n\t\t\t}\n\t\t});\n\t}\n\tsubscribeHistory() {\n\t\tconst currentRoomid = location.pathname.slice(1);\n\t\tif (/^[a-z0-9-]+$/.test(currentRoomid)) {\n\t\t\tPS.join(currentRoomid as RoomID);\n\t\t} else {\n\t\t\treturn;\n\t\t}\n\t\tif (!window.history) return;\n\t\tPS.subscribeAndRun(() => {\n\t\t\tconst room = PS.room;\n\t\t\tconst roomid = room.id;\n\t\t\tconst panelState = (PS.leftRoomWidth ?\n\t\t\t\tPS.leftRoom.id + '..' + PS.rightRoom!.id :\n\t\t\t\troomid);\n\t\t\tif (roomid === this.roomid && panelState === this.panelState) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (panelState === this.panelState) {\n\t\t\t\thistory.pushState(panelState, room.title, '/' + roomid);\n\t\t\t} else {\n\t\t\t\thistory.replaceState(panelState, room.title, '/' + roomid);\n\t\t\t}\n\t\t\tthis.roomid = roomid;\n\t\t\tthis.panelState = panelState;\n\t\t});\n\t\twindow.addEventListener('popstate', e => {\n\t\t\tconst possibleRoomid = location.pathname.slice(1);\n\t\t\tlet roomid: RoomID | null = null;\n\t\t\tif (/^[a-z0-9-]*$/.test(possibleRoomid)) {\n\t\t\t\troomid = possibleRoomid as RoomID;\n\t\t\t}\n\t\t\tif (typeof e.state === 'string') {\n\t\t\t\tconst [leftRoomid, rightRoomid] = e.state.split('..') as RoomID[];\n\t\t\t\tPS.join(leftRoomid, 'left');\n\t\t\t\tif (rightRoomid) {\n\t\t\t\t\tPS.join(rightRoomid, 'right');\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (roomid !== null) {\n\t\t\t\tPS.join(roomid);\n\t\t\t}\n\t\t});\n\t}\n}\nPS.router = new PSRouter();\n\nclass PSRoomPanel<T extends PSRoom = PSRoom> extends preact.Component<{room: T}> {\n\tsubscriptions: PSSubscription[] = [];\n\tcomponentDidMount() {\n\t\tif (PS.room === this.props.room) this.focus();\n\t\tthis.props.room.onParentEvent = (id: string, e?: Event) => {\n\t\t\tif (id === 'focus') this.focus();\n\t\t};\n\t\tthis.subscriptions.push(this.props.room.subscribe(args => {\n\t\t\tif (!args) this.forceUpdate();\n\t\t\telse this.receiveLine(args);\n\t\t}));\n\t\tif (this.base) {\n\t\t\tthis.props.room.setDimensions(this.base.offsetWidth, this.base.offsetHeight);\n\t\t}\n\t}\n\tcomponentDidUpdate() {\n\t\tif (this.base && ['popup', 'semimodal-popup'].includes(this.props.room.location)) {\n\t\t\tthis.props.room.setDimensions(this.base.offsetWidth, this.base.offsetHeight);\n\t\t}\n\t}\n\tcomponentWillUnmount() {\n\t\tthis.props.room.onParentEvent = null;\n\t\tfor (const subscription of this.subscriptions) {\n\t\t\tsubscription.unsubscribe();\n\t\t}\n\t\tthis.subscriptions = [];\n\t}\n\treceiveLine(args: Args) {}\n\t/**\n\t * PS has \"fake select menus\", buttons that act like <select> dropdowns.\n\t * This function is used by the popups they open to change the button\n\t * values.\n\t */\n\tchooseParentValue(value: string) {\n\t\tconst dropdownButton = this.props.room.parentElem as HTMLButtonElement;\n\t\tdropdownButton.value = value;\n\t\tconst changeEvent = new Event('change');\n\t\tdropdownButton.dispatchEvent(changeEvent);\n\t\tPS.closePopup();\n\t}\n\tfocus() {}\n\trender() {\n\t\treturn <PSPanelWrapper room={this.props.room}>\n\t\t\t<div class=\"mainmessage\"><p>Loading...</p></div>\n\t\t</PSPanelWrapper>;\n\t}\n}\n\nfunction PSPanelWrapper(props: {\n\troom: PSRoom, children: preact.ComponentChildren, scrollable?: boolean, width?: number | 'auto',\n}) {\n\tconst room = props.room;\n\tif (room.location === 'mini-window') {\n\t\tif (room.id === 'news') {\n\t\t\treturn <div>{props.children}</div>;\n\t\t}\n\t\treturn <div id={`room-${room.id}`} class=\"mini-window-contents ps-room-light\">{props.children}</div>;\n\t}\n\tif (room.location !== 'left' && room.location !== 'right') {\n\t\tconst style = PSMain.getPopupStyle(room, props.width);\n\t\treturn <div class=\"ps-popup\" id={`room-${room.id}`} style={style}>\n\t\t\t{props.children}\n\t\t</div>;\n\t}\n\tconst style = PSMain.posStyle(room);\n\treturn <div\n\t\tclass={'ps-room' + (room.id === '' ? '' : ' ps-room-light') + (props.scrollable ? ' scrollable' : '')}\n\t\tid={`room-${room.id}`}\n\t\tstyle={style}\n\t>\n\t\t{props.children}\n\t</div>;\n}\n\nclass PSMain extends preact.Component {\n\tconstructor() {\n\t\tsuper();\n\t\tPS.subscribe(() => this.forceUpdate());\n\n\t\twindow.addEventListener('click', e => {\n\t\t\tlet elem = e.target as HTMLElement | null;\n\t\t\tif (elem?.className === 'ps-overlay') {\n\t\t\t\tPS.closePopup();\n\t\t\t\te.preventDefault();\n\t\t\t\te.stopImmediatePropagation();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet clickedRoom = null;\n\t\t\twhile (elem) {\n\t\t\t\tif (` ${elem.className} `.includes(' username ')) {\n\t\t\t\t\tconst name = elem.getAttribute('data-name');\n\t\t\t\t\tconst userid = toID(name);\n\t\t\t\t\tconst roomid = `user-${userid}` as RoomID;\n\t\t\t\t\tPS.addRoom({\n\t\t\t\t\t\tid: roomid,\n\t\t\t\t\t\tparentElem: elem,\n\t\t\t\t\t\tparentRoomid: PSMain.containingRoomid(elem),\n\t\t\t\t\t\trightPopup: elem.className === 'userbutton username',\n\t\t\t\t\t\tusername: name,\n\t\t\t\t\t});\n\t\t\t\t\tPS.update();\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopImmediatePropagation();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (elem.tagName === 'A' || elem.getAttribute('data-href')) {\n\t\t\t\t\tconst href = elem.getAttribute('data-href') || (elem as HTMLAnchorElement).href;\n\t\t\t\t\tconst roomid = PS.router.extractRoomID(href);\n\n\t\t\t\t\tif (roomid !== null) {\n\t\t\t\t\t\tif (elem.getAttribute('data-target') === 'replace') {\n\t\t\t\t\t\t\tconst room = this.getRoom(elem);\n\t\t\t\t\t\t\tif (room) PS.leave(room.id);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tPS.addRoom({\n\t\t\t\t\t\t\tid: roomid,\n\t\t\t\t\t\t\tparentElem: elem,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tPS.update();\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\te.stopImmediatePropagation();\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (elem.tagName === 'BUTTON') {\n\t\t\t\t\tif (this.handleButtonClick(elem as HTMLButtonElement)) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\te.stopImmediatePropagation();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t} else if (!elem.getAttribute('type')) {\n\t\t\t\t\t\t// the spec says that buttons with no `type` attribute should be\n\t\t\t\t\t\t// submit buttons, but this is a bad default so we're going\n\t\t\t\t\t\t// to just assume they're not\n\n\t\t\t\t\t\t// don't return, to allow <a><button> to make links that look\n\t\t\t\t\t\t// like buttons\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// presumably a different part of the app is handling this button\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (elem.id.startsWith('room-')) {\n\t\t\t\t\tclickedRoom = PS.rooms[elem.id.slice(5)];\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\telem = elem.parentElement;\n\t\t\t}\n\t\t\tif (PS.room !== clickedRoom) {\n\t\t\t\tif (clickedRoom) PS.room = clickedRoom;\n\t\t\t\twhile (PS.popups.length && (!clickedRoom || clickedRoom.id !== PS.popups[PS.popups.length - 1])) {\n\t\t\t\t\tPS.closePopup();\n\t\t\t\t}\n\t\t\t\tPS.update();\n\t\t\t}\n\t\t});\n\n\t\twindow.addEventListener('keydown', e => {\n\t\t\tlet elem = e.target as HTMLInputElement | null;\n\t\t\tif (elem) {\n\t\t\t\tlet isTextInput = (elem.tagName === 'INPUT' || elem.tagName === 'TEXTAREA');\n\t\t\t\tif (isTextInput && ['button', 'radio', 'checkbox', 'file'].includes(elem.type)) {\n\t\t\t\t\tisTextInput = false;\n\t\t\t\t}\n\t\t\t\tif (isTextInput && elem.value) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (PS.room.onParentEvent) {\n\t\t\t\tif (PS.room.onParentEvent('keydown', e) === false) {\n\t\t\t\t\te.stopImmediatePropagation();\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tlet modifierKey = e.ctrlKey || e.altKey || e.metaKey || e.shiftKey;\n\t\t\tif (modifierKey) return;\n\t\t\tif (e.keyCode === 37) { // left\n\t\t\t\tPS.arrowKeysUsed = true;\n\t\t\t\tPS.focusLeftRoom();\n\t\t\t} else if (e.keyCode === 39) { // right\n\t\t\t\tPS.arrowKeysUsed = true;\n\t\t\t\tPS.focusRightRoom();\n\t\t\t}\n\t\t});\n\n\t\tconst colorSchemeQuery = window.matchMedia?.('(prefers-color-scheme: dark)');\n\t\tif (colorSchemeQuery?.media !== 'not all') {\n\t\t\tcolorSchemeQuery.addEventListener('change', function (cs) {\n\t\t\t\tif (PS.prefs.theme === 'system') document.body.className = cs.matches ? 'dark' : '';\n\t\t\t});\n\t\t}\n\n\t\tPS.prefs.subscribeAndRun(key => {\n\t\t\tif (!key || key === 'theme') {\n\t\t\t\tconst dark = PS.prefs.theme === 'dark' ||\n\t\t\t\t\t(PS.prefs.theme === 'system' && colorSchemeQuery && colorSchemeQuery.matches);\n\t\t\t\tdocument.body.className = dark ? 'dark' : '';\n\t\t\t}\n\t\t});\n\t}\n\tgetRoom(elem: HTMLElement) {\n\t\tlet curElem: HTMLElement | null = elem;\n\t\twhile (curElem) {\n\t\t\tif (curElem.id.startsWith('room-')) {\n\t\t\t\treturn PS.rooms[curElem.id.slice(5)];\n\t\t\t}\n\t\t\tcurElem = curElem.parentElement;\n\t\t}\n\t}\n\thandleButtonClick(elem: HTMLButtonElement) {\n\t\tswitch (elem.name) {\n\t\tcase 'closeRoom':\n\t\t\tPS.leave(elem.value as RoomID);\n\t\t\treturn true;\n\t\tcase 'joinRoom':\n\t\t\tPS.addRoom({\n\t\t\t\tid: elem.value as RoomID,\n\t\t\t\tparentElem: elem,\n\t\t\t});\n\t\t\tPS.update();\n\t\t\treturn true;\n\t\tcase 'send':\n\t\tcase 'cmd':\n\t\t\tconst room = this.getRoom(elem) || PS.mainmenu;\n\t\t\troom.send(elem.value, elem.name === 'send');\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\tstatic containingRoomid(elem: HTMLElement) {\n\t\tlet curElem: HTMLElement | null = elem;\n\t\twhile (curElem) {\n\t\t\tif (curElem.id.startsWith('room-')) {\n\t\t\t\treturn curElem.id.slice(5) as RoomID;\n\t\t\t}\n\t\t\tcurElem = curElem.parentElement;\n\t\t}\n\t\treturn null;\n\t}\n\tstatic isEmptyClick(e: MouseEvent) {\n\t\ttry {\n\t\t\tconst selection = window.getSelection()!;\n\t\t\tif (selection.type === 'Range') return false;\n\t\t} catch (err) {}\n\t\tBattleTooltips.hideTooltip();\n\t}\n\tstatic posStyle(room: PSRoom) {\n\t\tlet pos: PanelPosition | null = null;\n\t\tif (PS.leftRoomWidth === 0) {\n\t\t\t// one panel visible\n\t\t\tif (room === PS.activePanel) pos = {top: 56};\n\t\t} else {\n\t\t\t// both panels visible\n\t\t\tif (room === PS.leftRoom) pos = {top: 56, right: PS.leftRoomWidth};\n\t\t\tif (room === PS.rightRoom) pos = {top: 56, left: PS.leftRoomWidth};\n\t\t}\n\n\t\tif (!pos) return {display: 'none'};\n\n\t\tlet top: number | null = (pos.top || 0);\n\t\tlet height: number | null = null;\n\t\tlet bottom: number | null = (pos.bottom || 0);\n\t\tif (bottom > 0 || top < 0) {\n\t\t\theight = bottom - top;\n\t\t\tif (height < 0) throw new RangeError(\"Invalid pos range\");\n\t\t\tif (top < 0) top = null;\n\t\t\telse bottom = null;\n\t\t}\n\n\t\tlet left: number | null = (pos.left || 0);\n\t\tlet width: number | null = null;\n\t\tlet right: number | null = (pos.right || 0);\n\t\tif (right > 0 || left < 0) {\n\t\t\twidth = right - left - 1;\n\t\t\tif (width < 0) throw new RangeError(\"Invalid pos range\");\n\t\t\tif (left < 0) left = null;\n\t\t\telse right = null;\n\t\t}\n\n\t\treturn {\n\t\t\tdisplay: 'block',\n\t\t\ttop: top === null ? `auto` : `${top}px`,\n\t\t\theight: height === null ? `auto` : `${height}px`,\n\t\t\tbottom: bottom === null ? `auto` : `${-bottom}px`,\n\t\t\tleft: left === null ? `auto` : `${left}px`,\n\t\t\twidth: width === null ? `auto` : `${width}px`,\n\t\t\tright: right === null ? `auto` : `${-right}px`,\n\t\t};\n\t}\n\tstatic getPopupStyle(room: PSRoom, width?: number | 'auto'): any {\n\t\tif (room.location === 'modal-popup' || !room.parentElem) {\n\t\t\treturn {width: width || 480};\n\t\t}\n\t\tif (!room.width || !room.height) {\n\t\t\treturn {\n\t\t\t\tposition: 'absolute',\n\t\t\t\tvisibility: 'hidden',\n\t\t\t\tmargin: 0,\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t};\n\t\t}\n\t\t// nonmodal popup: should be positioned near source element\n\t\tlet style: any = {\n\t\t\tposition: 'absolute',\n\t\t\tmargin: 0,\n\t\t};\n\t\tlet offset = room.parentElem.getBoundingClientRect();\n\t\tlet sourceWidth = offset.width;\n\t\tlet sourceHeight = offset.height;\n\n\t\tlet availableHeight = document.documentElement.clientHeight;\n\t\tlet height = room.height;\n\t\twidth = width || room.width;\n\n\t\tif (room.rightPopup) {\n\n\t\t\tif (availableHeight > offset.top + height + 5 &&\n\t\t\t\t(offset.top < availableHeight * 2 / 3 || offset.top + 200 < availableHeight)) {\n\t\t\t\tstyle.top = offset.top;\n\t\t\t} else if (offset.top + sourceHeight >= height) {\n\t\t\t\tstyle.bottom = Math.max(availableHeight - offset.top - sourceHeight, 0);\n\t\t\t} else {\n\t\t\t\tstyle.top = Math.max(0, availableHeight - height);\n\t\t\t}\n\t\t\tlet offsetLeft = offset.left + sourceWidth;\n\t\t\tif (width !== 'auto' && offsetLeft + width > document.documentElement.clientWidth) {\n\t\t\t\tstyle.right = 1;\n\t\t\t} else {\n\t\t\t\tstyle.left = offsetLeft;\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tif (availableHeight > offset.top + sourceHeight + height + 5 &&\n\t\t\t\t(offset.top + sourceHeight < availableHeight * 2 / 3 || offset.top + sourceHeight + 200 < availableHeight)) {\n\t\t\t\tstyle.top = offset.top + sourceHeight;\n\t\t\t} else if (height + 5 <= offset.top) {\n\t\t\t\tstyle.bottom = Math.max(availableHeight - offset.top, 0);\n\t\t\t} else if (height + 10 < availableHeight) {\n\t\t\t\tstyle.bottom = 5;\n\t\t\t} else {\n\t\t\t\tstyle.top = 0;\n\t\t\t}\n\n\t\t\tlet availableWidth = document.documentElement.clientWidth - offset.left;\n\t\t\tif (width !== 'auto' && availableWidth < width + 10) {\n\t\t\t\tstyle.right = 10;\n\t\t\t} else {\n\t\t\t\tstyle.left = offset.left;\n\t\t\t}\n\n\t\t}\n\n\t\tif (width) style.maxWidth = width;\n\n\t\treturn style;\n\t}\n\trenderRoom(room: PSRoom) {\n\t\tconst roomType = PS.roomTypes[room.type];\n\t\tconst Panel = roomType ? roomType.Component : PSRoomPanel;\n\t\treturn <Panel key={room.id} room={room} />;\n\t}\n\trenderPopup(room: PSRoom) {\n\t\tconst roomType = PS.roomTypes[room.type];\n\t\tconst Panel = roomType ? roomType.Component : PSRoomPanel;\n\t\tif (room.location === 'popup' && room.parentElem) {\n\t\t\treturn <Panel key={room.id} room={room} />;\n\t\t}\n\t\treturn <div key={room.id} class=\"ps-overlay\">\n\t\t\t<Panel room={room} />\n\t\t</div>;\n\t}\n\trender() {\n\t\tlet rooms = [] as preact.VNode[];\n\t\tfor (const roomid in PS.rooms) {\n\t\t\tconst room = PS.rooms[roomid]!;\n\t\t\tif (room.location === 'left' || room.location === 'right') {\n\t\t\t\trooms.push(this.renderRoom(room));\n\t\t\t}\n\t\t}\n\t\treturn <div class=\"ps-frame\">\n\t\t\t<PSHeader style={{top: 0, left: 0, right: 0, height: '50px'}} />\n\t\t\t{rooms}\n\t\t\t{PS.popups.map(roomid => this.renderPopup(PS.rooms[roomid]!))}\n\t\t</div>;\n\t}\n}\n\ntype PanelPosition = {top?: number, bottom?: number, left?: number, right?: number} | null;\n\nfunction SanitizedHTML(props: {children: string}) {\n\treturn <div dangerouslySetInnerHTML={{__html: BattleLog.sanitizeHTML(props.children)}}/>;\n}\n"],"file":"panels.js"}