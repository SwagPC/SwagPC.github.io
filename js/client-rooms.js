!(function(s){this.RoomsRoom=Room.extend({minWidth:320,maxWidth:1024,type:"rooms",title:"Rooms",events:{"change select[name=sections]":"refresh"},isSideRoom:!0,initialize:function(){this.focusedSection="",this.$el.addClass("ps-room-light").addClass("scrollable");var t='<div class="pad"><button class="button" style="float:right;font-size:10pt;margin-top:3px" name="closeHide"><i class="fa fa-caret-right"></i> Hide</button>',t=((t+='<div class="roomlisttop"></div><p>Rooms filter: <select name="sections"><option value="all">(All rooms)</option></select></p>')+'<div class="roomlist"><p><em style="font-size:20pt">Loading...</em></p></div><div class="roomlist"></div>'+'<p><button name="joinRoomPopup" class="button">Join other room</button></p></div>',this.$el.html('<div class="pad"><button class="button" style="float:right;font-size:10pt;margin-top:3px" name="closeHide"><i class="fa fa-caret-right"></i> Hide</button><div class="roomlisttop"></div><p>Rooms filter: <select name="sections"><option value="all">(All rooms)</option></select></p><div class="roomlist"><p><em style="font-size:20pt">Loading...</em></p></div><div class="roomlist"></div><p><button name="joinRoomPopup" class="button">Join other room</button></p></div>'),app.on("response:rooms",this.update,this),Dex.prefs("serversettings"));t&&app.send("/updatesettings "+JSON.stringify(t)),app.send("/cmd rooms"),app.user.on("change:named",this.updateUser,this),this.update()},initSectionSelection:function(){var t=['<option value="">(All rooms)</option>'],o=app.roomsData.sectionTitles;if(o){for(var s=0;s<o.length;s++){var e=BattleLog.escapeHTML(o[s]);t.push('<option value="'+e+'">'+e+"</option>")}this.$("select[name=sections]").html(t.join(""))}else this.$("select[name=sections]").parent().hide()},updateUser:function(){this.update()},focus:function(){6e4<(new Date).getTime()-this.lastUpdate&&(app.send("/cmd rooms"),this.lastUpdate=(new Date).getTime());var t=this.$el.scrollTop();this.$("select:focus").length||this.$("button[name=joinRoomPopup]").focus(),this.$el.scrollTop(t)},joinRoomPopup:function(){app.addPopupPrompt("Room name:","Join room",function(t){var o=(Config.routes.client+"/").length;(t="psim.us/"===(t=(t="https://"===(t="http://"===t.substr(0,7)?t.slice(7):t).substr(0,8)?t.slice(8):t).substr(0,o)===Config.routes.client+"/"?t.slice(o):t).substr(0,8)?t.slice(8):t).substr(0,document.location.hostname.length+1)===document.location.hostname+"/"&&(t=t.slice(document.location.hostname.length+1)),(t=toRoomid(t))&&app.tryJoinRoom(t)})},update:function(t){t&&(this.lastUpdate=(new Date).getTime(),app.roomsData=t),app.roomsData&&(this.initSectionSelection(),this.updateRoomList(),app.roomsFirstOpen||"demo.psim.us"===window.location.host||(Config.roomsFirstOpenScript&&Config.roomsFirstOpenScript(),app.roomsFirstOpen=2))},renderRoomBtn:function(t){var o=toID(t.title),s='<div><a href="'+app.root+o+'" class="ilink"><small style="float:right">('+Number(t.userCount)+' users)</small><strong><i class="fa fa-comment-o"></i> '+BattleLog.escapeHTML(t.title)+"<br /></strong><small>"+BattleLog.escapeHTML(t.desc||"")+"</small></a>";if(t.subRooms&&t.subRooms.length){s+='<div class="subrooms"><i class="fa fa-level-up fa-rotate-90"></i> Subrooms:';for(var e=0;e<t.subRooms.length;e++)s+=' <a class="ilink" href="'+app.root+toID(t.subRooms[e])+'"><i class="fa fa-comment-o"></i> <strong>'+BattleLog.escapeHTML(t.subRooms[e])+"</strong></a>";s+="</div>"}return s+="</div>"},compareRooms:function(t,o){return o.userCount-t.userCount},updateRoomList:function(){var t,o,s=app.roomsData;if(s.userCount&&(t='<button class="button" name="finduser" title="Find an online user"><span class="pixelated usercount" title="Quagsire is SPC\'s mascot! Quagsire is about being derpy, and represents our inactive PS chatrooms (Use our Discord instead)!" ></span><strong>'+(t=Number(s.userCount))+"</strong> "+(1==t?"user":"users")+" online</button> ",o='<button class="button" name="roomlist" title="Watch an active battle"><span class="pixelated battlecount" title="Sceptile is not SPC\'s mascot! Sceptile is cool, and represents our battles."></span><strong>'+(o=Number(s.battleCount))+"</strong> active "+(1==o?"battle":"battles")+"</button>",this.$(".roomlisttop").html('<div class="roomcounters">'+t+"</td><td>"+o+"</div>")),s.pspl){for(var e=0;e<s.pspl.length;e++)s.pspl[e].spotlight="Spotlight rooms";s.chat=s.pspl.concat(s.chat),s.pspl=null}if(s.official){for(e=0;e<s.official.length;e++)s.official[e].section="Official";s.chat=s.official.concat(s.chat),s.official=null}for(var i,a=s.chat,n=(this.focusedSection&&(i=this.focusedSection,a=a.filter(function(t){return(t.section||"Other")===i})),""),l=[],r=[],p=[],e=0;e<a.length;e++){var c=a[e];c.spotlight?(l.push(c),n=c.spotlight):("Official"===c.section?r:p).push(c)}this.$(".roomlist").first().html((r.length?'<h2 class="rooms-officialchatrooms">Official chat rooms</h2>'+r.sort(this.compareRooms).map(this.renderRoomBtn).join(""):"")+(l.length?'<h2 class="rooms-psplchatrooms">'+BattleLog.escapeHTML(n)+"</h2>"+l.sort(this.compareRooms).map(this.renderRoomBtn).join(""):"")),this.$(".roomlist").last().html(p.length?'<h2 class="rooms-chatrooms">Chat rooms</h2>'+p.sort(this.compareRooms).map(this.renderRoomBtn).join(""):"")},roomlist:function(){app.joinRoom("battles")},closeHide:function(){app.sideRoom=app.curSideRoom=null,this.close()},finduser:function(){app.isDisconnected?app.addPopupMessage("You are offline."):app.addPopupPrompt("Username","Open",function(t){t&&("zarel"===toID(t)?app.addPopup(Popup,{htmlMessage:"Zarel is very busy; please don't contact him this way. If you're looking for help, try <a href=\"/help\">joining the Help room</a>?"}):app.addPopup(UserPopup,{name:t}))})},refresh:function(){var t=this.$("select[name=sections]").val();this.focusedSection=t,this.updateRoomList()}}),this.BattlesRoom=Room.extend({minWidth:320,maxWidth:1024,type:"battles",title:"Battles",isSideRoom:!0,events:{"change select[name=elofilter]":"refresh","submit .search":"submitSearch"},initialize:function(){this.$el.addClass("ps-room-light").addClass("scrollable");var t=(t=(t='<div class="pad"><button class="button" style="float:right;font-size:10pt;margin-top:3px" name="close"><i class="fa fa-times"></i> Close</button><div class="roomlist"><p><button class="button" name="refresh"><i class="fa fa-refresh"></i> Refresh</button> <span style="'+Dex.getPokemonIcon("sceptile")+';display:inline-block;vertical-align:middle" class="picon" title="Sceptile is not SPC\'s mascot! Sceptile is cool, and represents our battles."></span></p>')+'<p><label class="label">Format:</label><button class="select formatselect" name="selectFormat">(All formats)</button></p>'+'<label>Minimum Elo: <select name="elofilter"><option value="none">None</option><option value="1100">1100</option><option value="1300">1300</option><option value="1500">1500</option><option value="1700">1700</option><option value="1900">1900</option></select></label>')+('<p><form class="search"><input type="text" name="prefixsearch" class="textbox" value="'+BattleLog.escapeHTML(this.usernamePrefix)+'" placeholder="username prefix"/><button type="submit" class="button">Search</button></form></p>');this.$el.html(t=t+'<div class="list"><p>Loading...</p></div>'+"</div></div>"),this.$list=this.$(".list"),this.$refreshButton=this.$("button[name=refresh]"),this.format="",app.on("response:roomlist",this.update,this),app.send("/cmd roomlist"),this.update()},selectFormat:function(t,o){var s;window.BattleFormats&&(s=this,app.addPopup(FormatPopup,{format:t,sourceEl:o,selectType:"watch",onselect:function(t){s.changeFormat(t)}}))},changeFormat:function(t){this.format=t,this.data=null,this.update(),this.refresh()},focus:function(t){var o;t&&s(t.target).is("input")||t&&s(t.target).closest("select, a").length||(6e4<(new Date).getTime()-this.lastUpdate&&this.refresh(),o=this.$el.scrollTop(),this.$("button[name=refresh]").focus(),this.$el.scrollTop(o))},rejoin:function(){this.refresh()},renderRoomBtn:function(t,o,s){var e=s[1]||"",i="",e=(o.minElo&&(i+='<small style="float:right">('+("number"==typeof o.minElo?"rated: ":"")+BattleLog.escapeHTML(""+o.minElo)+")</small>"),(i+=e?"<small>["+BattleLog.escapeFormat(e)+"]</small><br />":"")+'<em class="p1">'+BattleLog.escapeHTML(o.p1)+'</em> <small class="vs">vs.</small> <em class="p2">'+BattleLog.escapeHTML(o.p2)+"</em>");return o.p1?o.p2||(e=i+'<em class="p1">'+BattleLog.escapeHTML(o.p1)+"</em>"):e=i+"empty room "+(s=t.match(/[^0-9]([0-9]*)$/))[1],'<div><a href="'+app.root+t+'" class="ilink">'+e+"</a></div>"},submitSearch:function(t){t.preventDefault(),this.refresh()},update:function(t){if(t||this.data){this.$("button[name=refresh]")[0].disabled=!1,t&&(this.data=t);var o,s=this.data.rooms,e=[];for(o in s){var i=s[o],a=ChatRoom.parseBattleID(o);!a||this.format&&a[1]!==this.format||e.push(this.renderRoomBtn(o,i,a))}return e.length?this.$list.html("<p>"+e.length+(100===e.length?"+":"")+" "+BattleLog.escapeFormat(this.format)+" "+(1===e.length?"battle":"battles")+"</p>"+e.join("")):this.$list.html("<p>No "+BattleLog.escapeFormat(this.format)+" battles are going on right now.</p>")}app.isDisconnected?this.$list.html("<p>You are offline.</p>"):this.$list.html("<p>Loading...</p>")},refresh:function(){var t=this.$("input[name=prefixsearch]").val(),o=this.$("select[name=elofilter]").val(),o=[this.format,o,toID(t)];app.send("/cmd roomlist "+o.join(",")),this.lastUpdate=(new Date).getTime(),this.$refreshButton[0].disabled=!0}})}).call(this,jQuery);
