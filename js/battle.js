var Pokemon=function(){function a(e,t){this.name="",this.speciesForme="",this.ident="",this.details="",this.searchid="",this.side=void 0,this.slot=0,this.fainted=!1,this.hp=0,this.maxhp=1e3,this.level=100,this.gender="N",this.shiny=!1,this.hpcolor="g",this.moves=[],this.ability="",this.baseAbility="",this.item="",this.itemEffect="",this.prevItem="",this.prevItemEffect="",this.boosts={},this.status="",this.statusStage=0,this.volatiles={},this.turnstatuses={},this.movestatuses={},this.lastMove="",this.moveTrack=[],this.statusData={sleepTurns:0,toxicTurns:0},this.sprite=void 0,this.side=t,this.speciesForme=e.speciesForme,this.details=e.details,this.name=e.name,this.level=e.level,this.shiny=e.shiny,this.gender=e.gender||"N",this.ident=e.ident,this.searchid=e.searchid,this.sprite=t.battle.scene.addPokemonSprite(this)}var e=a.prototype;return e.isActive=function(){return this.side.active.includes(this)},e.getHPColor=function(){var e;return this.hpcolor||(.5<(e=this.hp/this.maxhp)?"g":.2<e?"y":"r")},e.getHPColorClass=function(){switch(this.getHPColor()){case"y":return"hpbar hpbar-yellow";case"r":return"hpbar hpbar-red"}return"hpbar"},a.getPixelRange=function(e,t){var s=.5/714;return 0===e?[0,0]:1===e?[0+s,2/48-s]:9===e?"y"===t?[.2+s,10/48-s]:[9/48,.2]:24===e?"g"===t?[.5+s,25/48-s]:[.5,.5]:48===e?[1,1]:[e/48,(e+1)/48-s]},a.getFormattedRange=function(e,t,s){var i,a;return e[0]===e[1]?(a=Math.abs(100*e[0]),Math.floor(a)===a?a+"%":a.toFixed(t)+"%"):(a=0===t?(i=Math.floor(100*e[0]),Math.ceil(100*e[1])):(i=(100*e[0]).toFixed(t),(100*e[1]).toFixed(t)),""+i+s+a+"%")},e.getDamageRange=function(e){var t,s,i;return 48!==e[1]?[s=e[0]/e[1],s]:void 0===e.length?[e[2]/100,e[2]/100]:(s=a.getPixelRange(e[3],e[4]),i=a.getPixelRange(e[3]+e[0],this.hpcolor),0===e[0]?[0,i[1]-i[0]]:(s[0]<i[0]&&(t=s,s=i,i=t),[s[0]-i[1],s[1]-i[0]]))},e.healthParse=function(e,t,s){if(!e||!e.length)return null;var i=e.lastIndexOf("(");if(0<=i){if(t)return a=parseFloat(e),isNaN(a)&&(a=50),s?(this.hp+=this.maxhp*a/100,this.hp>this.maxhp&&(this.hp=this.maxhp)):this.hp-=this.maxhp*a/100,(n=this.healthParse(e))&&100===n[1]?[a,100,a]:(n=Math.round(Math.ceil(48*a/100)/48*100),[Math.ceil(48*a/100),48,n]);if(")"!==e.substr(e.length-1))return null;e=e.substr(i+1,e.length-i-2)}var a=this.fainted?0:this.hp||1,n=this.maxhp,i=this.hpWidth(100),r=this.hpcolor,a=(this.side.battle.parseHealth(e,this),0===n&&(n=a=this.maxhp),a?Math.floor(this.maxhp*a/n)||1:0),n=this.hp-a,i=this.hpWidth(100)-i;return[n,this.maxhp,i,a,r]},e.checkDetails=function(e){return!!e&&(e===this.details||!this.searchid&&(!!(0<=e.indexOf(", shiny")&&this.checkDetails(e.replace(", shiny","")))||(e=e.replace(/(-[A-Za-z0-9-]+)?(, |$)/,"-*$2"))===this.details))},e.getIdent=function(){return this.ident.substr(0,2)+["a","b","c","d","e","f"][this.slot]+this.ident.substr(2)},e.removeVolatile=function(e){this.side.battle.scene.removeEffect(this,e),this.hasVolatile(e)&&delete this.volatiles[e]},e.addVolatile=function(e){for(var t=arguments.length,s=new Array(1<t?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];this.hasVolatile(e)&&!s.length||(this.volatiles[e]=[e].concat(s),this.side.battle.scene.addEffect(this,e))},e.hasVolatile=function(e){return!!this.volatiles[e]},e.removeTurnstatus=function(e){this.side.battle.scene.removeEffect(this,e),this.hasTurnstatus(e)&&delete this.turnstatuses[e]},e.addTurnstatus=function(e){e=toID(e),this.side.battle.scene.addEffect(this,e),this.hasTurnstatus(e)||(this.turnstatuses[e]=[e])},e.hasTurnstatus=function(e){return!!this.turnstatuses[e]},e.clearTurnstatuses=function(){for(var e in this.turnstatuses)this.removeTurnstatus(e);this.turnstatuses={},this.side.battle.scene.updateStatbar(this)},e.removeMovestatus=function(e){this.side.battle.scene.removeEffect(this,e),this.hasMovestatus(e)&&delete this.movestatuses[e]},e.addMovestatus=function(e){e=toID(e),this.hasMovestatus(e)||(this.movestatuses[e]=[e],this.side.battle.scene.addEffect(this,e))},e.hasMovestatus=function(e){return!!this.movestatuses[e]},e.clearMovestatuses=function(){for(var e in this.movestatuses)this.removeMovestatus(e);this.movestatuses={}},e.clearVolatiles=function(){this.volatiles={},this.clearTurnstatuses(),this.clearMovestatuses(),this.side.battle.scene.clearEffects(this)},e.rememberMove=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,s=2<arguments.length?arguments[2]:void 0;if(s!==this.ident&&"*"!==(e=Dex.moves.get(e).name).charAt(0)&&"Struggle"!==e){this.volatiles.transform&&(s=s||this.ident,this.volatiles.transform[1].rememberMove(e,0,s),e="*"+e);for(var i=0,a=this.moveTrack;i<a.length;i++){var n=a[i];if(e===n[0])return n[1]+=t,void(n[1]<0&&(n[1]=0))}this.moveTrack.push([e,t])}},e.rememberAbility=function(e,t){e=Dex.abilities.get(e).name,this.ability=e,this.baseAbility||t||(this.baseAbility=e)},e.getBoost=function(e){var t={atk:"Atk",def:"Def",spa:"SpA",spd:"SpD",spe:"Spe",accuracy:"Accuracy",evasion:"Evasion",spc:"Spc"};return this.boosts[e]?(6<this.boosts[e]&&(this.boosts[e]=6),this.boosts[e]<-6&&(this.boosts[e]=-6),this.side.battle.gen<=1&&!this.side.battle.tier.includes("Stadium")||"accuracy"!==e&&"evasion"!==e?0<this.boosts[e]?["1&times;","1.5&times;","2&times;","2.5&times;","3&times;","3.5&times;","4&times;"][this.boosts[e]]+"&nbsp;"+t[e]:["1&times;","0.67&times;","0.5&times;","0.4&times;","0.33&times;","0.29&times;","0.25&times;"][-this.boosts[e]]+"&nbsp;"+t[e]:0<this.boosts[e]?["1&times;","1.33&times;","1.67&times;","2&times;","2.33&times;","2.67&times;","3&times;"][this.boosts[e]]+"&nbsp;"+t[e]:["1&times;","0.75&times;","0.6&times;","0.5&times;","0.43&times;","0.38&times;","0.33&times;"][-this.boosts[e]]+"&nbsp;"+t[e]):"1&times;&nbsp;"+t[e]},e.getWeightKg=function(e){var t=100*(null==(t=this.volatiles.autotomize)?void 0:t[1])||0;return Math.max(this.getSpecies(e).weightkg-t,.1)},e.getBoostType=function(e){return this.boosts[e]?0<this.boosts[e]?"good":"bad":"neutral"},e.clearVolatile=function(){this.ability=this.baseAbility,this.boosts={},this.clearVolatiles();for(var e=0;e<this.moveTrack.length;e++)"*"===this.moveTrack[e][0].charAt(0)&&(this.moveTrack.splice(e,1),e--);this.statusStage=0,this.statusData.toxicTurns=0,5===this.side.battle.gen&&(this.statusData.sleepTurns=0)},e.copyVolatileFrom=function(e,t){this.boosts=e.boosts,this.volatiles=e.volatiles,t||(delete this.volatiles.airballoon,delete this.volatiles.attract,delete this.volatiles.autotomize,delete this.volatiles.disable,delete this.volatiles.encore,delete this.volatiles.foresight,delete this.volatiles.gmaxchistrike,delete this.volatiles.imprison,delete this.volatiles.laserfocus,delete this.volatiles.mimic,delete this.volatiles.miracleeye,delete this.volatiles.nightmare,delete this.volatiles.smackdown,delete this.volatiles.stockpile1,delete this.volatiles.stockpile2,delete this.volatiles.stockpile3,delete this.volatiles.torment,delete this.volatiles.typeadd,delete this.volatiles.typechange,delete this.volatiles.yawn),delete this.volatiles.transform,delete this.volatiles.formechange,e.boosts={},e.volatiles={},e.side.battle.scene.removeTransform(e),e.statusStage=0},e.copyTypesFrom=function(e){var t=e.getTypes(),s=t[0],t=t[1];this.addVolatile("typechange",s.join("/")),t?this.addVolatile("typeadd",t):this.removeVolatile("typeadd")},e.getTypes=function(e){var t=this.volatiles.typechange?this.volatiles.typechange[1].split("/"):this.getSpecies(e).types;return this.hasTurnstatus("roost")&&t.includes("Flying")&&((t=t.filter(function(e){return"Flying"!==e})).length||(t=["Normal"])),[t,this.volatiles.typeadd?this.volatiles.typeadd[1]:""]},e.isGrounded=function(e){var t,s,i=this.side.battle;return!!i.hasPseudoWeather("Gravity")||(!!(this.volatiles.ingrain&&4<=i.gen)||(!!this.volatiles.smackdown||(t=toID((e||this).item),s=toID(this.effectiveAbility(e)),"ironball"===(t=i.hasPseudoWeather("Magic Room")||this.volatiles.embargo||"klutz"===s?"":t)||"levitate"!==s&&(!this.volatiles.magnetrise&&!this.volatiles.telekinesis&&("airballoon"!==t&&!this.getTypeList(e).includes("Flying"))))))},e.effectiveAbility=function(e){var t;return this.fainted||this.volatiles.gastroacid||(t=this.side.battle.dex.abilities.get((null==e?void 0:e.ability)||this.ability||(null==e?void 0:e.baseAbility)||""),this.side.battle.ngasActive()&&!t.isPermanent)?"":t.name},e.getTypeList=function(e){var t=this.getTypes(e),s=t[0],t=t[1];return t?s.concat(t):s},e.getSpeciesForme=function(e){return this.volatiles.formechange?this.volatiles.formechange[1]:(e||this).speciesForme},e.getSpecies=function(e){return this.side.battle.dex.species.get(this.getSpeciesForme(e))},e.getBaseSpecies=function(){return this.side.battle.dex.species.get(this.speciesForme)},e.reset=function(){this.clearVolatile(),this.hp=this.maxhp,this.fainted=!1,this.status="",this.moveTrack=[],this.name=this.name||this.speciesForme},e.hpWidth=function(e){var t;return this.fainted||!this.hp?0:1===this.hp&&45<this.maxhp?1:48===this.maxhp?(t=((t=a.getPixelRange(this.hp,this.hpcolor))[0]+t[1])/2,Math.round(e*t)||1):(t=100===(t=Math.ceil(100*this.hp/this.maxhp))&&this.hp<this.maxhp?99:t)*e/100},e.getHPText=function(){return a.getHPText(this,0<arguments.length&&void 0!==arguments[0]?arguments[0]:1)},a.getHPText=function(e){var t,s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;return 100===e.maxhp?e.hp+"%":48!==e.maxhp?(100*e.hp/e.maxhp).toFixed(s)+"%":(t=a.getPixelRange(e.hp,e.hpcolor),a.getFormattedRange(t,s,"–"))},e.destroy=function(){this.sprite&&this.sprite.destroy(),this.sprite=null,this.side=null},a}(),Side=function(){function e(e,t){this.battle=void 0,this.name="",this.id="",this.sideid=void 0,this.n=void 0,this.isFar=void 0,this.foe=null,this.ally=null,this.avatar="unknown",this.rating="",this.totalPokemon=6,this.x=0,this.y=0,this.z=0,this.missedPokemon=null,this.wisher=null,this.active=[null],this.lastPokemon=null,this.pokemon=[],this.sideConditions={},this.battle=e,this.n=t,this.sideid=["p1","p2","p3","p4"][t],this.isFar=!!(t%2)}var t=e.prototype;return t.rollTrainerSprites=function(){var e=["lucas","dawn","ethan","lyra","hilbert","hilda"];this.avatar=e[Math.floor(Math.random()*e.length)]},t.behindx=function(e){return this.x+(this.isFar?1:-1)*e},t.behindy=function(e){return this.y+(this.isFar?-1:1)*e},t.leftof=function(e){return(this.isFar?1:-1)*e},t.behind=function(e){return this.z+(this.isFar?1:-1)*e},t.clearPokemon=function(){for(var e=0,t=this.pokemon;e<t.length;e++)t[e].destroy();this.pokemon=[];for(var s=0;s<this.active.length;s++)this.active[s]=null;this.lastPokemon=null},t.reset=function(){this.clearPokemon(),this.sideConditions={}},t.setAvatar=function(e){this.avatar=e},t.setName=function(e,t){e&&(this.name=e),this.id=toID(this.name),t?this.setAvatar(t):(this.rollTrainerSprites(),this.foe&&this.avatar===this.foe.avatar&&this.rollTrainerSprites())},t.addSideCondition=function(e){var t=e.id;if(this.sideConditions[t])"spikes"!==t&&"toxicspikes"!==t||this.sideConditions[t][1]++;else switch(t){case"auroraveil":this.sideConditions[t]=[e.name,1,5,8];break;case"reflect":this.sideConditions[t]=[e.name,1,5,4<=this.battle.gen?8:0];break;case"safeguard":this.sideConditions[t]=[e.name,1,5,0];break;case"lightscreen":this.sideConditions[t]=[e.name,1,5,4<=this.battle.gen?8:0];break;case"mist":this.sideConditions[t]=[e.name,1,5,0];break;case"tailwind":this.sideConditions[t]=[e.name,1,5<=this.battle.gen?4:3,0];break;case"luckychant":this.sideConditions[t]=[e.name,1,5,0];break;case"stealthrock":case"spikes":case"toxicspikes":case"stickyweb":this.sideConditions[t]=[e.name,1,0,0];break;case"gmaxwildfire":case"gmaxvolcalith":case"gmaxvinelash":case"gmaxcannonade":this.sideConditions[t]=[e.name,1,4,0];break;case"grasspledge":this.sideConditions[t]=["Swamp",1,4,0];break;case"waterpledge":this.sideConditions[t]=["Rainbow",1,4,0];break;case"firepledge":this.sideConditions[t]=["Sea of Fire",1,4,0];break;default:this.sideConditions[t]=[e.name,1,0,0]}this.battle.scene.addSideCondition(this.n,t)},t.removeSideCondition=function(e){var t=toID(e);this.sideConditions[t]&&(delete this.sideConditions[t],this.battle.scene.removeSideCondition(this.n,t))},t.addPokemon=function(e,t,s){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:-1,a=0<=i?this.pokemon[i].item:void 0,n=this.battle.parseDetails(e,t,s),r=new Pokemon(n,this);if(a&&(r.item=a),!r.ability&&r.baseAbility&&(r.ability=r.baseAbility),r.reset(),0<=i?this.pokemon[i]=r:this.pokemon.push(r),this.pokemon.length>this.totalPokemon||this.battle.speciesClause){for(var o={},h=-1,l=0;l<this.pokemon.length;l++){var c=this.pokemon[l];if(c.searchid){if(c.searchid in o){var d=o[c.searchid],u=this.pokemon[d],h=r===c||r!==u&&(0<=this.active.indexOf(c)||!(0<=this.active.indexOf(u))&&c.fainted&&!u.fainted)?d:l;break}o[c.searchid]=l}}if(0<=h){if(this.pokemon[h].fainted){for(var m=null,p=0,f=this.pokemon;p<f.length;p++){var b=f[p];if(b!==r&&(!b.fainted&&!(0<=this.active.indexOf(b)||"Zoroark"!==b.speciesForme&&"Zorua"!==b.speciesForme&&"Illusion"!==b.ability))){m=b;break}}if(!m)for(var g=0,v=this.pokemon;g<v.length;g++){var k=v[g];if(k!==r&&!(k.fainted||0<=this.active.indexOf(k))){m=k;break}}m&&(m.fainted=!0,m.hp=0,m.status="")}this.pokemon.splice(h,1)}}return this.battle.scene.updateSidebar(this),r},t.switchIn=function(e,t){var s;void 0===t&&(t=e.slot),(this.active[t]=e).slot=t,e.clearVolatile(),e.lastMove="",this.battle.lastMove="switch-in",["batonpass","zbatonpass"].includes(null==(s=this.lastPokemon)?void 0:s.lastMove)&&e.copyVolatileFrom(this.lastPokemon),this.battle.scene.animSummon(e,t)},t.dragIn=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:e.slot,s=this.active[t];s!==e&&((this.lastPokemon=s)&&(this.battle.scene.animDragOut(s),s.clearVolatile()),e.clearVolatile(),e.lastMove="",this.battle.lastMove="switch-in",(this.active[t]=e).slot=t,this.battle.scene.animDragIn(e,t))},t.replace=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:e.slot,s=this.active[t];e!==s&&(this.lastPokemon=s,e.clearVolatile(),s&&(e.lastMove=s.lastMove,e.hp=s.hp,e.maxhp=s.maxhp,e.hpcolor=s.hpcolor,e.status=s.status,e.copyVolatileFrom(s,!0),e.statusData=Object.assign({},s.statusData),s.fainted=!1,s.hp=s.maxhp,s.status="???"),(this.active[t]=e).slot=t,s&&this.battle.scene.animUnsummon(s,!0),this.battle.scene.animSummon(e,t,!0))},t.switchOut=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:e.slot;"batonpass"!==e.lastMove&&"zbatonpass"!==e.lastMove?e.clearVolatile():(e.removeVolatile("transform"),e.removeVolatile("formechange")),"uturn"===e.lastMove||"voltswitch"===e.lastMove?this.battle.log(["switchout",e.ident],{from:e.lastMove}):"batonpass"!==e.lastMove&&"zbatonpass"!==e.lastMove&&this.battle.log(["switchout",e.ident]),e.statusData.toxicTurns=0,5===this.battle.gen&&(e.statusData.sleepTurns=0),this.lastPokemon=e,this.active[t]=null,this.battle.scene.animUnsummon(e)},t.swapTo=function(e,t,s){var i,a;e.slot!==t&&(i=this.active[t],a=e.slot,e.slot=t,i&&(i.slot=a),this.active[t]=e,this.active[a]=i,this.battle.scene.animUnsummon(e,!0),i&&this.battle.scene.animUnsummon(i,!0),this.battle.scene.animSummon(e,t,!0),i&&this.battle.scene.animSummon(i,a,!0))},t.swapWith=function(e,t,s){var i,a;e!==t&&(i=e.slot,a=t.slot,e.slot=a,t.slot=i,this.active[a]=e,this.active[i]=t,this.battle.scene.animUnsummon(e,!0),this.battle.scene.animUnsummon(t,!0),this.battle.scene.animSummon(e,a,!0),this.battle.scene.animSummon(t,i,!0))},t.faint=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:e.slot;e.clearVolatile(),this.lastPokemon=e,this.active[t]=null,e.fainted=!0,e.hp=0,this.battle.scene.animFaint(e)},t.destroy=function(){this.clearPokemon(),this.battle=null,this.foe=null},e}(),Battle=function(){function e(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(this.scene=void 0,this.sidesSwitched=!1,this.stepQueue=void 0,this.preemptStepQueue=[],this.waitForAnimations=!0,this.currentStep=0,this.seeking=null,this.activeMoveIsSpread=null,this.subscription=void 0,this.mute=!1,this.messageFadeTime=300,this.messageShownTime=1,this.turnsSinceMoved=0,this.turn=-1,this.atQueueEnd=!1,this.started=!1,this.ended=!1,this.isReplay=!1,this.usesUpkeep=!1,this.weather="",this.pseudoWeather=[],this.weatherTimeLeft=0,this.weatherMinTimeLeft=0,this.mySide=null,this.nearSide=null,this.farSide=null,this.p1=null,this.p2=null,this.p3=null,this.p4=null,this.pokemonControlled=0,this.sides=null,this.myPokemon=null,this.myAllyPokemon=null,this.lastMove="",this.gen=8,this.dex=Dex,this.teamPreviewCount=0,this.speciesClause=!1,this.tier="",this.gameType="singles",this.rated=!1,this.isBlitz=!1,this.endLastTurnPending=!1,this.totalTimeLeft=0,this.graceTimeLeft=0,this.kickingInactive=!1,this.id="",this.roomid="",this.hardcoreMode=!1,this.ignoreNicks=!!Dex.prefs("ignorenicks"),this.ignoreOpponent=!!Dex.prefs("ignoreopp"),this.ignoreSpects=!!Dex.prefs("ignorespects"),this.debug=void 0,this.joinButtons=!1,this.paused=void 0,this.id=e.id||"",e.$frame&&e.$logFrame)this.scene=new BattleScene(this,e.$frame,e.$logFrame);else{if(e.$frame||e.$logFrame)throw new Error("You must specify $frame and $logFrame simultaneously");this.scene=new BattleSceneStub}this.paused=!!e.paused,this.started=!this.paused,this.debug=!!e.debug,this.stepQueue=e.log||[],this.subscription=e.subscription||null,this.p1=new Side(this,0),this.p2=new Side(this,1),this.sides=[this.p1,this.p2],this.p2.foe=this.p1,this.p1.foe=this.p2,this.nearSide=this.mySide=this.p1,this.farSide=this.p2,this.resetStep()}var t=e.prototype;return t.subscribe=function(e){this.subscription=e},t.removePseudoWeather=function(e){for(var t=0;t<this.pseudoWeather.length;t++)if(this.pseudoWeather[t][0]===e)return this.pseudoWeather.splice(t,1),void this.scene.updateWeather()},t.addPseudoWeather=function(e,t,s){this.pseudoWeather.push([e,t,s]),this.scene.updateWeather()},t.hasPseudoWeather=function(e){for(var t=0,s=this.pseudoWeather;t<s.length;t++)if(e===s[t][0])return!0;return!1},t.ngasActive=function(){for(var e=0,t=this.sides;e<t.length;e++)for(var s=0,i=t[e].active;s<i.length;s++){var a=i[s];if(a&&!a.fainted&&"Neutralizing Gas"===a.ability&&!a.volatiles.gastroacid)return!0}return!1},t.abilityActive=function(e){var t=this;if(!this.ngasActive()||(e=e.filter(function(e){return t.dex.abilities.get(e).isPermanent})).length)for(var s=0,i=this.sides;s<i.length;s++)for(var a=0,n=i[s].active;a<n.length;a++){var r=n[a];if(r&&!r.fainted&&e.includes(r.ability)&&!r.volatiles.gastroacid)return!0}return!1},t.reset=function(){var e;this.paused=!0,this.scene.pause(),this.resetStep(),null!=(e=this.subscription)&&e.call(this,"paused")},t.resetStep=function(){this.turn=-1,this.started=!this.paused,this.ended=!1,this.atQueueEnd=!1,this.weather="",this.weatherTimeLeft=0,this.weatherMinTimeLeft=0,this.pseudoWeather=[],this.lastMove="";for(var e=0,t=this.sides;e<t.length;e++){var s=t[e];s&&s.reset()}this.myPokemon=null,this.myAllyPokemon=null,this.scene.reset(),this.activeMoveIsSpread=null,this.currentStep=0,this.resetTurnsSinceMoved(),this.nextStep()},t.destroy=function(){this.scene.destroy();for(var e=0;e<this.sides.length;e++)this.sides[e]&&this.sides[e].destroy(),this.sides[e]=null;this.mySide=null,this.nearSide=null,this.farSide=null,this.p1=null,this.p2=null,this.p3=null,this.p4=null},t.log=function(e,t,s){this.scene.log.add(e,t,s)},t.resetToCurrentTurn=function(){this.seekTurn(this.ended?1/0:this.turn,!0)},t.switchSides=function(){this.setPerspective(this.sidesSwitched?"p1":"p2")},t.setPerspective=function(e){var t;this.mySide.sideid!==e&&2===e.length&&e.startsWith("p")&&(t=this[e])&&((this.mySide=t).n%2===this.p1.n?(this.sidesSwitched=!1,this.nearSide=this.p1,this.farSide=this.p2):(this.sidesSwitched=!0,this.nearSide=this.p2,this.farSide=this.p1),this.nearSide.isFar=!1,this.farSide.isFar=!0,2<this.sides.length&&(this.sides[this.nearSide.n+2].isFar=!1,this.sides[this.farSide.n+2].isFar=!0),this.resetToCurrentTurn())},t.start=function(){this.log(["start"]),this.resetTurnsSinceMoved()},t.winner=function(e){var t;this.log(["win",e||""]),this.ended=!0,null!=(t=this.subscription)&&t.call(this,"ended")},t.prematureEnd=function(){var e;this.log(["message","This replay ends here."]),this.ended=!0,null!=(e=this.subscription)&&e.call(this,"ended")},t.endLastTurn=function(){this.endLastTurnPending&&(this.endLastTurnPending=!1,this.scene.updateStatbars())},t.setHardcoreMode=function(e){this.hardcoreMode=e,this.scene.updateSidebars(),this.scene.updateWeather(!0)},t.setTurn=function(e){var t;e===this.turn+1&&(this.endLastTurnPending=!0),this.turn&&!this.usesUpkeep&&this.updateTurnCounters(),this.turn=e,this.started=!0,null===this.seeking&&this.turnsSinceMoved++,this.scene.incrementTurn(),null!==this.seeking?e>=this.seeking&&this.stopSeeking():null!=(t=this.subscription)&&t.call(this,"turn")},t.resetTurnsSinceMoved=function(){this.turnsSinceMoved=0,this.scene.updateAcceleration()},t.changeWeather=function(e,t,s,i){var a,n=toID(e);n&&"none"!==n||(n=""),s?(this.weather&&this.weatherTimeLeft&&(this.weatherTimeLeft--,0!==this.weatherMinTimeLeft&&this.weatherMinTimeLeft--),null===this.seeking&&this.scene.upkeepWeather()):(n&&(a="deltastream"===n||"desolateland"===n||"primordialsea"===n,t?(i&&this.activateAbility(t,i.name),this.weatherTimeLeft=this.gen<=5||a?0:8,this.weatherMinTimeLeft=this.gen<=5||a?0:5):a?(this.weatherTimeLeft=0,this.weatherMinTimeLeft=0):(this.weatherTimeLeft=this.gen<=3?5:8,this.weatherMinTimeLeft=this.gen<=3?0:5)),this.weather=n,this.scene.updateWeather())},t.swapSideConditions=function(){var e=["mist","lightscreen","reflect","spikes","safeguard","tailwind","toxicspikes","stealthrock","waterpledge","firepledge","grasspledge","stickyweb","auroraveil","gmaxsteelsurge","gmaxcannonade","gmaxvinelash","gmaxwildfire"];if("freeforall"!==this.gameType)for(var t=this.sides[0],s=this.sides[1],i=0;i<e.length;i++){var a,n=e[i];t.sideConditions[n]&&s.sideConditions[n]?(a=[s.sideConditions[n],t.sideConditions[n]],t.sideConditions[n]=a[0],s.sideConditions[n]=a[1],this.scene.addSideCondition(t.n,n),this.scene.addSideCondition(s.n,n)):t.sideConditions[n]&&!s.sideConditions[n]?(s.sideConditions[n]=t.sideConditions[n],this.scene.addSideCondition(s.n,n),t.removeSideCondition(n)):s.sideConditions[n]&&!t.sideConditions[n]&&(t.sideConditions[n]=s.sideConditions[n],this.scene.addSideCondition(t.n,n),s.removeSideCondition(n))}},t.updateTurnCounters=function(){for(var e=0,t=this.pseudoWeather;e<t.length;e++){var s=t[e];s[1]&&s[1]--,s[2]&&s[2]--}for(var i=0,a=this.sides;i<a.length;i++){var n,r=a[i];for(n in r.sideConditions){var o=r.sideConditions[n];o[2]&&o[2]--,o[3]&&o[3]--}}for(var h=0,l=[].concat(this.nearSide.active,this.farSide.active);h<l.length;h++){var c=l[h];c&&("tox"===c.status&&c.statusData.toxicTurns++,c.clearTurnstatuses())}this.scene.updateWeather()},t.useMove=function(e,t,s,i){var a=Dex.getEffect(i.from),n=(this.activateAbility(e,a),e.clearMovestatuses(),"focuspunch"===t.id&&e.removeTurnstatus("focuspunch"),this.scene.updateStatbar(e),"sleeptalk"===a.id&&e.rememberMove(t.name,0),null);if(a.id&&i.from.startsWith("move:")&&(n=a),!a.id||n||"pursuit"===a.id){a=t.name;if(!n)if(t.isZ){e.item=t.isZ;var r=Dex.items.get(t.isZ);r.zMoveFrom&&(a=r.zMoveFrom)}else if("Z-"===t.name.slice(0,2)&&(a=a.slice(2),t=Dex.moves.get(a),window.BattleItems))for(var o in BattleItems)BattleItems[o].zMoveType===t.type&&(e.item=o);var h=1;if(this.abilityActive(["Pressure"])&&"stickyweb"!==t.id){var l=[],r=t.pressureTarget;if(s||"singles"!==this.gameType||["self","allies","allySide","adjacentAlly","adjacentAllyOrSelf","allyTeam"].includes(r))if(["all","allAdjacent","allAdjacentFoes","foeSide"].includes(r))for(var c=0,d=this.sides;c<d.length;c++){var u=d[c];if(u!==e.side&&u!==e.side.ally)for(var m=0,p=u.active;m<p.length;m++){var f=p[m];l.push(f)}}else s&&s.side!==e.side&&l.push(s);else l.push(e.side.foe.active[0]);for(var b=0;b<l.length;b++){var g=l[b];g&&!g.fainted&&"Pressure"===g.effectiveAbility()&&(h+=1)}}n?e.rememberMove(n.name,h-1):e.rememberMove(a,h)}e.lastMove=t.id,this.lastMove=t.id,"wish"!==t.id&&"healingwish"!==t.id||(e.side.wisher=e)},t.animateMove=function(e,t,s,i){if(this.activeMoveIsSpread=i.spread,null===this.seeking&&!i.still&&(s=(s=s||e.side.foe.active[0])||e.side.foe.missedPokemon,i.miss&&s.side&&(s=s.side.missedPokemon),!i.notarget))if(i.prepare||"prepare"===i.anim)this.scene.runPrepareAnim(t.id,e,s);else{var a=i.anim?Dex.moves.get(i.anim):t;if(i.spread){var n=[e];if("."===i.spread)n.push(s.side.missedPokemon);else for(var r=0,o=i.spread.split(",");r<o.length;r++){var h=o[r],l=this.getPokemon(h+": ?");l?n.push(l):this.log(["error",'Invalid spread move target: "'+h+'"'])}this.scene.runMoveAnim(a.id,n)}else this.scene.runMoveAnim(a.id,[e,s])}},t.cantUseMove=function(e,t,s,i){switch(e.clearMovestatuses(),this.scene.updateStatbar(e),t.id in BattleStatusAnims&&this.scene.runStatusAnim(t.id,[e]),this.activateAbility(e,t),s.id&&e.rememberMove(s.name,0),t.id){case"par":this.scene.resultAnim(e,"Paralyzed","par");break;case"frz":this.scene.resultAnim(e,"Frozen","frz");break;case"slp":this.scene.resultAnim(e,"Asleep","slp"),e.statusData.sleepTurns++;break;case"truant":this.scene.resultAnim(e,"Loafing around","neutral");break;case"recharge":this.scene.runOtherAnim("selfstatus",[e]),this.scene.resultAnim(e,"Must recharge","neutral");break;case"focuspunch":this.scene.resultAnim(e,"Lost focus","neutral"),e.removeTurnstatus("focuspunch");break;case"shelltrap":this.scene.resultAnim(e,"Trap failed","neutral"),e.removeTurnstatus("shelltrap");break;case"flinch":this.scene.resultAnim(e,"Flinched","neutral"),e.removeTurnstatus("focuspunch");break;case"attract":this.scene.resultAnim(e,"Immobilized","neutral")}this.scene.animReset(e)},t.activateAbility=function(e,t,s){if(e&&t){if("string"!=typeof t){if("Ability"!==t.effectType)return;t=t.name}this.scene.abilityActivateAnim(e,t),e.rememberAbility(t,s)}},t.runMinor=function(e,t,s,W){if(s&&W&&("Sturdy"===e[2]&&"-activate"===e[0]&&(e[2]="ability: Sturdy"),!["-crit","-supereffective","-resisted"].includes(e[0])&&"ability: Sturdy"!==e[2]||(t.then="."),"-damage"!==e[0]||t.from||e[1]===s[1]||!["-crit","-supereffective","-resisted"].includes(s[0])&&("-damage"!==s[0]||W.from)||(t.then="."),"-damage"===e[0]&&"-damage"===s[0]&&t.from&&t.from===W.from&&(t.then="."),"-ability"!==e[0]||"Intimidate"!==e[2]&&"boost"!==e[3]||(t.then="."),"-unboost"===e[0]&&"-unboost"===s[0]&&(t.then="."),"-boost"===e[0]&&"-boost"===s[0]&&(t.then="."),"-damage"===e[0]&&"Leech Seed"===t.from&&"-heal"===s[0]&&W.silent&&(t.then="."),"detailschange"===e[0]&&"-mega"===s[0])){if(this.scene.closeMessagebar())return void this.currentStep--;t.simult="."}t.then&&(this.waitForAnimations=!1),t.simult&&(this.waitForAnimations="simult");var z=["eaten","popped","consumed","held up"];switch(e[0]){case"-damage":var i=this.getPokemon(e[1]),a=i.healthParse(e[2],!0);if(null!==a){var n=i.getDamageRange(a);if(t.from){var r=Dex.getEffect(t.from),O=this.getPokemon(t.of);switch(this.activateAbility(O,r),"Item"!==r.effectType||(o=O||i).prevItem===r.name||z.includes(o.prevItemEffect)||(o.item=r.name),r.id){case"brn":this.scene.runStatusAnim("brn",[i]);break;case"frb":this.scene.runStatusAnim("frb",[i]);break;case"psn":this.scene.runStatusAnim("psn",[i]);break;case"baddreams":case"curse":this.scene.runStatusAnim("cursed",[i]);break;case"confusion":this.scene.runStatusAnim("confusedselfhit",[i]);break;case"leechseed":this.scene.runOtherAnim("leech",[O,i]);break;case"bind":case"wrap":this.scene.runOtherAnim("bound",[i])}}else{var o=""+Pokemon.getFormattedRange(n,100===a[1]?0:1,"–");100!==a[1]&&(r=(a[0]<0?"−":"")+Math.abs(a[0])+"/"+a[1],48===a[1]&&(r+=" pixels"),o="||"+r+"||"+o+"||"),e[3]=o}this.scene.damageAnim(i,Pokemon.getFormattedRange(n,0," to ")),this.log(e,t)}break;case"-heal":var h=this.getPokemon(e[1]),a=h.healthParse(e[2],!0,!0);if(null!==a){r=h.getDamageRange(a);if(t.from){o=Dex.getEffect(t.from);switch(this.activateAbility(h,o),"Item"!==o.effectType||z.includes(h.prevItemEffect)||h.prevItem!==o.name&&(h.item=o.name),o.id){case"lunardance":for(var N=0,R=h.moveTrack;N<R.length;N++)R[N][1]=0;case"healingwish":this.lastMove="healing-wish",this.scene.runResidualAnim("healingwish",h),h.side.wisher=null;break;case"wish":this.scene.runResidualAnim("wish",h)}}this.scene.runOtherAnim("heal",[h]),this.scene.healAnim(h,Pokemon.getFormattedRange(r,0," to ")),this.log(e,t)}break;case"-sethp":for(var Q=0;Q<2;Q++){var U,l,c=this.getPokemon(e[1+2*Q]);c&&(U=c.healthParse(e[2+2*Q]),l=c.getDamageRange(U),l=Pokemon.getFormattedRange(l,0," to "),0<U[0]?this.scene.healAnim(c,l):this.scene.damageAnim(c,l))}this.log(e,t);break;case"-boost":n=this.getPokemon(e[1]),a=e[2];1===this.gen&&"spd"===a||(1===this.gen&&"spa"===a&&(a="spc"),0===(o=parseInt(e[3],10))?this.scene.resultAnim(n,"already "+n.getBoost(a),"neutral"):(n.boosts[a]||(n.boosts[a]=0),n.boosts[a]+=o,!t.silent&&t.from&&(r=Dex.getEffect(t.from),o=this.getPokemon(t.of),"weakarmor"===r.id&&"spe"===a||this.activateAbility(o||n,r)),this.scene.resultAnim(n,n.getBoost(a),"good")),this.log(e,t));break;case"-unboost":o=this.getPokemon(e[1]),r=e[2];1===this.gen&&"spd"===r||(1===this.gen&&"spa"===r&&(r="spc"),0===(n=parseInt(e[3],10))?this.scene.resultAnim(o,"already "+o.getBoost(r),"neutral"):(o.boosts[r]||(o.boosts[r]=0),o.boosts[r]-=n,!t.silent&&t.from&&(a=Dex.getEffect(t.from),n=this.getPokemon(t.of),this.activateAbility(n||o,a)),this.scene.resultAnim(o,o.getBoost(r),"bad")),this.log(e,t));break;case"-setboost":n=this.getPokemon(e[1]),a=e[2],o=parseInt(e[3],10);n.boosts[a]=o,this.scene.resultAnim(n,n.getBoost(a),0<o?"good":"bad"),this.log(e,t);break;case"-swapboost":for(var d=this.getPokemon(e[1]),u=this.getPokemon(e[2]),H=e[3]?e[3].split(", "):["atk","def","spa","spd","spe","accuracy","evasion"],G=0;G<H.length;G++){var m=H[G],j=d.boosts[m];d.boosts[m]=u.boosts[m],d.boosts[m]||delete d.boosts[m],u.boosts[m]=j,u.boosts[m]||delete u.boosts[m]}this.scene.resultAnim(d,"Stats swapped","neutral"),this.scene.resultAnim(u,"Stats swapped","neutral"),this.log(e,t);break;case"-clearpositiveboost":var $,p=this.getPokemon(e[1]),r=this.getPokemon(e[2]),n=Dex.getEffect(e[3]);for($ in p.boosts)0<p.boosts[$]&&delete p.boosts[$];this.scene.resultAnim(p,"Boosts lost","bad"),n.id&&"spectralthief"===n.id&&this.scene.runOtherAnim("spectralthiefboost",[r,p]),this.log(e,t);break;case"-clearnegativeboost":var q,Z=this.getPokemon(e[1]);for(q in Z.boosts)Z.boosts[q]<0&&delete Z.boosts[q];this.scene.resultAnim(Z,"Restored","good"),this.log(e,t);break;case"-copyboost":for(var f=this.getPokemon(e[1]),J=this.getPokemon(e[2]),Y=e[3]?e[3].split(", "):["atk","def","spa","spd","spe","accuracy","evasion"],K=0;K<Y.length;K++){var X=Y[K];f.boosts[X]=J.boosts[X],f.boosts[X]||delete f.boosts[X]}if(6<=this.gen)for(var _=["focusenergy","laserfocus"],ee=0;ee<_.length;ee++){var te=_[ee];J.volatiles[te]?f.addVolatile(te):f.removeVolatile(te)}this.scene.resultAnim(f,"Stats copied","neutral"),this.log(e,t);break;case"-clearboost":a=this.getPokemon(e[1]);a.boosts={},!t.silent&&t.from&&(o=Dex.getEffect(t.from),n=this.getPokemon(t.of),this.activateAbility(n||a,o)),this.scene.resultAnim(a,"Stats reset","neutral"),this.log(e,t);break;case"-invertboost":var se,ie=this.getPokemon(e[1]);for(se in ie.boosts)ie.boosts[se]=-ie.boosts[se];this.scene.resultAnim(ie,"Stats inverted","neutral"),this.log(e,t);break;case"-clearallboost":for(var ae=this.scene.timeOffset,ne=0,re=this.sides;ne<re.length;ne++)for(var oe=0,he=re[ne].active;oe<he.length;oe++){var le=he[oe];le&&(le.boosts={},this.scene.timeOffset=ae,this.scene.resultAnim(le,"Stats reset","neutral"))}this.log(e,t);break;case"-crit":r=this.getPokemon(e[1]);r&&this.scene.resultAnim(r,"Critical hit","bad"),this.activeMoveIsSpread&&(t.spread="."),this.log(e,t);break;case"-supereffective":n=this.getPokemon(e[1]);n&&(this.scene.resultAnim(n,"Super-effective","bad"),null!=(o=window.Config)&&null!=(a=o.server)&&a.afd&&this.scene.runOtherAnim("hitmark",[n])),this.activeMoveIsSpread&&(t.spread="."),this.log(e,t);break;case"-resisted":r=this.getPokemon(e[1]);r&&this.scene.resultAnim(r,"Resisted","neutral"),this.activeMoveIsSpread&&(t.spread="."),this.log(e,t);break;case"-immune":o=this.getPokemon(e[1]),a=Dex.getEffect(t.from);this.activateAbility(this.getPokemon(t.of)||o,a),this.log(e,t),this.scene.resultAnim(o,"Immune","neutral");break;case"-miss":n=this.getPokemon(e[2]);n&&this.scene.resultAnim(n,"Missed","neutral"),this.log(e,t);break;case"-fail":var b=this.getPokemon(e[1]),r=Dex.getEffect(e[2]),ce=Dex.getEffect(t.from),a=this.getPokemon(t.of);switch(this.activateAbility(a||b,ce),r.id){case"brn":this.scene.resultAnim(b,"Already burned","neutral");break;case"frb":this.scene.resultAnim(b,"Already frostbitten","neutral");break;case"tox":case"psn":this.scene.resultAnim(b,"Already poisoned","neutral");break;case"slp":"uproar"===ce.id?this.scene.resultAnim(b,"Failed","neutral"):this.scene.resultAnim(b,"Already asleep","neutral");break;case"drw":"uproar"===ce.id?this.scene.resultAnim(b,"Failed","neutral"):this.scene.resultAnim(b,"Already drowsy","neutral");break;case"par":this.scene.resultAnim(b,"Already paralyzed","neutral");break;case"frz":this.scene.resultAnim(b,"Already frozen","neutral");break;case"unboost":this.scene.resultAnim(b,"Stat drop blocked","neutral");break;default:b&&this.scene.resultAnim(b,"Failed","neutral")}this.scene.animReset(b),this.log(e,t);break;case"-block":var g=this.getPokemon(e[1]),o=this.getPokemon(t.of),n=Dex.getEffect(e[2]);switch(this.activateAbility(o||g,n),n.id){case"quickguard":g.addTurnstatus("quickguard"),this.scene.resultAnim(g,"Quick Guard","good");break;case"wideguard":g.addTurnstatus("wideguard"),this.scene.resultAnim(g,"Wide Guard","good");break;case"craftyshield":g.addTurnstatus("craftyshield"),this.scene.resultAnim(g,"Crafty Shield","good");break;case"protect":g.addTurnstatus("protect"),this.scene.resultAnim(g,"Protected","good");break;case"safetygoggles":g.item="Safety Goggles";break;case"protectivepads":g.item="Protective Pads"}this.log(e,t);break;case"-center":case"-notarget":case"-ohko":case"-combine":case"-hitcount":case"-waiting":case"-zbroken":this.log(e,t);break;case"-zpower":a=this.getPokemon(e[1]);this.scene.runOtherAnim("zpower",[a]),this.log(e,t);break;case"-prepare":r=this.getPokemon(e[1]),o=toID(e[2]),n=this.getPokemon(e[3])||r.side.foe.active[0]||r;this.scene.runPrepareAnim(o,r,n),this.log(e,t);break;case"-mustrecharge":a=this.getPokemon(e[1]);a.addMovestatus("mustrecharge"),this.scene.updateStatbar(a);break;case"-status":var v=this.getPokemon(e[1]),k=Dex.getEffect(t.from),o=this.getPokemon(t.of)||v;switch(v.status=e[2],this.activateAbility(o||v,k),"Item"===k.effectType&&(o.item=k.name),e[2]){case"brn":this.scene.resultAnim(v,"Burned","brn"),this.scene.runStatusAnim("brn",[v]);break;case"frb":this.scene.resultAnim(v,"Frostbitten","frb"),this.scene.runStatusAnim("frb",[v]);break;case"tox":this.scene.resultAnim(v,"Toxic poison","psn"),this.scene.runStatusAnim("psn",[v]),v.statusData.toxicTurns="Toxic Orb"===k.name?-1:0;break;case"psn":this.scene.resultAnim(v,"Poisoned","psn"),this.scene.runStatusAnim("psn",[v]);break;case"slp":this.scene.resultAnim(v,"Asleep","slp"),"rest"===k.id&&(v.statusData.sleepTurns=0);break;case"par":this.scene.resultAnim(v,"Paralyzed","par"),this.scene.runStatusAnim("par",[v]);break;case"drw":this.scene.resultAnim(v,"Drowsy","drw"),this.scene.runStatusAnim("drw",[v]);break;case"frz":this.scene.resultAnim(v,"Frozen","frz"),this.scene.runStatusAnim("frz",[v]);break;default:this.scene.updateStatbar(v)}this.log(e,t);break;case"-curestatus":var A=this.getPokemon(e[1]),r=Dex.getEffect(t.from);if(r.id)switch(r.id){case"flamewheel":case"flareblitz":case"fusionflare":case"sacredfire":case"scald":case"steameruption":t.thaw="."}if(A)switch(A.status="",e[2]){case"brn":this.scene.resultAnim(A,"Burn cured","good");break;case"frb":this.scene.resultAnim(A,"Frostbite healed","good");break;case"tox":case"psn":A.statusData.toxicTurns=0,this.scene.resultAnim(A,"Poison cured","good");break;case"slp":this.scene.resultAnim(A,"Woke up","good"),A.statusData.sleepTurns=0;break;case"drw":this.scene.resultAnim(A,"Drowsiness cured","good");break;case"par":this.scene.resultAnim(A,"Paralysis cured","good");break;case"frz":this.scene.resultAnim(A,"Thawed","good");break;default:A.removeVolatile("confusion"),this.scene.resultAnim(A,"Cured","good")}this.log(e,t);break;case"-cureteam":for(var n=this.getPokemon(e[1]),de=0,ue=n.side.pokemon;de<ue.length;de++){var me=ue[de];me.status="",this.scene.updateStatbarIfExists(me)}this.scene.resultAnim(n,"Team Cured","good"),this.log(e,t);break;case"-item":var y=this.getPokemon(e[1]),S=Dex.items.get(e[2]),pe=Dex.getEffect(t.from),w=this.getPokemon(t.of);if(y.item=S.name,y.itemEffect="",y.removeVolatile("airballoon"),"airballoon"===S.id&&y.addVolatile("airballoon"),pe.id)switch(pe.id){case"pickup":this.activateAbility(y,"Pickup");case"recycle":y.itemEffect="found",this.scene.resultAnim(y,S.name,"neutral");break;case"frisk":this.activateAbility(w,"Frisk"),y&&y!==w&&(y.itemEffect="frisked",this.scene.resultAnim(y,S.name,"neutral"));break;case"magician":case"pickpocket":this.activateAbility(y,pe.name);case"thief":case"covet":w.item="",w.itemEffect="",w.prevItem=S.name,w.prevItemEffect="stolen",w.addVolatile("itemremoved"),y.itemEffect="stolen",this.scene.resultAnim(y,S.name,"neutral"),this.scene.resultAnim(w,"Item Stolen","bad");break;case"harvest":y.itemEffect="harvested",this.activateAbility(y,"Harvest"),this.scene.resultAnim(y,S.name,"neutral");break;case"bestow":y.itemEffect="bestowed",this.scene.resultAnim(y,S.name,"neutral");break;case"switcheroo":case"trick":y.itemEffect="tricked"}else"airballoon"===S.id&&this.scene.resultAnim(y,"Balloon","good");this.log(e,t);break;case"-enditem":var P=this.getPokemon(e[1]),a=Dex.items.get(e[2]),o=Dex.getEffect(t.from);if(P.item="",P.itemEffect="",P.prevItem=a.name,P.prevItemEffect="",P.removeVolatile("airballoon"),P.addVolatile("itemremoved"),t.eat)P.prevItemEffect="eaten",this.scene.runOtherAnim("consume",[P]),this.lastMove=a.id;else if(t.weaken)P.prevItemEffect="eaten",this.lastMove=a.id;else if(o.id)switch(o.id){case"fling":P.prevItemEffect="flung";break;case"knockoff":P.prevItemEffect="knocked off",this.scene.runOtherAnim("itemoff",[P]),this.scene.resultAnim(P,"Item knocked off","neutral");break;case"stealeat":P.prevItemEffect="stolen";break;case"gem":P.prevItemEffect="consumed";break;case"incinerate":P.prevItemEffect="incinerated"}else switch(a.id){case"airballoon":P.prevItemEffect="popped",P.removeVolatile("airballoon"),this.scene.resultAnim(P,"Balloon popped","neutral");break;case"focussash":P.prevItemEffect="consumed",this.scene.resultAnim(P,"Sash","neutral");break;case"focusband":this.scene.resultAnim(P,"Focus Band","neutral");break;case"redcard":P.prevItemEffect="held up";break;default:P.prevItemEffect="consumed"}this.log(e,t);break;case"-ability":var x=this.getPokemon(e[1]),T=Dex.abilities.get(e[2]),fe=Dex.getEffect(t.from),be=this.getPokemon(t.of);if(x.rememberAbility(T.name,fe.id&&!t.fail),!t.silent)if(fe.id)switch(fe.id){case"trace":this.activateAbility(x,"Trace"),this.scene.wait(500),this.activateAbility(x,T.name,!0),be.rememberAbility(T.name);break;case"powerofalchemy":case"receiver":this.activateAbility(x,fe.name),this.scene.wait(500),this.activateAbility(x,T.name,!0),be.rememberAbility(T.name);break;case"roleplay":this.activateAbility(x,T.name,!0),be.rememberAbility(T.name);break;case"desolateland":case"primordialsea":case"deltastream":t.fail&&this.activateAbility(x,T.name);break;default:this.activateAbility(x,T.name)}else this.activateAbility(x,T.name);this.scene.updateWeather(),this.log(e,t);break;case"-endability":r=this.getPokemon(e[1]),n=Dex.abilities.get(e[2]);r.ability="(suppressed)",!n.id||r.baseAbility||(r.baseAbility=n.name),this.log(e,t);break;case"detailschange":o=this.getPokemon(e[1]),a=(o.removeVolatile("formechange"),o.removeVolatile("typeadd"),o.removeVolatile("typechange"),e[2]),r=a.indexOf(","),n=(-1!==r&&("L"===(n=a.substr(r+1).trim()).charAt(0)&&(o.level=parseInt(n.substr(1),10)),a=e[2].substr(0,r)),this.dex.species.get(a));o.speciesForme=a,o.ability=o.baseAbility=n.abilities?n.abilities[0]:"",o.details=e[2],o.searchid=e[1].substr(0,2)+e[1].substr(3)+"|"+e[2],this.scene.animTransform(o,!0,!0),this.log(e,t);break;case"-transform":var M=this.getPokemon(e[1]),r=this.getPokemon(e[2]),a=Dex.getEffect(t.from);if(M===r)throw new Error("Transforming into self");t.silent||this.activateAbility(M,a),M.boosts=Object.assign({},r.boosts),M.copyTypesFrom(r),M.ability=r.ability;n=r.volatiles.formechange,o=n&&!n[1].endsWith("-Gmax")?n[1]:r.speciesForme,a=r.shiny,n=r.gender;M.addVolatile("transform",r,a,n),M.addVolatile("formechange",o);for(var ge=0,ve=r.moveTrack;ge<ve.length;ge++){var ke=ve[ge];M.rememberMove(ke[0],0)}this.scene.animTransform(M),this.scene.resultAnim(M,"Transformed","good"),this.log(["-transform",e[1],e[2],r.speciesForme],t);break;case"-formechange":a=this.getPokemon(e[1]),n=Dex.species.get(e[2]),o=Dex.getEffect(t.from),r=n.name.startsWith("Wishiwashi");a.getSpeciesForme().endsWith("-Gmax")||n.name.endsWith("-Gmax")||(a.removeVolatile("typeadd"),a.removeVolatile("typechange"),6<=this.gen&&a.removeVolatile("autotomize")),t.silent||this.activateAbility(a,o),a.addVolatile("formechange",n.name),this.scene.animTransform(a,r),this.log(e,t);break;case"-mega":o=this.getPokemon(e[1]),n=Dex.items.get(e[3]);e[3]&&(o.item=n.name),this.log(e,t);break;case"-primal":case"-burst":this.log(e,t);break;case"-start":var D=this.getPokemon(e[1]),a=Dex.getEffect(e[2]),Ae=this.getPokemon(t.of),ye=Dex.getEffect(t.from);switch(this.activateAbility(D,a),this.activateAbility(Ae||D,ye),a.id){case"typechange":Ae&&"reflecttype"===ye.id?D.copyTypesFrom(Ae):(I=Dex.sanitizeName(e[3]||"???"),D.removeVolatile("typeadd"),D.addVolatile("typechange",I),t.silent||this.scene.typeAnim(D,I)),this.scene.updateStatbar(D);break;case"typeadd":var I=Dex.sanitizeName(e[3]);D.addVolatile("typeadd",I),t.silent||this.scene.typeAnim(D,I);break;case"dynamax":D.addVolatile("dynamax"),this.scene.animTransform(D,!0);break;case"powertrick":this.scene.resultAnim(D,"Power Trick","neutral");break;case"foresight":case"miracleeye":this.scene.resultAnim(D,"Identified","bad");break;case"telekinesis":this.scene.resultAnim(D,"Telekinesis","neutral");break;case"confusion":t.already||(this.scene.runStatusAnim("confused",[D]),this.scene.resultAnim(D,"Confused","bad"));break;case"leechseed":this.scene.updateStatbar(D);break;case"healblock":this.scene.resultAnim(D,"Heal Block","bad");break;case"yawn":this.scene.resultAnim(D,"Drowsy","slp");break;case"taunt":this.scene.resultAnim(D,"Taunted","bad");break;case"imprison":this.scene.resultAnim(D,"Imprisoning","good");break;case"disable":this.scene.resultAnim(D,"Disabled","bad");break;case"embargo":this.scene.resultAnim(D,"Embargo","bad");break;case"torment":this.scene.resultAnim(D,"Tormented","bad");break;case"ingrain":this.scene.resultAnim(D,"Ingrained","good");break;case"aquaring":this.scene.resultAnim(D,"Aqua Ring","good");break;case"stockpile1":this.scene.resultAnim(D,"Stockpile","good");break;case"stockpile2":D.removeVolatile("stockpile1"),this.scene.resultAnim(D,"Stockpile&times;2","good");break;case"stockpile3":D.removeVolatile("stockpile2"),this.scene.resultAnim(D,"Stockpile&times;3","good");break;case"perish0":D.removeVolatile("perish1");break;case"perish1":D.removeVolatile("perish2"),this.scene.resultAnim(D,"Perish next turn","bad");break;case"perish2":D.removeVolatile("perish3"),this.scene.resultAnim(D,"Perish in 2","bad");break;case"perish3":t.silent||this.scene.resultAnim(D,"Perish in 3","bad");break;case"encore":this.scene.resultAnim(D,"Encored","bad");break;case"bide":this.scene.resultAnim(D,"Bide","good");break;case"attract":this.scene.resultAnim(D,"Attracted","bad");break;case"autotomize":this.scene.resultAnim(D,"Lightened","good"),D.volatiles.autotomize?D.volatiles.autotomize[1]++:D.addVolatile("autotomize",1);break;case"focusenergy":this.scene.resultAnim(D,"+Crit rate","good");break;case"curse":this.scene.resultAnim(D,"Cursed","bad");break;case"nightmare":this.scene.resultAnim(D,"Nightmare","bad");break;case"magnetrise":this.scene.resultAnim(D,"Magnet Rise","good");break;case"smackdown":this.scene.resultAnim(D,"Smacked Down","bad"),D.removeVolatile("magnetrise"),D.removeVolatile("telekinesis"),"fly"!==D.lastMove&&"bounce"!==D.lastMove||this.scene.animReset(D);break;case"substitute":t.damage?this.scene.resultAnim(D,"Damage","bad"):t.block&&this.scene.resultAnim(D,"Blocked","neutral");break;case"mist":this.scene.resultAnim(D,"Mist","good");break;case"lightscreen":this.scene.resultAnim(D,"Light Screen","good");break;case"reflect":this.scene.resultAnim(D,"Reflect","good")}D.addVolatile(a.id),this.scene.updateStatbar(D),this.log(e,t);break;case"-end":var C=this.getPokemon(e[1]),Se=Dex.getEffect(e[2]),we=Dex.getEffect(t.from);if(C.removeVolatile(Se.id),!t.silent)switch(Se.id){case"dynamax":this.scene.animTransform(C);break;case"powertrick":this.scene.resultAnim(C,"Power Trick","neutral");break;case"telekinesis":this.scene.resultAnim(C,"Telekinesis&nbsp;ended","neutral");break;case"skydrop":t.interrupt&&this.scene.anim(C,{time:100});break;case"confusion":this.scene.resultAnim(C,"Confusion&nbsp;ended","good");break;case"leechseed":"rapidspin"===we.id&&this.scene.resultAnim(C,"De-seeded","good");break;case"healblock":this.scene.resultAnim(C,"Heal Block ended","good");break;case"attract":this.scene.resultAnim(C,"Attract&nbsp;ended","good");break;case"taunt":this.scene.resultAnim(C,"Taunt&nbsp;ended","good");break;case"disable":this.scene.resultAnim(C,"Disable&nbsp;ended","good");break;case"embargo":this.scene.resultAnim(C,"Embargo ended","good");break;case"torment":this.scene.resultAnim(C,"Torment&nbsp;ended","good");break;case"encore":this.scene.resultAnim(C,"Encore&nbsp;ended","good");break;case"bide":this.scene.runOtherAnim("bideunleash",[C]);break;case"illusion":this.scene.resultAnim(C,"Illusion ended","bad"),C.rememberAbility("Illusion");break;case"slowstart":this.scene.resultAnim(C,"Slow Start ended","good");break;case"perishsong":C.removeVolatile("perish3");break;case"substitute":this.scene.resultAnim(C,"Faded","bad");break;case"stockpile":C.removeVolatile("stockpile1"),C.removeVolatile("stockpile2"),C.removeVolatile("stockpile3");break;default:"Move"===Se.effectType&&("Doom Desire"===Se.name&&this.scene.runOtherAnim("doomdesirehit",[C]),"Future Sight"===Se.name&&this.scene.runOtherAnim("futuresighthit",[C]))}this.scene.updateStatbar(C),this.log(e,t);break;case"-singleturn":var F=this.getPokemon(e[1]),Pe=Dex.getEffect(e[2]);if("roost"!==Pe.id||F.getTypeList().includes("Flying")){switch(F.addTurnstatus(Pe.id),Pe.id){case"roost":this.scene.resultAnim(F,"Landed","neutral");break;case"quickguard":this.scene.resultAnim(F,"Quick Guard","good");break;case"wideguard":this.scene.resultAnim(F,"Wide Guard","good");break;case"craftyshield":this.scene.resultAnim(F,"Crafty Shield","good");break;case"matblock":this.scene.resultAnim(F,"Mat Block","good");break;case"protect":this.scene.resultAnim(F,"Protected","good");break;case"endure":this.scene.resultAnim(F,"Enduring","good");break;case"helpinghand":this.scene.resultAnim(F,"Helping Hand","good");break;case"focuspunch":this.scene.resultAnim(F,"Focusing","neutral"),F.rememberMove(Pe.name,0);break;case"shelltrap":this.scene.resultAnim(F,"Trap set","neutral"),F.rememberMove(Pe.name,0);break;case"beakblast":this.scene.runOtherAnim("bidecharge",[F]),this.scene.resultAnim(F,"Beak Blast","neutral")}this.scene.updateStatbar(F),this.log(e,t)}break;case"-singlemove":var xe=this.getPokemon(e[1]),r=Dex.getEffect(e[2]);switch(xe.addMovestatus(r.id),r.id){case"grudge":this.scene.resultAnim(xe,"Grudge","neutral");break;case"destinybond":this.scene.resultAnim(xe,"Destiny Bond","neutral")}this.log(e,t);break;case"-activate":var E=this.getPokemon(e[1]),Te=Dex.getEffect(e[2]),V=this.getPokemon(e[3]);switch(this.activateAbility(E,Te),Te.id){case"poltergeist":E.item=t.item,E.itemEffect="disturbed";break;case"grudge":E.rememberMove(t.move,1/0);break;case"substitute":t.damage?this.scene.resultAnim(E,"Damage","bad"):t.block&&this.scene.resultAnim(E,"Blocked","neutral");break;case"attract":this.scene.runStatusAnim("attracted",[E]);break;case"bide":this.scene.runOtherAnim("bidecharge",[E]);break;case"aromatherapy":case"healbell":this.scene.resultAnim(E,"Team Cured","good");break;case"brickbreak":V.side.removeSideCondition("Reflect"),V.side.removeSideCondition("LightScreen");break;case"hyperspacefury":case"hyperspacehole":case"phantomforce":case"shadowforce":case"feint":this.scene.resultAnim(E,"Protection broken","bad"),E.removeTurnstatus("protect");for(var Me=0,De=E.side.pokemon;Me<De.length;Me++){var Ie=De[Me];Ie.removeTurnstatus("wideguard"),Ie.removeTurnstatus("quickguard"),Ie.removeTurnstatus("craftyshield"),Ie.removeTurnstatus("matblock"),this.scene.updateStatbar(Ie)}break;case"eeriespell":case"gmaxdepletion":case"spite":var L=Dex.moves.get(t.move).name,B=Number(t.number);isNaN(B)&&(B=4),E.rememberMove(L,B);break;case"gravity":E.removeVolatile("magnetrise"),E.removeVolatile("telekinesis"),this.scene.anim(E,{time:100});break;case"skillswap":case"wanderingspirit":this.gen<=4||(L=Dex.sanitizeName(t.ability)||V.ability,B=Dex.sanitizeName(t.ability2)||E.ability,L&&(E.ability=L,V.baseAbility||(V.baseAbility=L)),B&&(V.ability=B,E.baseAbility||(E.baseAbility=B)),E.side!==V.side&&(this.activateAbility(E,L,!0),this.activateAbility(V,B,!0)));break;case"forewarn":if(V)V.rememberMove(t.move,0);else{for(var Ce=[],Fe=0,Ee=E.side.foe.active;Fe<Ee.length;Fe++){var Ve=Ee[Fe];Ve&&!Ve.fainted&&Ce.push(Ve)}1===Ce.length&&Ce[0].rememberMove(t.move,0)}break;case"mummy":t.ability&&(L=Dex.abilities.get(t.ability),this.activateAbility(V,L.name),this.activateAbility(E,"Mummy"),this.scene.wait(700),this.activateAbility(V,"Mummy",!0));break;case"leppaberry":case"mysteryberry":E.rememberMove(t.move,"leppaberry"===Te.id?-10:-5);break;case"focusband":E.item="Focus Band";break;case"quickclaw":E.item="Quick Claw";break;default:t.broken&&this.scene.resultAnim(E,"Protection broken","bad")}this.log(e,t);break;case"-sidestart":o=this.getSide(e[1]),n=Dex.getEffect(e[2]);switch(o.addSideCondition(n),n.id){case"tailwind":case"auroraveil":case"reflect":case"lightscreen":case"safeguard":case"mist":case"gmaxwildfire":case"gmaxvolcalith":case"gmaxvinelash":case"gmaxcannonade":case"grasspledge":case"firepledge":case"waterpledge":this.scene.updateWeather()}this.log(e,t);break;case"-sideend":a=this.getSide(e[1]),r=Dex.getEffect(e[2]);a.removeSideCondition(r.name),this.log(e,t);break;case"-swapsideconditions":this.swapSideConditions(),this.scene.updateWeather(),this.log(e,t);break;case"-weather":o=Dex.getEffect(e[1]),n=this.getPokemon(t.of)||void 0,a=Dex.getEffect(t.from);o.id&&"none"!==o.id||(t.from=this.weather),this.changeWeather(o.name,n,!!t.upkeep,a),this.log(e,t);break;case"-fieldstart":r=Dex.getEffect(e[1]),o=this.getPokemon(t.of),n=Dex.getEffect(t.from),a=(this.activateAbility(o,n),0);if(r.id.endsWith("terrain")){for(var Le=this.pseudoWeather.length-1;0<=Le;Le--)toID(this.pseudoWeather[Le][0]).endsWith("terrain")&&this.pseudoWeather.splice(Le,1);6<this.gen&&(a=8)}if(this.addPseudoWeather(r.name,5,a),"gravity"===r.id)if(null===this.seeking)for(var Be=0,We=this.sides;Be<We.length;Be++)for(var ze=0,Oe=We[Be].active;ze<Oe.length;ze++){var Ne=Oe[ze];Ne&&this.scene.runOtherAnim("gravity",[Ne])}this.log(e,t);break;case"-fieldend":o=Dex.getEffect(e[1]);this.removePseudoWeather(o.name),this.log(e,t);break;case"-fieldactivate":"perishsong"===Dex.getEffect(e[1]).id&&this.scene.updateStatbars(),this.log(e,t);break;case"-anim":n=this.getPokemon(e[1]),a=Dex.moves.get(e[2]);if(this.checkActive(n))return;r=this.getPokemon(e[3]);this.scene.beforeMove(n),this.animateMove(n,a,r,t),this.scene.afterMove(n);break;case"-hint":case"-message":case"-candynamax":this.log(e,t);break;default:throw new Error("Unrecognized minor action: "+e[0])}},t.parseDetails=function(e,t,s){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},a=!e,a=(i.details=s,i.name=e,i.speciesForme=e,i.level=100,i.shiny=!1,i.gender="",i.ident=a?"":t,i.searchid=a?"":t+"|"+s,s.split(", "));return"shiny"===a[a.length-1]&&(i.shiny=!0,a.pop()),"M"!==a[a.length-1]&&"F"!==a[a.length-1]||(i.gender=a[a.length-1],a.pop()),a[1]&&(i.level=parseInt(a[1].substr(1),10)||100),a[0]&&(i.speciesForme=a[0]),i},t.parseHealth=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},s=e.split(" "),i=s[0],s=s[1];if(t.hpcolor="","0"===i||"0.0"===i)t.maxhp||(t.maxhp=100),t.hp=0;else if(0<i.indexOf("/")){var a=i.split("/"),n=a[0],a=a[1];if(isNaN(parseFloat(n))||isNaN(parseFloat(a)))return null;t.hp=parseFloat(n),t.maxhp=parseFloat(a),t.hp>t.maxhp&&(t.hp=t.maxhp);n=a.slice(-1);"y"!==n&&"g"!==n||(t.hpcolor=n)}else isNaN(parseFloat(i))||(t.maxhp||(t.maxhp=100),t.hp=t.maxhp*parseFloat(i)/100);return s?"par"===s||"brn"===s||"slp"===s||"frz"===s||"tox"===s||"frb"===s||"drw"===s||"psn"===s&&"tox"!==t.status?t.status=s:"fnt"===s&&(t.hp=0,t.fainted=!0):t.status="",t},t.parsePokemonId=function(e){var t=e,s=-1,i=-1;return/^p[1-9]($|: )/.test(t)?(s=parseInt(t.charAt(1),10)-1,t=t.slice(4)):/^p[1-9][a-f]: /.test(t)&&(s=parseInt(t.charAt(1),10)-1,i={a:0,b:1,c:2,d:3,e:4,f:5}[t.charAt(2)],e="p"+(s+1)+": "+(t=t.slice(5))),{name:t,siden:s,slot:i,pokemonid:e}},t.getSwitchedPokemon=function(e,t){if("??"===e)throw new Error("pokemonid not passed");for(var s=this.parsePokemonId(e),i=s.name,a=s.siden,n=s.slot,r=(e=s.pokemonid)+"|"+t,o=this.sides[a],h=0;h<o.pokemon.length;h++){var l=o.pokemon[h];if(!l.fainted&&(!o.active.includes(l)&&(l!==o.lastPokemon||o.active[n]))){if(l.searchid===r)return 0<=n&&(l.slot=n),l;if(!l.searchid&&l.checkDetails(t))return l=o.addPokemon(i,e,t,h),0<=n&&(l.slot=n),l}}s=o.addPokemon(i,e,t);return 0<=n&&(s.slot=n),s},t.rememberTeamPreviewPokemon=function(e,t){var s=this.parsePokemonId(e).siden;return this.sides[s].addPokemon("","",t)},t.findCorrespondingPokemon=function(e){for(var t=this.parsePokemonId(e.ident).siden,s=e.ident+"|"+e.details,i=0,a=this.sides[t].pokemon;i<a.length;i++){var n=a[i];if(n.searchid===s)return n}return null},t.getPokemon=function(e){if(e&&"??"!==e&&"null"!==e&&"false"!==e){var t=this.parsePokemonId(e),s=t.siden,i=t.slot,a=(e=t.pokemonid,i<0),n=this.sides[s];if(!a&&n.active[i])return n.active[i];for(var r=0,o=n.pokemon;r<o.length;r++){var h=o[r];if((!a||!n.active.includes(h))&&h.ident===e)return 0<=i&&(h.slot=i),h}}return null},t.getSide=function(e){return"p1"===e||e.startsWith("p1:")?this.p1:"p2"===e||e.startsWith("p2:")?this.p2:("p3"===e||e.startsWith("p3:"))&&this.p3?this.p3:("p4"===e||e.startsWith("p4:"))&&this.p4?this.p4:this.nearSide.id===e?this.nearSide:this.farSide.id===e?this.farSide:this.nearSide.name===e?this.nearSide:this.farSide.name===e?this.farSide:{name:e,id:e.replace(/ /g,"")}},t.add=function(e){e&&this.stepQueue.push(e),this.atQueueEnd&&this.currentStep<this.stepQueue.length&&(this.atQueueEnd=!1,this.nextStep())},t.instantAdd=function(e){this.run(e,!0),this.preemptStepQueue.push(e),this.add(e)},t.runMajor=function(e,t,s){switch(e[0]){case"start":this.nearSide.active[0]=null,this.farSide.active[0]=null,this.scene.resetSides(),this.start();break;case"upkeep":this.usesUpkeep=!0,this.updateTurnCounters();break;case"turn":this.setTurn(parseInt(e[1],10)),this.log(e);break;case"tier":this.tier=e[1],"Random Battle"===this.tier.slice(-13)&&(this.speciesClause=!0)," (Blitz)"===this.tier.slice(-8)&&(this.messageFadeTime=40,this.isBlitz=!0),this.tier.includes("Let's Go")&&(this.dex=Dex.mod("gen7letsgo")),this.tier.includes("Super Nat"),this.log(e);break;case"gametype":switch(this.gameType=e[1],e[1]){case"multi":case"freeforall":this.pokemonControlled=1,this.p3||(this.p3=new Side(this,2)),this.p4||(this.p4=new Side(this,3)),this.p3.foe=this.p2,this.p4.foe=this.p1,"multi"===e[1]&&(this.p4.ally=this.p2,this.p3.ally=this.p1,this.p1.ally=this.p3,this.p2.ally=this.p4),this.p3.isFar=this.p1.isFar,this.p4.isFar=this.p2.isFar,this.sides=[this.p1,this.p2,this.p3,this.p4],this.p1.active=this.p3.active=[null,null],this.p2.active=this.p4.active=[null,null];break;case"doubles":this.nearSide.active=[null,null],this.farSide.active=[null,null];break;case"triples":case"rotation":this.nearSide.active=[null,null,null],this.farSide.active=[null,null,null];break;default:for(var i=0,a=this.sides;i<a.length;i++)a[i].active=[null]}this.pokemonControlled||(this.pokemonControlled=this.nearSide.active.length),this.scene.updateGen(),this.scene.resetSides();break;case"rule":var n=e[1].split(": ")[0];"Species Clause"===n&&(this.speciesClause=!0),"Blitz"===n&&(this.messageFadeTime=40,this.isBlitz=!0),this.log(e);break;case"rated":this.rated=e[1]||!0,this.scene.updateGen(),this.log(e);break;case"inactive":if(this.kickingInactive||(this.kickingInactive=!0),"Time left: "===e[1].slice(0,11))return r=(n=e[1].split(" | "))[0],o=n[1],n=n[2],this.kickingInactive=parseInt(r.slice(11),10)||!0,this.totalTimeLeft=parseInt(o,10),this.graceTimeLeft=parseInt(n||"",10)||0,void(this.totalTimeLeft===this.kickingInactive&&(this.totalTimeLeft=0));if("You have "===e[1].slice(0,9))return void(this.kickingInactive=parseInt(e[1].slice(9),10)||!0);if(" seconds left."===e[1].slice(-14)){var r=e[1].indexOf(" has "),o=null==(o=window.app)||null==(n=o.user)?void 0:n.get("userid");toID(e[1].slice(0,r))===o&&(this.kickingInactive=parseInt(e[1].slice(r+5),10)||!0)}else if(" 15 seconds left this turn."===e[1].slice(-27)&&this.isBlitz)return;this.log(e,void 0,s);break;case"inactiveoff":this.kickingInactive=!1,this.log(e,void 0,s);break;case"join":case"j":case"J":this.roomid&&(n=app.rooms[this.roomid],o=BattleTextParser.parseNameParts(e[1]),r=toUserid(o.name),n.users[r]||n.userCount.users++,n.users[r]=o,n.userList.add(r),n.userList.updateUserCount(),n.userList.updateNoUsersOnline()),this.log(e,void 0,s);break;case"leave":case"l":case"L":this.roomid&&(o=app.rooms[this.roomid],r=e[1],n=toUserid(r),o.users[n]&&o.userCount.users--,delete o.users[n],o.userList.remove(n),o.userList.updateUserCount(),o.userList.updateNoUsersOnline()),this.log(e,void 0,s);break;case"name":case"n":case"N":this.roomid&&(r=app.rooms[this.roomid],n=BattleTextParser.parseNameParts(e[1]),o=e[2],toUserid(o)===app.user.get("userid")&&app.user.set({away:n.away,status:n.status}),h=toUserid(n.name),r.users[h]=n,r.userList.remove(o),r.userList.add(h)),this.ignoreSpects||this.log(e,void 0,s);break;case"player":n=this.getSide(e[1]);n.setName(e[2]),e[3]&&n.setAvatar(e[3]),e[4]&&(n.rating=e[4]),this.joinButtons&&this.scene.hideJoinButtons(),this.log(e),this.scene.updateSidebar(n);break;case"teamsize":o=this.getSide(e[1]);o.totalPokemon=parseInt(e[2],10),this.scene.updateSidebar(o);break;case"win":case"tie":this.winner("tie"===e[0]?void 0:e[1]);break;case"prematureend":this.prematureEnd();break;case"clearpoke":this.p1.clearPokemon(),this.p2.clearPokemon();break;case"poke":r=this.rememberTeamPreviewPokemon(e[1],e[2]);"mail"===e[3]?r.item="(mail)":"item"===e[3]&&(r.item="(exists)");break;case"updatepoke":for(var h=this.parsePokemonId(e[1]).siden,l=this.sides[h],c=0;c<l.pokemon.length;c++){var d=l.pokemon[c];if(d.details!==e[2]&&d.checkDetails(e[2])){l.addPokemon("","",e[2],c);break}}break;case"teampreview":this.teamPreviewCount=parseInt(e[1],10),this.scene.teamPreview();break;case"switch":case"drag":case"replace":this.endLastTurn();n=this.getSwitchedPokemon(e[1],e[2]),o=n.slot;n.healthParse(e[3]),n.removeVolatile("itemremoved"),"switch"===e[0]?(n.side.active[o]&&n.side.switchOut(n.side.active[o]),n.side.switchIn(n)):"replace"===e[0]?n.side.replace(n):n.side.dragIn(n),this.scene.updateWeather(),this.log(e,t);break;case"faint":r=this.getPokemon(e[1]);r.side.faint(r),this.log(e,t);break;case"swap":isNaN(Number(e[2]))?(h=this.getPokemon(e[1])).side.swapWith(h,this.getPokemon(e[2]),t):(o=this.getPokemon(e[1]),n=parseInt(e[2],10),t.from&&(r=o.side.active[n])&&(e[2]=r.ident),o.side.swapTo(o,n,t)),this.log(e,t);break;case"move":this.endLastTurn(),this.resetTurnsSinceMoved();h=this.getPokemon(e[1]),r=Dex.moves.get(e[2]);if(this.checkActive(h))return;o=this.getPokemon(e[3]);this.scene.beforeMove(h),this.useMove(h,r,o,t),this.animateMove(h,r,o,t),this.log(e,t),this.scene.afterMove(h);break;case"cant":this.endLastTurn(),this.resetTurnsSinceMoved();n=this.getPokemon(e[1]),r=Dex.getEffect(e[2]),o=Dex.moves.get(e[3]);this.cantUseMove(n,r,o,t),this.log(e,t);break;case"gen":this.gen=parseInt(e[1],10),this.dex=Dex.forGen(this.gen),this.scene.updateGen(),this.log(e);break;case"callback":null!=(h=this.subscription)&&h.call(this,"callback");break;case"fieldhtml":this.scene.setFrameHTML(BattleLog.sanitizeHTML(e[1]));break;case"controlshtml":this.scene.setControlsHTML(BattleLog.sanitizeHTML(e[1]));break;default:this.log(e,t,s)}},t.run=function(t,e){if(!e&&this.preemptStepQueue.length&&t===this.preemptStepQueue[0])this.preemptStepQueue.shift(),this.scene.preemptCatchup();else if(t){var s=BattleTextParser.parseBattleLine(t),i=s.args,s=s.kwArgs;if(this.scene.maybeCloseMessagebar(i,s))this.currentStep--,this.activeMoveIsSpread=null;else{var a,n=[""],r={},o=this.stepQueue[this.currentStep+1]||"";if("|-"===o.slice(0,2)&&(n=(a=BattleTextParser.parseBattleLine(o)).args,r=a.kwArgs),this.debug)"-"===i[0].charAt(0)||"detailschange"===i[0]?this.runMinor(i,s,n,r):this.runMajor(i,s,e);else try{"-"===i[0].charAt(0)||"detailschange"===i[0]?this.runMinor(i,s,n,r):this.runMajor(i,s,e)}catch(e){if(this.log(["majorerror","Error parsing: "+t+" ("+e+")"]),e.stack)for(var h=(""+e.stack).split("\n"),l=0;l<h.length;l++){var c=h[l];if(/\brun\b/.test(c))break;this.log(["error",c])}null!=(a=this.subscription)&&a.call(this,"error")}!o.startsWith("|start")&&"teampreview"!==i[0]||-1!==this.turn||(this.turn=0,this.scene.updateBgm(),this.tier.includes("Big Rain")&&null!=(n=this.roomid)&&n.includes("replay")&&this.scene.setBgm(-102))}}},t.checkActive=function(e){return e.side.active[e.slot]||e.side.replace(e),!1},t.pause=function(){var e;this.paused=!0,this.scene.pause(),null!=(e=this.subscription)&&e.call(this,"paused")},t.play=function(){var e;this.paused=!1,this.started=!0,this.scene.resume(),this.nextStep(),null!=(e=this.subscription)&&e.call(this,"playing")},t.skipTurn=function(){this.seekTurn(this.turn+1)},t.seekTurn=function(e,t){var s;isNaN(e)||(e=Math.max(Math.floor(e),0),null!==this.seeking&&this.seeking>e&&!t?this.seeking=e:0===e?(this.seeking=null,this.resetStep(),this.scene.animationOn(),this.paused&&null!=(s=this.subscription)&&s.call(this,"paused")):(this.seeking=e)<=this.turn||t?(this.scene.animationOff(),this.resetStep()):this.atQueueEnd?(this.scene.animationOn(),this.seeking=null):(this.scene.animationOff(),this.nextStep()))},t.stopSeeking=function(){var e;this.seeking=null,this.scene.animationOn(),null!=(e=this.subscription)&&e.call(this,this.paused?"paused":"playing")},t.shouldStep=function(){return!this.atQueueEnd&&(null!==this.seeking||!(this.paused&&0<=this.turn))},t.nextStep=function(){var e=this;if(this.shouldStep()){this.scene.startAnimations();var t,s,i=void 0;do{if(this.waitForAnimations=!0,this.currentStep>=this.stepQueue.length)return this.atQueueEnd=!0,!this.ended&&this.isReplay&&this.prematureEnd(),this.stopSeeking(),this.ended&&this.scene.updateBgm(),void(null!=(t=this.subscription)&&t.call(this,"atqueueend"))}while(this.run(this.stepQueue[this.currentStep]),this.currentStep++,!0===this.waitForAnimations?i=this.scene.finishAnimations():"simult"===this.waitForAnimations&&(this.scene.timeOffset=0),!i&&this.shouldStep());this.paused&&0<=this.turn&&null===this.seeking?this.scene.pause():i&&(s=this.scene.interruptionCount,i.done(function(){s===e.scene.interruptionCount&&e.nextStep()}))}},t.setQueue=function(e){this.stepQueue=e,this.resetStep()},t.setMute=function(e){this.scene.setMute(e)},e}();"function"==typeof require&&(global.Battle=Battle,global.Pokemon=Pokemon);
