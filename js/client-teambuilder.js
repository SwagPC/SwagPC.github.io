!function(s,u){s.TeambuilderRoom=s.Room.extend({type:"teambuilder",title:"Teambuilder",initialize:function(){o=Storage.teams,this.$el.addClass("ps-room-light").addClass("scrollable"),Storage.whenTeamsLoaded.isLoaded||Storage.whenTeamsLoaded(this.update,this),this.update()},focus:function(){this.curTeam&&(this.curTeam.iconCache="!",this.curTeam.gen=this.getGen(this.curTeam.format),this.curTeam.dex=Dex.forGen(this.curTeam.gen),this.curTeam.format.includes("letsgo")&&(this.curTeam.dex=Dex.mod("gen7letsgo")),this.curTeam.format.includes("bdsp")&&(this.curTeam.dex=Dex.mod("gen8bdsp")),Storage.activeSetList=this.curSetList)},blur:function(){this.saveFlag&&(this.saveFlag=!1,app.user.trigger("saveteams"))},events:{"change input.teamnameedit":"teamNameChange","click button.formatselect":"selectFormat","change input[name=nickname]":"nicknameChange","change .detailsform input":"detailsChange","change .detailsform select":"detailsChange","submit .detailsform":"detailsChange","click .changeform":"altForm","click .altform":"altForm","keyup .statform input.numform":"statChange","input .statform input[type=number].numform":"statChange","change select[name=nature]":"natureChange","change select[name=ivspread]":"ivSpreadChange","change .evslider":"statSlided","input .evslider":"statSlide","click .utilichart a":"chartClick","keydown .chartinput":"chartKeydown","keyup .chartinput":"chartKeyup","focus .chartinput":"chartFocus","blur .chartinput":"chartChange","keyup .searchinput":"searchChange","click .team":"edit","click .selectFolder":"selectFolder","mouseover .team":"mouseOverTeam","mouseout .team":"mouseOutTeam","dragstart .team":"dragStartTeam","dragend .team":"dragEndTeam","dragenter .team":"dragEnterTeam","dragenter .folder .selectFolder":"dragEnterFolder","dragleave .folder .selectFolder":"dragLeaveFolder","dragexit .folder .selectFolder":"dragExitFolder","click .teambuilder-clipboard-data .result":"clipboardResultSelect","click .teambuilder-clipboard-data":"clipboardExpand","blur .teambuilder-clipboard-data":"clipboardShrink"},dispatchClick:function(e){e.preventDefault(),e.stopPropagation(),this[e.currentTarget.value]&&this[e.currentTarget.value](e)},back:function(){if(this.exportMode)this.curTeam&&(this.curTeam.team=Storage.packTeam(this.curSetList),Storage.saveTeam(this.curTeam)),this.exportMode=!1;else if(this.curSet)this.curSet=null,Storage.saveTeam(this.curTeam);else{if(!this.curTeam)return;this.curTeam.team=Storage.packTeam(this.curSetList),this.curTeam.iconCache="";var e=this.curTeam;this.curTeam=null,Storage.activeSetList=this.curSetList=null,Storage.saveTeam(e)}app.user.trigger("saveteams"),this.update()},curTeam:null,curTeamLoc:0,curSet:null,curSetLoc:0,curFolder:"",curFolderKeep:"",curSearchVal:"",exportMode:!1,update:function(){return o=Storage.teams,this.curTeam?(this.ignoreEVLimits=this.curTeam.gen<3||this.curTeam.format.includes("hackmons")&&6!==this.curTeam.gen||"gen8metronomebattle"===this.curTeam.format,this.curSet?this.updateSetView():this.updateTeamView()):this.updateTeamInterface()},deletedTeam:null,deletedTeamLoc:-1,updateTeamInterface:function(){this.deletedSet=null,this.deletedSetLoc=-1;var e="";this.exportMode?(this.curFolder?(e='<div class="pad"><button name="back"><i class="fa fa-chevron-left"></i> List</button></div>',e+='<div class="teamedit"><textarea readonly class="textbox" rows="17">'+BattleLog.escapeHTML(Storage.exportFolder(this.curFolder))+"</textarea></div>"):(e='<div class="pad"><button name="back"><i class="fa fa-chevron-left"></i> List</button> <button name="saveBackup" class="savebutton"><i class="fa fa-floppy-o"></i> Save</button></div>',e+='<div class="teamedit"><textarea class="textbox" rows="17">',350<Storage.teams.length?e+=BattleLog.escapeHTML(Storage.getPackedTeams()):e+=BattleLog.escapeHTML(Storage.exportAllTeams()),e+="</textarea></div>"),this.$el.html(e),this.$(".teamedit textarea").focus().select()):Storage.whenTeamsLoaded.isLoaded?(e='<div class="folderpane">',this.$el.html(e=(e+="</div>")+'<div class="teampane">'+"</div>"),this.updateFolderList(),this.updateTeamList()):("stalled"===Storage.whenTeamsLoaded.error?e='<div class="pad"><p class="message-error">We\'re having some trouble loading teams securely.</p><p>This is sometimes caused by antiviruses like Avast and BitDefender.</p><p><strong>If you\'re using Firefox and an antivirus:</strong> Your antivirus is trying to scan your teams, and a recent Firefox update doesn\'t let it. Turn off HTTPS scanning in your antivirus or uninstall your antivirus, and your teams will come back.</p><p>You can use the teambuilder insecurely, but any teams you\'ve saved securely won\'t be there.</p><p><button class="button" name="insecureUse">Use teambuilder insecurely</button></p></div>':Storage.whenTeamsLoaded.error?(e='<div class="pad"><p class="message-error">We got an error trying to load teams: '+Storage.whenTeamsLoaded.error.message+".</p>",e+="<p>This might be because you didn't give us permission to load teams: on macOS, this is in System Preferences → Security &amp; Privacy → Privacy → Files and Folders → Pokemon Showdown</p></div>"):(e='<div class="pad"><p>lol zarel this is a horrible teambuilder</p>',e+="<p>that's because we're not done loading it...</p></div>"),this.$el.html(e))},insecureUse:function(){Storage.whenTeamsLoaded.load(),this.updateTeamInterface()},updateFolderList:function(){var e,t='<div class="folderlist"><div class="folderlistbefore"></div>',a=(t+='<div class="folder'+(this.curFolder?'">':' cur"><div class="folderhack3"><div class="folderhack1"></div><div class="folderhack2"></div>')+'<div class="selectFolder" data-value="all"><em>(all)</em></div></div>'+(this.curFolder?"":"</div>"),{}),s=[];if(Storage.teams)for(var i=-2;i<Storage.teams.length;i++)if(0<=i&&(!(e=Storage.teams[i].folder)||e+"/"in a||(s.push("Z"+e),a[e+"/"]=1,"/"in a||(s.push("Z~"),a["/"]=1))),(l=-2===i?this.curFolderKeep:-1===i?this.curFolder:(l=Storage.teams[i].format)||"gen8")&&!(l in a))if(a[l]=1,"/"===l.slice(-1))s.push("Z"+(l.slice(0,-1)||"~")),"/"in a||(s.push("Z~"),a["/"]=1);else if("gen8"===l)s.push("B~");else{switch(l.slice(0,4)){case"gen1":l="I"+l.slice(4);break;case"gen2":l="H"+l.slice(4);break;case"gen3":l="G"+l.slice(4);break;case"gen4":l="F"+l.slice(4);break;case"gen5":l="E"+l.slice(4);break;case"gen6":l="D"+l.slice(4);break;case"gen7":l="C"+l.slice(4);break;case"gen8":l="B"+l.slice(4);break;case"gen9":l="A"+l.slice(4);break;default:l="X"+l}s.push(l)}s.sort();var r="",o='<div class="foldersep"></div>';o+='<div class="folder"><div class="selectFolder" data-value="+"><i class="fa fa-plus"></i><em>(add format folder)</em></div></div>';for(var l,n,c,i=0;i<s.length;i++){switch((l=s[i]).charAt(0)){case"I":n="1";break;case"H":n="2";break;case"G":n="3";break;case"F":n="4";break;case"E":n="5";break;case"D":n="6";break;case"C":n="7";break;case"B":n="8";break;case"A":n="9";break;case"X":n="X";break;case"Z":n="/"}r!==n&&("/"===(r=n)?(t+=o,o="",t+='<div class="foldersep"></div><div class="folder"><h3>Folders</h3></div>'):t+="X"===r?'<div class="folder"><h3>???</h3></div>':'<div class="folder"><h3>Gen '+r+"</h3></div>"),"/"===r?(l=(c=l.slice(1))+"/","~"===c?(c="(uncategorized)",l="/"):c=BattleLog.escapeHTML(c),t+='<div class="folder'+(this.curFolder===l?' cur"><div class="folderhack3"><div class="folderhack1"></div><div class="folderhack2"></div>':'">')+'<div class="selectFolder" data-value="'+l+'"><i class="fa '+(this.curFolder===l?"fa-folder-open":"fa-folder")+("/"===l?"-o":"")+'"></i>'+c+"</div></div>"+(this.curFolder===l?"</div>":"")):(4===(l="gen"+n+(c="~"===(c=l.slice(1))?"":c)).length&&(c="(uncategorized)"),t+='<div class="folder'+(this.curFolder===l?' cur"><div class="folderhack3"><div class="folderhack1"></div><div class="folderhack2"></div>':'">')+'<div class="selectFolder" data-value="'+l+'"><i class="fa '+(this.curFolder===l?"fa-folder-open-o":"fa-folder-o")+'"></i>'+c+"</div></div>"+(this.curFolder===l?"</div>":""))}t=t+o+'<div class="foldersep"></div><div class="folder"><div class="selectFolder" data-value="++"><i class="fa fa-plus"></i><em>(add folder)</em></div></div><div class="folderlistafter"></div></div>',this.$(".folderpane").html(t)},updateTeamList:function(e){var t,a,s=Storage.teams,i="",r=(i+=this.clipboardHTML(),""),o=(this.curFolder?"/"===this.curFolder.slice(-1)?i+=(t=this.curFolder.slice(0,-1))?'<h2><i class="fa fa-folder-open"></i> '+t+' <button class="button small" style="margin-left:5px" name="renameFolder"><i class="fa fa-pencil"></i> Rename</button> <button class="button small" style="margin-left:5px" name="promptDeleteFolder"><i class="fa fa-times"></i> Remove</button></h2>':'<h2><i class="fa fa-folder-open-o"></i> Teams not in any folders</h2>':i+='<h2><i class="fa fa-folder-open-o"></i> '+(r=this.curFolder)+' <small style="font-weight: normal">('+s.filter(function(e){return e.format===r}).length+")</small></h2>":i=(i+="<h2>Hi</h2><p>Did you have a good day?</p>")+'<p><button class="button" name="greeting" value="Y"><i class="fa fa-smile-o"></i> Yes, my day was pretty good</button> <button class="button" name="greeting" value="N"><i class="fa fa-frown-o"></i> No, it wasn\'t great</button></p><h2>All teams <small style="font-weight: normal">('+s.length+")</small></h2>","New Team"),l=(t&&(o="New Team in folder"),i=i+('<p><button name="newTop" value="team" class="button big"><i class="fa fa-plus-circle"></i> '+(o=r&&"gen8"!==r?"New "+BattleLog.escapeFormat(r)+" Team":o)+'</button> <button name="newTop" value="box" class="button big"><i class="fa fa-archive"></i> New Box</button> <input type="text" id="teamSearchBar" name="search" class="textbox searchinput" value="'+this.curSearchVal+'" placeholder="search teams"/></p>')+'<ul class="teamlist">',!1);try{window.localStorage||window.nodewebkit||(i+="<li>== CAN'T SAVE ==<br /><small>Your browser doesn't support <code>localStorage</code> and can't save teams! Update to a newer browser.</small></li>")}catch(e){i+="<li>== CAN'T SAVE ==<br /><small><code>Cookies</code> are disabled so you can't save teams! Enable them in your browser settings.</small></li>"}if(Storage.cantSave&&(i+="<li>== CAN'T SAVE ==<br /><small>You hit your browser's limit for team storage! Please backup them and delete some of them. Your teams won't be saved until you're under the limit again.</small></li>"),s.length){for(var n=0;n<s.length+1&&(n===this.deletedTeamLoc&&(l=l||!0,i+='<li><button name="undoDelete"><i class="fa fa-undo"></i> Undo Delete</button></li>'),!(n>=s.length));n++){var c=s[n];if(c=c&&!c.team&&""!==c.team?null:c){if(!(r&&r!==(c.format||"gen8")||void 0!==t&&t!==c.folder)){if(this.curSearchVal){var u=c.team.split("]").map(function(e){return toID(PSUtils.splitFirst(e,"|")[0])});if(!this.curSearchVal.split(",").map(function(e){return toID(e)}).every(function(e){return-1<c.team.indexOf(e)||u.includes(e)}))continue}var l=l||!0,d="";c.format&&(d="["+c.format+"] "),c.folder&&(d+=c.folder+"/"),i+='<li><div name="edit" data-value="'+n+'" class="team',24===c.capacity&&(i+=" pc-box"),6<c.capacity&&c.capacity<=12&&(i+=" doublesize"),i=(i+='" draggable="true">'+d+"<strong>"+BattleLog.escapeHTML(c.name)+"</strong><br /><small>")+Storage.getTeamIcons(c)+('</small></div><button name="edit" value="'+n+'"><i class="fa fa-pencil" aria-label="Edit" title="Edit (you can also just click on the team)"></i></button><button name="duplicate" value="'+n+'" title="Duplicate" aria-label="Duplicate"><i class="fa fa-clone"></i></button><button name="delete" value="'+n+'"><i class="fa fa-trash"></i> Delete</button></li>')}}else i+="<li>Error: A corrupted team was dropped</li>",s.splice(n,1),n--,this.deletedTeamLoc&&this.deletedTeamLoc>n&&this.deletedTeamLoc--}l||(i+=t?"<li><p><em>you don't have any teams in this folder lol</em></p></li>":"<li><p><em>you don't have any "+this.curFolder+" teams lol</em></p></li>")}else 0<=this.deletedTeamLoc&&(i+='<li><button name="undoDelete"><i class="fa fa-undo"></i> Undo Delete</button></li>'),i+="<li><p><em>you don't have any teams lol</em></p></li>";i+="</ul>",l&&(i+='<p><button name="new" value="team" class="button"><i class="fa fa-plus-circle"></i> '+o+'</button> <button name="new" value="box" class="button"><i class="fa fa-archive"></i> New Box</button></p>'),window.nodewebkit?i+='<button name="revealFolder" class="button"><i class="fa fa-folder-open"></i> Reveal teams folder</button> <button name="reloadTeamsFolder" class="button"><i class="fa fa-refresh"></i> Reload teams files</button> <button name="backup" class="button"><i class="fa fa-upload"></i> Backup/Restore all teams</button>':this.curFolder?i+='<button name="backup" class="button"><i class="fa fa-upload"></i> Backup all teams from this folder</button>':l?(i+='<p><strong>Clearing your cookies (specifically, <code>localStorage</code>) will delete your teams.</strong> <span class="storage-warning">Browsers sometimes randomly clear cookies - you should back up your teams or use the desktop client if you want to make sure you don\'t lose them.</span></p><button name="backup" class="button"><i class="fa fa-upload"></i> Backup/Restore all teams</button><p>If you want to clear your cookies or <code>localStorage</code>, you can use the Backup/Restore feature to save your teams as text first.</p>',a=this,navigator.storage&&navigator.storage.persisted&&navigator.storage.persisted().then(function(e){a.updatePersistence(e)})):i+='<button name="backup" class="button"><i class="fa fa-upload"></i> Restore teams from backup</button>';var o=this.$(".teampane"),o=(o.html(i),e?o.scrollTop(0):this.teamScrollPos&&(o.scrollTop(this.teamScrollPos),this.teamScrollPos=0),this.$("#teamSearchBar")),p=o.val().length;p&&(o.focus(),o[0].setSelectionRange(p,p))},updatePersistence:function(e){e&&this.$(".storage-warning").html("")},greeting:function(e,t){var a="<p><strong>"+u(t).html()+"</p></strong>";u(t).parent().replaceWith(a)},background:function(){app.addPopup(CustomBackgroundPopup)},selectFolder:function(e){if(e&&e.currentTarget){var t,a=e;if(e=u(a.currentTarget).data("value"),a.preventDefault(),"+"===e)return a.stopImmediatePropagation(),t=this,void app.addPopup(FormatPopup,{format:"",sourceEl:a.currentTarget,selectType:"teambuilder",onselect:function(e){t.selectFolder(e)}});if("++"===e)return a.stopImmediatePropagation(),t=this,void app.addPopup(PromptPopup,{message:"Folder name:",button:"Create folder",sourceEl:a.currentTarget,callback:function(e){(0<=(e=u.trim(e)).indexOf("/")||0<=e.indexOf("\\"))&&(app.addPopupMessage("Names can't contain slashes, since they're used as a folder separator."),e=e.replace(/[\\\/]/g,"")),e&&t.selectFolder(e+"/")}})}else this.curFolderKeep=e;this.curFolder="all"===e?"":e,this.updateFolderList(),this.updateTeamList(!0)},renameFolder:function(){var s,i;this.curFolder&&"/"===this.curFolder.slice(-1)&&(s=this.curFolder.slice(0,-1),i=this,app.addPopup(PromptPopup,{message:"Folder name:",button:"Rename folder",value:s,callback:function(e){if((0<=(e=u.trim(e)).indexOf("/")||0<=e.indexOf("\\"))&&(app.addPopupMessage("Names can't contain slashes, since they're used as a folder separator."),e=e.replace(/[\\\/]/g,"")),e&&e!==s){for(var t=0;t<Storage.teams.length;t++){var a=Storage.teams[t];a.folder===s&&(a.folder=e,window.nodewebkit&&Storage.saveTeam(a))}window.nodewebkit||Storage.saveTeams(),i.selectFolder(e+"/")}}}))},promptDeleteFolder:function(){app.addPopup(e,{folder:this.curFolder,room:this})},deleteFolder:function(e,t){if("/"===e.slice(-1)){var a=e.slice(0,-1);this.curFolderKeep===a&&(this.curFolderKeep="");for(var s=0;s<Storage.teams.length;s++){var i=Storage.teams[s];i.folder===a&&(i.folder="",t&&(i.name=a+" "+i.name),window.nodewebkit&&Storage.saveTeam(i))}window.nodewebkit||Storage.saveTeams(),this.selectFolder("/")}},show:function(){Room.prototype.show.apply(this,arguments);var e=this.$(".teamwrapper"),t=u(window).width();e.length&&(t<640?(e.css("transform","scale("+t/640+")"),e.addClass("scaled")):(e.css("transform","none"),e.removeClass("scaled")))},revealFolder:function(){Storage.revealFolder()},reloadTeamsFolder:function(){Storage.nwLoadTeams()},edit:function(e){this.teamScrollPos=this.$(".teampane").scrollTop(),e&&e.currentTarget&&(e=u(e.currentTarget).data("value")),this.curTeam=o[e=+e],this.curTeam.iconCache="!",this.curTeam.gen=this.getGen(this.curTeam.format),this.curTeam.dex=Dex.forGen(this.curTeam.gen),this.curTeam.format.includes("letsgo")&&(this.curTeam.dex=Dex.mod("gen7letsgo")),this.curTeam.format.includes("bdsp")&&(this.curTeam.dex=Dex.mod("gen8bdsp")),Storage.activeSetList=this.curSetList=Storage.unpackTeam(this.curTeam.team),this.curTeamIndex=e,this.update()},delete:function(e){for(var t in this.deletedTeamLoc=e=+e,this.deletedTeam=o.splice(e,1)[0],app.rooms){var a=app.rooms[t].$("button.teamselect").val();a&&"random"!==a&&(e<(a=""===app.rooms[t].id?app.rooms[t]:app.rooms[t].tournamentBox).curTeamIndex?a.curTeamIndex--:e===a.curTeamIndex&&(a.curTeamIndex=-1))}Storage.deleteTeam(this.deletedTeam),app.user.trigger("saveteams"),this.updateTeamList()},undoDelete:function(){if(0<=this.deletedTeamLoc){for(var e in o.splice(this.deletedTeamLoc,0,this.deletedTeam),app.rooms){var t=app.rooms[e].$("button.teamselect").val();t&&"random"!==t&&(t=""===app.rooms[e].id?app.rooms[e]:app.rooms[e].tournamentBox,this.deletedTeamLoc<t.curTeamIndex+1?t.curTeamIndex++:-1===t.curTeamIndex&&(t.curTeamIndex=this.deletedTeamLoc))}var a=this.deletedTeam;this.deletedTeam=null,this.deletedTeamLoc=-1,Storage.saveTeam(a),app.user.trigger("saveteams"),this.update()}},saveBackup:function(){for(var e in Storage.deleteAllTeams(),Storage.importTeam(this.$(".teamedit textarea").val(),!0),o=Storage.teams,Storage.saveAllTeams(),app.rooms){var t=app.rooms[e].$("button.teamselect").val();t&&"random"!==t&&((""===app.rooms[e].id?app.rooms[e]:app.rooms[e].tournamentBox).curTeamIndex=0)}this.back()},new:function(e){var t=this.createTeam(null,"box"===e);o.push(t),this.edit(o.length-1)},newTop:function(e){var t,a=this.createTeam(null,"box"===e);for(t in o.unshift(a),app.rooms){var s=app.rooms[t].$("button.teamselect").val();s&&"random"!==s&&(""===app.rooms[t].id?app.rooms[t]:app.rooms[t].tournamentBox).curTeamIndex++}this.edit(0)},duplicate:function(e){var t,a=this.createTeam(e?o[e]:null);for(t in o.unshift(a),app.rooms){var s=app.rooms[t].$("button.teamselect").val();s&&"random"!==s&&(""===app.rooms[t].id?app.rooms[t]:app.rooms[t].tournamentBox).curTeamIndex++}this.edit(0)},createTeam:function(e,t){var a,s,i,r=e?{name:"Copy of "+e.name,format:e.format,team:e.team,capacity:e.capacity,folder:e.folder,iconCache:""}:(a="",(r=this.curFolder||"gen8")&&"/"===r.charAt(r.length-1)&&(a=r.slice(0,-1),r="gen8"),s=t?24:6,r&&(r.includes("bring9")||r.includes("b9c"))?s=9:r&&(r.includes("bring8")||r.includes("b8c"))&&(s=8),{name:(t?"Box ":"Untitled ")+(o.length+1),format:r,team:"",capacity:s,folder:a,iconCache:""});return navigator.storage&&navigator.storage.persist&&!/ OPR\/4[0-5]/.test(navigator.userAgent)&&(i=this,navigator.storage.persist().then(function(e){i.updatePersistence(e)})),r},import:function(){if(this.exportMode)return this.back();this.exportMode=!0,this.curTeam?this.update():this.new()},backup:function(){this.curTeam=null,this.curSetList=null,this.exportMode=!0,this.update()},pokepasteExport:function(){var e=Storage.exportTeam(this.curSetList);if(!e)return app.addPopupMessage("Add a Pokémon to your team before uploading it!");document.getElementById("pasteData").value=e,document.getElementById("pasteTitle").value=this.curTeam.name,document.getElementById("pasteAuthor").value=app.user.get("name"),"gen8"!==this.curTeam.format&&(document.getElementById("pasteNotes").value="Format: "+this.curTeam.format),document.getElementById("pokepasteForm").submit()},mouseOverTeam:function(e){e.currentTarget.className.endsWith("team-hover")||(e.currentTarget.className+=" team-hover")},mouseOutTeam:function(e){e.currentTarget.className.endsWith("team-hover")&&(e.currentTarget.className=e.currentTarget.className.slice(0,-11))},dragStartTeam:function(e){var t=e.originalEvent.dataTransfer,a=(t.effectAllowed="copyMove",t.setData("text/plain","Team "+e.currentTarget.dataset.value),Storage.teams[e.currentTarget.dataset.value]),s=a.name,i=(a.format&&(s="["+a.format+"] "+s),s=u.trim(s).replace(/[\\\/]+/g,"")+".txt","data:text/plain;base64,"),a=("https:"===document.location.protocol&&(i="https://"+Config.routes.client+"/action.php?act=dlteam&team="),Storage.exportTeam(a.team).replace(/\n/g,"\r\n")),s="text/plain:"+s+":"+i+encodeURIComponent(window.btoa(unescape(encodeURIComponent(a)))),i=(console.log(s),t.setData("DownloadURL",s),app.dragging=e.currentTarget,app.draggingRoom=this.id,app.draggingLoc=parseInt(e.currentTarget.dataset.value,10),u(e.currentTarget).offset());app.draggingOffsetX=e.originalEvent.pageX-i.left,app.draggingOffsetY=e.originalEvent.pageY-i.top,this.finalOffset=null,setTimeout(function(){u(e.currentTarget).parent().addClass("dragging")},0)},dragEndTeam:function(e){this.finishDrop()},finishDrop:function(){var e=app.dragging,t=(app.dragging=null,parseInt(e.dataset.value,10));if(isNaN(t))throw new Error("drag failed");var a,s,i,r=Math.floor(app.draggingLoc),o=(app.draggingLoc<t&&(r+=1),Storage.teams[t]),l=!1;if(r!==t){for(var n in Storage.teams.splice(t,1),Storage.teams.splice(r,0,o),app.rooms){var c=app.rooms[n].$("button.teamselect").val();c&&"random"!==c&&(t===(c=""===app.rooms[n].id?app.rooms[n]:app.rooms[n].tournamentBox).curTeamIndex?c.curTeamIndex=r:t>c.curTeamIndex&&r<=c.curTeamIndex?c.curTeamIndex++:t<c.curTeamIndex&&r>=c.curTeamIndex&&c.curTeamIndex--)}l=!0}this.$(".teamlist").css("pointer-events","none"),u(e).parent().removeClass("dragging"),app.draggingFolder&&(e=u(app.draggingFolder),app.draggingFolder=null,a=e.find(".plusonefolder"),e.removeClass("active"),a.length?(i=Number(a.text().substr(1))+1,a.text("+"+i)):e.prepend('<strong style="float:right;margin-right:3px;padding:0 2px;border-radius:3px;background:#CC8500;color:white" class="plusonefolder">+1</strong>'),"/"===(a=e.data("value")).slice(-1)?o.folder=a.slice(0,-1):o.format=a,l=!0),this.updateTeamList(),l&&(Storage.saveTeam(o),app.user.trigger("saveteams")),this.finalOffset&&(s=this.$(".team[data-value="+r+"]")).length&&(i=s.offset(),s.css("transform","translate("+(this.finalOffset[0]-i.left)+"px, "+(this.finalOffset[1]-i.top)+"px)"),setTimeout(function(){s.css("transition","transform 0.15s"),s.css("-webkit-transition","-webkit-transform 0.15s"),s.css("transform","translate(0px, 0px)")}))},dragEnterTeam:function(e){var t,a;app.dragging&&(t=u(app.dragging).parent(),this.dragLeaveFolder(),e.currentTarget===app.dragging?e.preventDefault():(a=parseInt(e.currentTarget.dataset.value,10),app.draggingLoc>a?(u(e.currentTarget).parent().before(t),app.draggingLoc=parseInt(e.currentTarget.dataset.value,10)-.5):(u(e.currentTarget).parent().after(t),app.draggingLoc=parseInt(e.currentTarget.dataset.value,10)+.5)))},dragEnterFolder:function(e){var t;app.dragging&&(this.dragLeaveFolder(),e.currentTarget===app.draggingFolder||"+"===(t=e.currentTarget.dataset.value)||"++"===t||"all"===t||t===this.curFolder||parseInt(app.dragging.dataset.value,10)>=Storage.teams.length&&"/"!==t.slice(-1)||(app.draggingFolder=e.currentTarget,u(app.draggingFolder).addClass("active"),u(app.dragging).parent().hide()))},dragLeaveFolder:function(e){e&&e.currentTarget!==app.draggingFolder||app.dragging&&app.draggingFolder&&(u(app.draggingFolder).removeClass("active"),app.draggingFolder=null,u(app.dragging).parent().show())},defaultDragEnterTeam:function(e){var t=e.originalEvent.dataTransfer;!t||t.types.indexOf&&-1===t.types.indexOf("Files")||t.types.contains&&!t.types.contains("Files")||t.files[0]&&".txt"!==t.files[0].name.slice(-4)||(app.curFolder&&"/"!==app.curFolder.slice(-1)&&this.selectFolder("all"),this.$(".teamlist").append('<li class="dragging"><div class="team" data-value="'+Storage.teams.length+'"></div></li>'),app.dragging=this.$(".dragging .team")[0],app.draggingRoom=this.id,app.draggingLoc=Storage.teams.length,app.draggingOffsetX=180,app.draggingOffsetY=25)},defaultDropTeam:function(e){if(e.originalEvent.dataTransfer.files&&e.originalEvent.dataTransfer.files[0]){var o=e.originalEvent.dataTransfer.files[0];if(".txt"!==o.name.slice(-4))return app.dragging=null,this.updateTeamList(),void app.addPopupMessage("Your file is not a valid team. Team files are .txt files.");var t=new FileReader,l=this;t.onload=function(e){var t;try{t=Storage.packTeam(Storage.importTeam(e.target.result))}catch(e){return app.addPopupMessage("Your file is not a valid team."),void l.updateTeamList()}var a=o.name,s="",i=(a=".txt"===a.slice(a.length-4).toLowerCase()?a.substr(0,a.length-4):a).indexOf("]"),r=6;0<=i&&((s=(s=a.substr(1,i-1))&&"gen"!==s.slice(0,3)?"gen6"+s:s)&&(s.includes("bring9")||s.includes("b9c"))?r=9:s&&(s.includes("bring8")||s.includes("b8c"))&&(r=8),s&&s.endsWith("-box")&&(s=s.slice(0,-4),r=24),a=u.trim(a.substr(i+1))),Storage.teams.push({name:a,format:s,team:t,capacity:r,folder:"",iconCache:""}),l.finishDrop()},t.readAsText(o)}this.finalOffset=[e.originalEvent.pageX-app.draggingOffsetX,e.originalEvent.pageY-app.draggingOffsetY]},updateTeamView:function(){this.curChartName="";var e,t=this.curChartType="";if(this.exportMode)t='<div class="pad"><button name="back"><i class="fa fa-chevron-left"></i> List</button> <input class="textbox teamnameedit" type="text" class="teamnameedit" size="30" value="'+BattleLog.escapeHTML(this.curTeam.name)+'" /> <button name="saveImport"><i class="fa fa-upload"></i> Import/Export</button> <button name="saveImport" class="savebutton"><i class="fa fa-floppy-o"></i> Save</button></div>',t+='<div class="teamedit"><textarea class="textbox" rows="17">'+BattleLog.escapeHTML(Storage.exportTeam(this.curSetList))+"</textarea></div>";else{t=(t=(t=(t='<div class="pad"><button name="back"><i class="fa fa-chevron-left"></i> List</button> ')+('<input class="textbox teamnameedit" type="text" class="teamnameedit" size="30" value="'+BattleLog.escapeHTML(this.curTeam.name)+'" /> ')+'<button name="import"><i class="fa fa-upload"></i> Import/Export</button> ')+'<div class="teamchartbox">'+'<ol class="teamchart">')+("<li>"+this.clipboardHTML()+"</li>");var a=0;this.curSetList.length&&!this.curSetList[this.curSetList.length-1].species&&this.curSetList.splice(this.curSetList.length-1,1);for(s.BattleFormats&&(t=(t=(t+='<li class="format-select">')+'<label class="label">Format:</label><button class="select formatselect teambuilderformatselect" name="format" value="'+this.curTeam.format+'">'+((e=this.curTeam.format)&&!/^gen\d+$/.test(e)?BattleLog.escapeFormat(this.curTeam.format):"<em>Select a format</em>")+"</button>")+' <button name="validate" class="'+("button"+(!this.curSetList.length||app.isDisconnected?" disabled":""))+'"><i class="fa fa-check"></i> Validate</button></li>'),this.curSetList.length||(t+="<li><em>you have no pokemon lol</em></li>"),a=0;a<this.curSetList.length;a++)this.curSetList.length<this.curTeam.capacity&&this.deletedSet&&a===this.deletedSetLoc&&(t+='<li><button name="undeleteSet"><i class="fa fa-undo"></i> Undo Delete</button></li>'),t+=this.renderSet(this.curSetList[a],a);this.deletedSet&&a===this.deletedSetLoc&&(t+='<li><button name="undeleteSet"><i class="fa fa-undo"></i> Undo Delete</button></li>'),0===a&&(t+='<li><button name="import" class="button big"><i class="fa fa-upload"></i> Import from text or URL</button></li>'),a<this.curTeam.capacity&&(t+='<li><button name="addPokemon" class="button big"><i class="fa fa-plus"></i> Add Pok&eacute;mon</button></li>'),t=(t=(t=(t=t+"</ol>"+'<form id="pokepasteForm" style="display:inline" method="post" action="https://pokepast.es/create" target="_blank">')+'<input type="hidden" name="title" id="pasteTitle">'+'<input type="hidden" name="paste" id="pasteData">')+'<input type="hidden" name="author" id="pasteAuthor">'+'<input type="hidden" name="notes" id="pasteNotes">')+'<button name="pokepasteExport" type="submit" class="button exportbutton"><i class="fa fa-upload"></i> Upload to PokePaste</button></form>'+"</div>"}this.$el.html('<div class="teamwrapper">'+t+"</div>"),this.$(".teamedit textarea").focus().select(),u(window).width()<640&&this.show()},renderSet:function(e,t){var a=this.curTeam.dex.species.get(e.species),s=this.curTeam.format.includes("letsgo"),i=this.curTeam.format.includes("bdsp"),r=this.curTeam.format.includes("nationaldex"),o=this.curTeam.format.includes("supernat"),l='<li value="'+t+'">';if(!e.species)return this.deletedSet&&(l+='<div class="setmenu setmenu-left"><button name="undeleteSet"><i class="fa fa-undo"></i> Undo Delete</button></div>'),l=(l+='<div class="setmenu"><button name="importSet"><i class="fa fa-upload"></i>Import</button></div>')+('<div class="setchart" style="background-image:url('+Dex.resourcePrefix+'sprites/gen5/0.png);"><div class="setcol setcol-icon"><div class="setcell-sprite"></div><div class="setcell setcell-pokemon"><label>Pok&eacute;mon</label><input type="text" name="pokemon" class="textbox chartinput" value="" autocomplete="off" /></div></div></div>')+"</li>";l=(l=(l+='<div class="setmenu"><button name="copySet"><i class="fa fa-files-o"></i>Copy</button> <button name="importSet"><i class="fa fa-upload"></i>Import/Export</button> <button name="moveSet"><i class="fa fa-arrows"></i>Move</button> <button name="deleteSet"><i class="fa fa-trash"></i>Delete</button></div><div class="setchart-nickname">')+'<label>Nickname</label><input type="text" name="nickname" class="textbox" value="'+BattleLog.escapeHTML(e.name||"")+'" placeholder="'+BattleLog.escapeHTML(a.baseSpecies)+'" /></div>')+'<div class="setchart" style="'+Dex.getTeambuilderSprite(e,this.curTeam.gen)+';"><div class="setcol setcol-icon">',a.cosmeticFormes?l+='<div class="setcell-sprite changeform"><i class="fa fa-caret-down"></i></div>':l+='<div class="setcell-sprite"></div>';l=(l=l+('<div class="setcell setcell-pokemon"><label>Pok&eacute;mon</label><input type="text" name="pokemon" class="textbox chartinput" value="'+BattleLog.escapeHTML(e.species))+'" autocomplete="off" /></div></div><div class="setcol setcol-details"><div class="setrow">')+'<div class="setcell setcell-details"><label>Details</label><button class="textbox setdetails" tabindex="-1" name="details"><span class="detailcell detailcell-first"><label>Level</label>'+(e.level||100)+"</span>",1<this.curTeam.gen&&(l+='<span class="detailcell"><label>Gender</label>'+{M:"Male",F:"Female",N:"&mdash;"}[e.gender||a.gender||"N"]+"</span>",s?l+='<span class="detailcell"><label>Happiness</label>'+("number"==typeof e.happiness?e.happiness:70)+"</span>":(this.curTeam.gen<8||r)&&(l+='<span class="detailcell"><label>Happiness</label>'+("number"==typeof e.happiness?e.happiness:255)+"</span>"),l+='<span class="detailcell"><label>Shiny</label>'+(e.shiny?"Yes":"No")+"</span>",s||(8!==this.curTeam.gen||r?l+=o?'<span class="detailcell"><label>Tera Type</label>'+(e.hpType||"Dark")+"</span>":'<span class="detailcell"><label>HP Type</label>'+(e.hpType||"Dark")+"</span>":i&&"Unown"===a.baseSpecies&&(l+='<span class="detailcell"><label>HP Type</label>'+(e.hpType||"Dark")+"</span>")),8!==this.curTeam.gen||i||!a.canGigantamax&&"Gmax"!==a.forme||(l+='<span class="detailcell"><label>Gmax</label>'+(e.gigantamax||"Gmax"===a.forme?"Yes":"No")+"</span>")),l+='</button></div></div><div class="setrow setrow-icons"><div class="setcell">';var r='<span class="itemicon"></span>',n=(e.item&&(o=this.curTeam.dex.items.get(e.item),r='<span class="itemicon" style="'+Dex.getItemIcon(o)+'"></span>'),l=(l+=r)+"</div>"+'<div class="setcell setcell-typeicons">',a.types);if(n)for(t=0;t<n.length;t++)l+=Dex.getTypeIcon(n[t]);l+='</div></div><div class="setrow">',1<this.curTeam.gen&&(l+='<div class="setcell setcell-item"><label>Item</label><input type="text" name="item" class="textbox chartinput" value="'+BattleLog.escapeHTML(e.item)+'" autocomplete="off" /></div>'),2<this.curTeam.gen&&!s&&(l+='<div class="setcell setcell-ability"><label>Ability</label><input type="text" name="ability" class="textbox chartinput" value="'+BattleLog.escapeHTML(e.ability)+'" autocomplete="off" /></div>'),l+="</div></div>",e.moves||(e.moves=[]);var c,u,d,p,l=(l=(l=(l=(l=(l+='<div class="setcol setcol-moves"><div class="setcell"><label>Moves</label>')+('<input type="text" name="move1" class="textbox chartinput" value="'+BattleLog.escapeHTML(e.moves[0])+'" autocomplete="off" /></div>'))+('<div class="setcell"><input type="text" name="move2" class="textbox chartinput" value="'+BattleLog.escapeHTML(e.moves[1])+'" autocomplete="off" /></div>'))+('<div class="setcell"><input type="text" name="move3" class="textbox chartinput" value="'+BattleLog.escapeHTML(e.moves[2])+'" autocomplete="off" /></div>'))+('<div class="setcell"><input type="text" name="move4" class="textbox chartinput" value="'+BattleLog.escapeHTML(e.moves[3])+'" autocomplete="off" /></div>')+"</div>")+'<div class="setcol setcol-stats"><div class="setrow"><label>Stats</label><button class="textbox setstats" name="stats">'+('<span class="statrow statrow-head"><label></label> <span class="statgraph"></span> <em>'+(s?"AV":"EV")+"</em></span>"),m={},h=2<this.curTeam.gen?0:252;for(c in BattleStatNames)"spd"===c&&1===this.curTeam.gen||(m[c]=this.getStat(c,e),u="<em>"+((u=void 0===e.evs[c]?h:e.evs[c])===h?"":u)+"</em>",BattleNatures[e.nature]&&BattleNatures[e.nature].plus===c?u+="<small>+</small>":BattleNatures[e.nature]&&BattleNatures[e.nature].minus===c&&(u+="<small>&minus;</small>"),d=75*m[c]/504,75<(d="hp"==c?75*m[c]/704:d)&&(d=75),360<(p=Math.floor(180*m[c]/714))&&(p=360),l+='<span class="statrow"><label>'+(1===this.curTeam.gen&&"spa"===c?"Spc":BattleStatNames[c])+'</label> <span class="statgraph"><span style="width:'+d+"px;background:hsl("+p+',40%,75%);"></span></span> '+u+"</span>");return l=l+"</button></div></div>"+"</div></li>"},saveImport:function(){var i,e=this.$(".teamedit textarea").val(),r=this.importableUrl(e);r?(this.$(".teamedit textarea, .teamedit .savebutton").attr("disabled",!0),i=this,u.ajax({type:"GET",url:r,success:function(e){var t,a,s;/^https?:\/\/pokepast\.es\/.*\/json\s*$/.test(r)?((a=(t=JSON.parse(e)).notes.split("\n"))[0].startsWith("Format: ")&&(s=toID(a[0].slice(8)),(s=window.BattleFormats&&window.BattleFormats[s])&&i.changeFormat(s.id),a.shift()),a.join("\n"),(s=t.title)&&!s.startsWith("Untitled")&&(s=s.replace(/[\|\\\/]/g,""),i.$(".teamnameedit").val(s).change()),Storage.activeSetList=i.curSetList=Storage.importTeam(t.paste)):Storage.activeSetList=i.curSetList=Storage.importTeam(e),i.$(".teamedit textarea, .teamedit .savebutton").attr("disabled",null),i.back()},error:function(){app.addPopupMessage("Could not fetch a team from this URL. Make sure you copied the full link, or paste the team in by hand."),i.$(".teamedit textarea, .teamedit .savebutton").attr("disabled",null)}})):(Storage.activeSetList=this.curSetList=Storage.importTeam(e),this.back())},importableUrl:function(e){var t,a=e.match(/^https?:\/\/(pokepast\.es|gist\.github(?:usercontent)?\.com)\/(.*)\s*$/);if(a)return t=a[1],a=a[2],"pokepast.es"===t?"https://pokepast.es/"+a.replace(/\/.*/,"")+"/json":(t=a.split("/")).length<2?void 0:"https://gist.githubusercontent.com/"+t[0]+"/"+t[1]+"/raw"},addPokemon:function(){if(this.curTeam){var e=this.curSetList;if(e.length&&!e[e.length-1].species||e.push({name:"",species:"",item:"",nature:"",evs:{},ivs:{},moves:[]}),this.curSet=e[e.length-1],this.curSetLoc=e.length-1,this.curChartName="",this.update(),this.$("input[name=pokemon]").select(),this.curTeam.format.includes("monotype")){for(var t=[],a=this.curTeam.dex,s=0;s<this.curSetList.length;s++){var i=this.curSetList[s],r=a.species.get(i.species);if((r=r.isMega?a.species.get(r.baseSpecies):r).exists){if(0===s)t=r.types;else if(!(t=t.filter(function(e){return r.types.includes(e)})).length)break;if(6<=this.curTeam.gen){i=a.items.get(i.item);if(i.megaStone&&r.baseSpecies===i.megaEvolves&&(r=a.species.get(i.megaStone),!(t=t.filter(function(e){return r.types.includes(e)})).length))break}}}1===t.length&&(this.search.engine.addFilter(["type",t[0]]),this.search.filters=this.search.engine.filters,this.search.find(""))}}},pastePokemon:function(e,t){var a;!this.curTeam||(a=this.curSetList).length>=this.curTeam.capacity||this.clipboardCount()&&(6<=a.push(u.extend(!0,{},this.clipboard[0]))&&u(t).css("display","none"),this.update(),this.save())},saveFlag:!1,save:function(){this.saveFlag=!0,this.curTeam?Storage.saveTeam(this.curTeam):Storage.saveTeams()},validate:function(){var e=this.curTeam.format||"gen7anythinggoes";this.curSetList.length?(window.BattleFormats&&BattleFormats[e]&&BattleFormats[e].battleFormat&&(e=BattleFormats[e].battleFormat),app.sendTeam(this.curTeam),app.send("/vtm "+e)):app.addPopupMessage("You need at least one Pokémon to validate.")},teamNameChange:function(e){var t=u.trim(e.currentTarget.value)||"Untitled "+(this.curTeamLoc+1);(0<=t.indexOf("/")||0<=t.indexOf("\\"))&&(app.addPopupMessage("Names can't contain slashes, since they're used as a folder separator."),t=t.replace(/[\\\/]/g,"")),0<=t.indexOf("|")&&(app.addPopupMessage("Names can't contain the character |, since they're used for storing teams."),t=t.replace(/\|/g,"")),this.curTeam.name=t,e.currentTarget.value=t,this.save()},format:function(e,t){var a;window.BattleFormats&&(a=this,app.addPopup(FormatPopup,{format:e,sourceEl:t,selectType:"teambuilder",onselect:function(e){a.changeFormat(e)}}))},changeFormat:function(e){this.curTeam.format=e,this.curTeam.gen=this.getGen(this.curTeam.format),this.curTeam.dex=Dex.forGen(this.curTeam.gen),this.curTeam.format.includes("letsgo")&&(this.curTeam.dex=Dex.mod("gen7letsgo")),this.curTeam.format.includes("bdsp")&&(this.curTeam.dex=Dex.mod("gen8bdsp"));var t=6;24==this.curTeam.capacity?t=24:e&&(e.includes("bring9")||e.includes("b9c"))?t=9:e&&(e.includes("bring8")||e.includes("b8c"))&&(t=8),this.curTeam.capacity=t,this.save(),5!==this.curTeam.gen||Dex.loadedSpriteData.bw||Dex.loadSpriteData("bw"),this.update()},nicknameChange:function(e){var t=+u(e.currentTarget).closest("li").attr("value"),t=this.curSetList[t],a=u.trim(e.currentTarget.value).replace(/\|/g,"");e.currentTarget.value=t.name=a,this.save()},clipboard:[],clipboardCount:function(){return this.clipboard.length},clipboardVisible:function(){return!!this.clipboardCount()},clipboardHTML:function(){var e=(e=(e="")+('<div class="teambuilder-clipboard-container" style="display: '+(this.clipboardVisible()?"block":"none")+';">')+'<div class="teambuilder-clipboard-title">Clipboard:</div>')+('<div class="teambuilder-clipboard-data" tabindex="-1">'+this.clipboardInnerHTML()+"</div>")+'<div class="teambuilder-clipboard-buttons">';return this.curTeam&&this.curSetList.length<this.curTeam.capacity&&(e+='<button name="pastePokemon" class="teambuilder-clipboard-button-left"><i class="fa fa-clipboard"></i> Paste!</button>'),e=(e+='<button name="clipboardRemoveAll" class="teambuilder-clipboard-button-right"><i class="fa fa-trash"></i> Clear clipboard</button>')+"</div>"+"</div>"},clipboardInnerHTMLCache:"",clipboardInnerHTML:function(){if(this.clipboardInnerHTMLCache)return this.clipboardInnerHTMLCache;for(var e="",t=0;t<this.clipboardCount();t++){for(var a=this.clipboard[t],s=Dex.species.get(a.species),e=(e=(e=(e+='<div class="result" data-id="'+t+'">')+('<div class="section"><span class="icon" style="'+Dex.getPokemonIcon(s.name)+'"></span>'))+('<span class="species">'+(s.name===s.baseSpecies?BattleLog.escapeHTML(s.name):BattleLog.escapeHTML(s.baseSpecies)+"-<small>"+BattleLog.escapeHTML(s.name.substr(s.baseSpecies.length+1))+"</small>")+"</span></div>"))+('<div class="section"><span class="ability-item">'+(BattleLog.escapeHTML(a.ability)||"<i>No ability</i>")+"<br />"+(BattleLog.escapeHTML(a.item)||"<i>No item</i>")+"</span></div>")+'<div class="section no-border">',i=0;i<4;i++)1&i||(e+='<span class="moves">'),e+=(BattleLog.escapeHTML(a.moves[i])||"<i>No move</i>")+(1&i?"":"<br />"),1&i&&(e+="</span>");e=e+"</div>"+"</div>"}return this.clipboardInnerHTMLCache=e},clipboardUpdate:function(){this.clipboardInnerHTMLCache="",u(".teambuilder-clipboard-data").html(this.clipboardInnerHTML())},clipboardExpanded:!1,clipboardExpand:function(){var e=u(".teambuilder-clipboard-data");e.animate({height:34*this.clipboardCount()},500,function(){setTimeout(function(){e.focus()},100)}),setTimeout((function(){this.clipboardExpanded=!0}).bind(this),10)},clipboardShrink:function(){u(".teambuilder-clipboard-data").animate({height:32},500),setTimeout((function(){this.clipboardExpanded=!1}).bind(this),10)},clipboardResultSelect:function(e){var t;this.clipboardExpanded&&(e.preventDefault(),e.stopPropagation(),-1==(t=+u(e.target).closest(".result").data("id"))?(this.clipboardShrink(),this.clipboardRemoveAll()):(this.clipboard.unshift(this.clipboard.splice(t,1)[0]),this.clipboardUpdate(),this.clipboardShrink()))},clipboardAdd:function(e){var t;6<this.clipboard.unshift(e)&&this.clipboard.pop(),this.clipboardUpdate(),1===this.clipboardCount()&&(t=u(".teambuilder-clipboard-container").css("opacity",0)).slideDown(250,function(){t.animate({opacity:1},250)})},clipboardRemoveAll:function(){this.clipboard=[];var e=this,t=u(".teambuilder-clipboard-container");t.animate({opacity:0},250,function(){t.slideUp(250,function(){e.clipboardUpdate()})})},copySet:function(e,t){e=+u(t).closest("li").attr("value"),this.clipboardAdd(u.extend(!0,{},this.curSetList[e])),t.blur()},wasViewingPokemon:!1,importSet:function(e,t){e=+u(t).closest("li").attr("value"),this.wasViewingPokemon=!0,this.curSet||(this.wasViewingPokemon=!1,this.selectPokemon(e)),this.$("li").find("input, button").prop("disabled",!0),this.$chart.hide(),this.$(".teambuilder-pokemon-import").show().find("textarea").val(Storage.exportTeam([this.curSet]).trim()).focus().select(),this.getSmogonSets()},getSmogonSets:function(){this.$(".teambuilder-pokemon-import .teambuilder-import-smogon-sets").empty();var t,a=this.curTeam.format;a.match(/gen\d$/)||((t=this).smogonSets=this.smogonSets||{},void 0!==this.smogonSets[a]?this.importSetButtons():u.get("https://"+Config.routes.client+"/data/sets/"+a+".json",{},function(e){try{t.smogonSets[a]=JSON.parse(e)}catch(e){t.smogonSets[a]=!1}t.importSetButtons()},"text"))},importSetButtons:function(){var e=this.smogonSets[this.curTeam.format],t=this.curSet.species,a=this.$(".teambuilder-pokemon-import .teambuilder-import-smogon-sets");if(a.empty(),e){var s,e=u.extend({},e.dex[t],e.stats[t]);for(s in a.text("Sample sets: "),e)a.append('<button name="importSmogonSet">'+BattleLog.escapeHTML(s)+"</button>");a.append(' <small>(<a target="_blank" href="'+this.smogdexLink(t)+'">Smogon&nbsp;analysis</a>)</small>')}},importSmogonSet:function(e,t){var a=this.smogonSets[this.curTeam.format],s=this.curSet.species,i=this.$(t).text(),a=a.dex[s][i]||a.stats[s][i],s=u.extend({},this.curSet,a),i=Storage.exportTeam([s]);this.$(".teambuilder-pokemon-import .pokemonedit").val(i)},closePokemonImport:function(e){var t,a;return this.wasViewingPokemon?(a=+(t=this.$("li")).attr("value"),this.$(".teambuilder-pokemon-import").hide(),this.$chart.show(),!0===e?this.selectPokemon(a):void t.find("input, button").prop("disabled",!1)):this.back()},savePokemonImport:function(e){e=+this.$("li").attr("value");var t=Storage.importTeam(this.$(".pokemonedit").val())[0];t&&(this.curSet=t,this.curSetList[e]=t),this.closePokemonImport(!0)},moveSet:function(e,t){e=+u(t).closest("li").attr("value"),app.addPopup(a,{i:e,team:this.curSetList})},deleteSet:function(e,t){e=+u(t).closest("li").attr("value"),this.deletedSetLoc=e,this.deletedSet=this.curSetList.splice(e,1)[0],this.curSet?this.addPokemon():this.update(),this.save()},undeleteSet:function(){var e;this.deletedSet&&(e=this.deletedSetLoc,this.curSetList.splice(e,0,this.deletedSet),this.deletedSet=null,this.deletedSetLoc=-1,this.save(),this.curSet?(this.curSetLoc=e,this.curSet=this.curSetList[e],this.curChartName="",this.update(),this.updateChart()):this.update())},updateSetView:function(){var e='<div class="pad">',t=(e=(e=(e=(e=(e=e+'<button name="back"><i class="fa fa-chevron-left"></i> Team</button></div>'+'<div class="teambar">')+this.renderTeambar()+"</div>")+'<div class="teamchartbox individual">'+'<ol class="teamchart">')+this.renderSet(this.curSet,this.curSetLoc))+"</ol>"+"</div>",this.chartPrevSearch="[init]",this.$el.html('<div class="teamwrapper">'+(e=(e=(e=e+'<div class="teambuilder-results"></div>'+'<div class="teambuilder-pokemon-import">')+'<div class="pokemonedit-buttons"><button name="closePokemonImport"><i class="fa fa-chevron-left"></i> Back</button> <button name="savePokemonImport"><i class="fa fa-floppy-o"></i> Save</button></div>'+'<textarea class="pokemonedit textbox" rows="14"></textarea>')+'<div class="teambuilder-import-smogon-sets"></div>'+"</div>")+"</div>"),u(window).width()<640&&this.show(),this.$chart=this.$(".teambuilder-results"),this.search=new BattleSearch(this.$chart,this.$chart),this);this.$chart.on("scroll",function(){t.curChartType in t.searchChartTypes&&t.search.updateScroll()})},updateSetTop:function(){this.$(".teambar").html(this.renderTeambar()),this.$(".teamchart").first().html(this.renderSet(this.curSet,this.curSetLoc))},renderTeambar:function(){var e="",t=!1,a=(this.curSetList.length&&!this.curSetList[this.curSetList.length-1].species&&this.curSetLoc!==this.curSetList.length-1&&this.curSetList.splice(this.curSetList.length-1,1),0),s=this.curSetList.length,i=6,r="",o=this.curTeam.format;o&&(o.includes("bring9")||o.includes("b9c"))?(i=9,r=' style="width:58px;"'):o&&(o.includes("bring8")||o.includes("b8c"))&&(i=8,r=' style="width:65px;"'),(i<s||s===i&&this.curTeam.capacity>i)&&(s=(a=s<(a=(a=this.curSetLoc-2)<0?0:a)+i-1?s-i+1:a)+i-1);for(var l=a;l<s;l++){var n=this.curSetList[l],c='<span class="picon pokemonicon-'+l+'" style="'+Dex.getPokemonIcon(n)+'"></span>';n.species?l==this.curSetLoc?e+='<button disabled="disabled"'+r+' class="pokemon">'+c+BattleLog.escapeHTML(n.name||this.curTeam.dex.species.get(n.species).baseSpecies||'<i class="fa fa-plus"></i>')+"</button> ":e+='<button name="selectPokemon" value="'+l+'"'+r+' class="pokemon">'+c+BattleLog.escapeHTML(n.name||this.curTeam.dex.species.get(n.species).baseSpecies)+"</button> ":(e+='<button disabled="disabled"'+r+' class="addpokemon" aria-label="Add Pok&eacute;mon"><i class="fa fa-plus"></i></button> ',t=!0)}return this.curSetList.length<this.curTeam.capacity&&!t&&(e+='<button name="addPokemon"'+r+'><i class="fa fa-plus"></i></button> '),e},updatePokemonSprite:function(){var e=this.curSet;e&&(this.$(".setchart").attr("style",Dex.getTeambuilderSprite(e,this.curTeam.gen)),this.$(".pokemonicon-"+this.curSetLoc).css("background",Dex.getPokemonIcon(e).substr(11)),(e=this.curTeam.dex.items.get(e.item)).id?this.$(".setcol-details .itemicon").css("background",Dex.getItemIcon(e).substr(11)):this.$(".setcol-details .itemicon").css("background","none"),this.updateStatGraph())},updateStatGraph:function(){var e=this.curSet;if(e){var t,a={hp:"",atk:"",def:"",spa:"",spd:"",spe:""},s=!this.curTeam.format.includes("letsgo"),i='<span class="statrow statrow-head"><label></label> <span class="statgraph"></span> <em>'+(s?"EV":"AV")+"</em></span>",r=2<this.curTeam.gen?0:252;for(o in a)"spd"===o&&1===this.curTeam.gen||(a[o]=this.getStat(o,e),t="<em>"+((t=void 0===e.evs[o]?r:e.evs[o])===r?"":t)+"</em>",BattleNatures[e.nature]&&BattleNatures[e.nature].plus===o?t+="<small>+</small>":BattleNatures[e.nature]&&BattleNatures[e.nature].minus===o&&(t+="<small>&minus;</small>"),l=75*a[o]/504,75<(l="hp"==o?75*a[o]/704:l)&&(l=75),360<(n=Math.floor(180*a[o]/714))&&(n=360),i+='<span class="statrow"><label>'+BattleStatNames[o]+'</label> <span class="statgraph"><span style="width:'+l+"px;background:hsl("+n+',40%,75%);"></span></span> '+t+"</span>");if(this.$("button[name=stats]").html(i),"stats"===this.curChartType){for(var o in i="<div></div>",a)"spd"===o&&1===this.curTeam.gen||(i+="<div><b>"+a[o]+"</b></div>");this.$chart.find(".statscol").html(i);var l,n,i="<div></div>",c=0;for(o in a)"spd"===o&&1===this.curTeam.gen||(l=180*a[o]/504,179<(l="hp"==o?180*a[o]/704:l)&&(l=179),360<(n=Math.floor(180*a[o]/714))&&(n=360),i+='<div><em><span style="width:'+Math.floor(l)+"px;background:hsl("+n+",85%,45%);border-color:hsl("+n+',85%,35%)"></span></em></div>',c+=e.evs[o]||0);2<this.curTeam.gen&&s&&(i+="<div><em>Remaining:</em></div>"),this.$chart.find(".graphcol").html(i),this.curTeam.gen<=2||(s&&(c<=510?this.$chart.find(".totalev").html("<em>"+(508<c?0:508-c)+"</em>"):this.$chart.find(".totalev").html("<b>"+(510-c)+"</b>")),this.$chart.find("select[name=nature]").val(e.nature||"Serious"))}}},curChartType:"",curChartName:"",searchChartTypes:{pokemon:"pokemon",ability:"abilities",move:"moves",item:"items"},updateChart:function(e,t){var a,s,i,r=this.curChartType;"stats"===r?(this.search.qType=null,this.search.qName=null,this.updateStatForm()):"details"===r?(this.search.qType=null,this.search.qName=null,this.updateDetailsForm()):(s=(a=this.$("input[name="+this.curChartName+"]")).val(),e||this.search.qName!==this.curChartName?((i={})[toID(s)]=1,"move"===r&&(i[toID(this.$("input[name=move1]").val())]=1,i[toID(this.$("input[name=move2]").val())]=1,i[toID(this.$("input[name=move3]").val())]=1,i[toID(this.$("input[name=move4]").val())]=1),r!==this.search.qType&&this.$chart.scrollTop(0),this.search.$inputEl=a,this.search.setType(r,this.curTeam.format||"gen8",this.curSet,i),this.qInitial=s,this.search.qName=this.curChartName,t&&this.search.find(s)&&this.search.q&&this.$chart.find("a").first().addClass("hover")):s!==this.qInitial&&(this.qInitial=void 0,this.search.find(s)&&this.search.q&&this.$chart.find("a").first().addClass("hover")))},selectPokemon:function(e){var t=this.curSetList[e=+e];t&&(this.curSet=t,this.curSetLoc=e,this.curChartName||(this.curChartName="details",this.curChartType="details"),this.curChartType in this.searchChartTypes?(this.update(),this.updateChart(!0),this.$("input[name="+this.curChartName+"]").select()):(this.update(),this.updateChart(!0)))},stats:function(e,t){this.curSet||this.selectPokemon(u(t).closest("li").val()),this.curChartName="stats",this.curChartType="stats",this.updateChart()},details:function(e,t){this.curSet||this.selectPokemon(u(t).closest("li").val()),this.curChartName="details",this.curChartType="details",this.updateChart()},plus:"",minus:"",smogdexLink:function(e){var t=this.curTeam.dex.species.get(e),a=this.curTeam&&this.curTeam.format,s=toID(t.baseSpecies);if("meowstic"===t.id)s="meowstic-m";else if(t.forme)switch(t.baseSpecies){case"Alcremie":case"Basculin":case"Burmy":case"Castform":case"Cherrim":case"Deerling":case"Flabebe":case"Floette":case"Florges":case"Furfrou":case"Gastrodon":case"Genesect":case"Keldeo":case"Mimikyu":case"Minior":case"Pikachu":case"Polteageist":case"Sawsbuck":case"Shellos":case"Sinistea":case"Vivillon":break;default:s+="-"+toID(t.forme)}var i=8,r=("gen"===a.substr(0,3)&&(1<=(r=parseInt(a.charAt(3),10))&&r<=7&&(i=r),a=a.substr(4)),["rb","gs","rs","dp","bw","xy","sm","ss"][i-1]);return"battlespotdoubles"===a?s+="/vgc15":"doublesou"===a||"doublesuu"===a?s+="/doubles":"ou"===a||"uu"===a||"ru"===a||"nu"===a||"pu"===a||"lc"===a||"monotype"===a||"mixandmega"===a||"nfe"===a||"nationaldex"===a||"stabmons"===a||"1v1"===a||"almostanyability"===a?s+="/"+a:"balancedhackmons"===a?s+="/bh":"anythinggoes"===a?s+="/ag":"nationaldexag"===a&&(s+="/national-dex-ag"),"http://smogon.com/dex/"+r+"/pokemon/"+s+"/"},updateStatForm:function(e){var t,a="",s=this.curSet,i=this.curTeam.dex.species.get(this.curSet.species),r=i.baseStats,o=(a=a+'<div class="resultheader"><h3>EVs</h3></div>'+'<div class="statform">',new BattleStatGuesser(this.curTeam.format).guess(s)),l=o.role,n=o.evs,c=o.plusStat,o=o.minusStat;if(a+='<p class="suggested"><small>Guessed spread:',"?"===l)a+=' (Please choose 4 moves to get a guessed spread) (<a target="_blank" href="'+this.smogdexLink(i)+'">Smogon&nbsp;analysis</a>)</small></p>';else{for(var u in a+=' </small><button name="setStatFormGuesses">'+l+": ",BattleStatNames)n[u]&&(t=1===this.curTeam.gen&&"spa"===u?"Spc":BattleStatNames[u],a+=n[u]+" "+t+" / ");c&&o?a+=" (+"+BattleStatNames[c]+", -"+BattleStatNames[o]+")":a=a.slice(0,-3),a+='</button><small> (<a target="_blank" href="'+this.smogdexLink(i)+'">Smogon&nbsp;analysis</a>)</small></p>'}if(e)s.evs=n,this.plus=c,this.minus=o,this.updateNature(),this.save(),this.updateStatGraph(),this.natureChange();else{var d={hp:"",atk:"",def:"",spa:"",spd:"",spe:""};if(1===this.curTeam.gen&&delete d.spd,s){var p=(p=BattleNatures[s.nature||"Serious"])||{},l=!this.curTeam.format.includes("letsgo"),m=this.curTeam.gen<=2?252:0,h=l?252:200,v=l?4:1;for(u in a=a+'<div class="col labelcol"><div></div>'+"<div><label>HP</label></div><div><label>Attack</label></div><div><label>Defense</label></div><div>",1===this.curTeam.gen?a+="<label>Special</label></div>":a+="<label>Sp. Atk.</label></div><div><label>Sp. Def.</label></div>",a=a+"<div><label>Speed</label></div></div>"+'<div class="col basestatscol"><div><em>Base</em></div>',d)a+="<div><b>"+r[u]+"</b></div>";for(u in a=a+"</div>"+'<div class="col graphcol"><div></div>',d){d[u]=this.getStat(u);var g=180*d[u]/504,f=(179<(g="hp"==u?Math.floor(180*d[u]/704):g)&&(g=179),Math.floor(180*d[u]/714));360<f&&(f=360),a+='<div><em><span style="width:'+Math.floor(g)+"px;background:hsl("+f+",85%,45%);border-color:hsl("+f+',85%,35%)"></span></em></div>'}2<this.curTeam.gen&&l&&(a+="<div><em>Remaining:</em></div>"),a=a+"</div>"+('<div class="col evcol"><div><strong>'+(l?"EVs":"AVs")+"</strong></div>");var b=0;for(u in this.plus="",this.minus="",d)T=""+((void 0===s.evs[u]?m:s.evs[u])||""),p.plus===u&&(T+="+",this.plus=u),p.minus===u&&(T+="-",this.minus=u),a+='<div><input type="text" name="stat-'+u+'" value="'+T+'" class="textbox inputform numform" /></div>',b+=s.evs[u]||0;for(u in 2<this.curTeam.gen&&l&&(a+=b<=510?'<div class="totalev"><em>'+(508<b?0:508-b)+"</em></div>":'<div class="totalev"><b>'+(510-b)+"</b></div>"),a=a+"</div>"+'<div class="col evslidercol"><div></div>',d)"spd"===u&&1===this.curTeam.gen||(a+='<div><input type="range" name="evslider-'+u+'" value="'+BattleLog.escapeHTML(void 0===s.evs[u]?""+m:""+s.evs[u])+'" min="0" max="'+h+'" step="'+v+'" class="evslider" tabindex="-1" aria-hidden="true" /></div>');if(a+="</div>",2<this.curTeam.gen){for(var u in a+='<div class="col ivcol"><div><strong>IVs</strong></div>',s.ivs||(s.ivs={}),d){void 0!==s.ivs[u]&&!isNaN(s.ivs[u])||(s.ivs[u]=31);var T=""+s.ivs[u];a+='<div><input type="number" name="iv-'+u+'" value="'+BattleLog.escapeHTML(T)+'" class="textbox inputform numform" min="0" max="31" step="1" /></div>'}var S,x="";if(s.moves)for(u=0;u<s.moves.length;u++){var y=toID(s.moves[u]);"hiddenpower"===y.slice(0,11)&&(x=y.slice(11))}if(x&&!this.canHyperTrain(s)){switch(x){case"dark":S=["111111"];break;case"dragon":S=["011111","101111","110111"];break;case"ice":S=["010111","100111","111110"];break;case"psychic":S=["011110","101110","110110"];break;case"electric":S=["010110","100110","111011"];break;case"grass":S=["011011","101011","110011"];break;case"water":S=["100011","111010"];break;case"fire":S=["101010","110010"];break;case"steel":S=["100010","111101"];break;case"ghost":S=["101101","110101"];break;case"bug":S=["100101","111100","101100"];break;case"rock":S=["001100","110100","100100"];break;case"ground":S=["000100","111001","101001"];break;case"poison":S=["001001","110001","100001"];break;case"flying":S=["000001","111000","101000"];break;case"fighting":S=["001000","110000","100000"]}var a=(a+='<div style="margin-left:-80px;text-align:right"><select name="ivspread">')+('<option value="" selected>HP '+x.charAt(0).toUpperCase()+x.slice(1)+" IVs</option>"),k=6<=this.curTeam.gen?0:2;a+='<optgroup label="min Atk">';for(u=0;u<S.length;u++){for(var L="",w=0;w<6;w++)w&&(L+="/"),L+=(1===w?k:30)+parseInt(S[u].charAt(w),10);a+='<option value="'+L+'">'+L+"</option>"}a=a+"</optgroup>"+'<optgroup label="min Atk, min Spe">';for(u=0;u<S.length;u++){for(L="",w=0;w<6;w++)w&&(L+="/"),L+=(5===w||1===w?k:30)+parseInt(S[u].charAt(w),10);a+='<option value="'+L+'">'+L+"</option>"}a=a+"</optgroup>"+'<optgroup label="max all">';for(u=0;u<S.length;u++){for(L="",w=0;w<6;w++)w&&(L+="/"),L+=30+parseInt(S[u].charAt(w),10);a+='<option value="'+L+'">'+L+"</option>"}a=a+"</optgroup>"+'<optgroup label="min Spe">';for(u=0;u<S.length;u++){for(L="",w=0;w<6;w++)w&&(L+="/"),L+=(5===w?k:30)+parseInt(S[u].charAt(w),10);a+='<option value="'+L+'">'+L+"</option>"}a=a+"</optgroup>"+"</select></div>"}else a+='<div style="margin-left:-80px;text-align:right"><select name="ivspread"><option value="" selected>IV spreads</option><optgroup label="min Atk"><option value="31/0/31/31/31/31">31/0/31/31/31/31</option></optgroup><optgroup label="min Atk, min Spe"><option value="31/0/31/31/31/0">31/0/31/31/31/0</option></optgroup><optgroup label="max all"><option value="31/31/31/31/31/31">31/31/31/31/31/31</option></optgroup><optgroup label="min Spe"><option value="31/31/31/31/31/0">31/31/31/31/31/0</option></optgroup></select></div>'}else for(var u in a+='<div class="col ivcol"><div><strong>DVs</strong></div>',s.ivs||(s.ivs={}),d){void 0!==s.ivs[u]&&!isNaN(s.ivs[u])||(s.ivs[u]=31);T=""+Math.floor(s.ivs[u]/2);a+='<div><input type="number" name="iv-'+u+'" value="'+BattleLog.escapeHTML(T)+'" class="textbox inputform numform" min="0" max="15" step="1" /></div>'}for(u in a=a+"</div>"+'<div class="col statscol"><div></div>',d)a+="<div><b>"+d[u]+"</b></div>";if(a+="</div>",2<this.curTeam.gen){for(var u in a+='<p style="clear:both">Nature: <select name="nature">',BattleNatures){var F=BattleNatures[u];a+='<option value="'+u+'"'+(F===p?'selected="selected"':"")+">"+u,F.plus&&(a+=" (+"+BattleStatNames[F.plus]+", -"+BattleStatNames[F.minus]+")"),a+="</option>"}a=a+"</select></p>"+'<p><em>Protip:</em> You can also set natures by typing "+" and "-" next to a stat.</p>'}this.$chart.html(a+="</div>")}}},setStatFormGuesses:function(){this.updateStatForm(!0)},setSlider:function(e,t){this.$chart.find("input[name=evslider-"+e+"]").val(t||0)},updateNature:function(){var e=this.curSet;if(e)if(""===this.plus||""===this.minus)e.nature="Serious";else for(var t in BattleNatures)if(BattleNatures[t].plus===this.plus&&BattleNatures[t].minus===this.minus){e.nature=t;break}},statChange:function(e){var t,a,s,i,r="",r=e.currentTarget.name,o=Math.abs(parseInt(e.currentTarget.value,10)),l=!this.curTeam.format.includes("letsgo"),n=!l&&this.curTeam.format.endsWith("norestrictions"),c=this.curSet;c&&("stat-"===r.substr(0,5)?(i=r.substr(5),s=e.currentTarget.value.charAt(e.target.value.length-1),t=e.currentTarget.value.charAt(0),a=!0,"+"!==s&&"+"!==t||"hp"===i?"-"!==s&&"−"!==s&&"-"!==t&&"−"!==t||"hp"===i?this.plus===i?this.plus="":this.minus===i?this.minus="":a=!1:(this.minus&&this.minus!==i&&this.$chart.find("input[name=stat-"+this.minus+"]").val(c.evs[this.minus]||""),this.minus=i):(this.plus&&this.plus!==i&&this.$chart.find("input[name=stat-"+this.plus+"]").val(c.evs[this.plus]||""),this.plus=i),a&&this.updateNature(),((o=252<o?252:o)<0||isNaN(o))&&(o=0),c.evs[i]===o&&!a||(c.evs[i]=o,this.ignoreEVLimits&&(s=l?252:n?200:0,void 0===c.evs.hp&&(c.evs.hp=s),void 0===c.evs.atk&&(c.evs.atk=s),void 0===c.evs.def&&(c.evs.def=s),void 0===c.evs.spa&&(c.evs.spa=s),void 0===c.evs.spd&&(c.evs.spd=s),void 0===c.evs.spe&&(c.evs.spe=s)),this.setSlider(i,o),this.updateStatGraph())):(i=r.substr(3),(o=31<(o=this.curTeam.gen<=2&&30===(o*=2)?31:o)||isNaN(o)?31:o)<0&&(o=0),c.ivs||(c.ivs={}),c.ivs[i]!==o&&(c.ivs[i]=o,this.updateIVs(),this.updateStatGraph())),this.save())},updateIVs:function(){var e=this.curSet;if(e.moves&&!this.canHyperTrain(e)){for(var t=!1,a=0;a<e.moves.length;a++)if("hiddenpower"===toID(e.moves[a]).slice(0,11)){t=!0;break}if(t){var s=["Fighting","Flying","Poison","Ground","Rock","Bug","Ghost","Steel","Fire","Water","Grass","Electric","Psychic","Ice","Dragon","Dark"];if(this.curTeam.gen<=2){var i=Math.floor(e.ivs.hp/2),r=Math.floor(e.ivs.atk/2),o=Math.floor(e.ivs.def/2),l=Math.floor(e.ivs.spe/2),n=Math.floor(e.ivs.spa/2),c=s[r%4*4+o%4],r=r%2*8+o%2*4+l%2*2+n%2;r!==i&&(e.ivs.hp=2*r,30===e.ivs.hp&&(e.ivs.hp=31),this.$chart.find("input[name=iv-hp]").val(r))}else{var u,d=0,a=1;for(u in{hp:31,atk:31,def:31,spe:31,spa:31,spd:31})void 0===e.ivs[u]&&(e.ivs[u]=31),d+=a*(e.ivs[u]%2),a*=2;c=s[Math.floor(15*d/63)]}for(a=0;a<e.moves.length;a++)"hiddenpower"===toID(e.moves[a]).slice(0,11)&&(e.moves[a]="Hidden Power "+c,a<4&&this.$("input[name=move"+(a+1)+"]").val("Hidden Power "+c))}}},statSlide:function(e){var t=e.currentTarget,a=t.name.substr(9),s=this.curSet;if(s){var i=+t.value,r=i,o=this.getStat(a,s,i),l=!this.curTeam.format.includes("letsgo"),n=!l&&this.curTeam.format.endsWith("norestrictions");if(l)for(;0<i&&this.getStat(a,s,i-4)==o;)i-=4;if(l&&!this.ignoreEVLimits&&s.evs){var c,u=0;for(c in s.evs)u+=c===a?i:s.evs[c];508<u&&0<=i-u+508&&252<(i=!(i=+(i=i-u+508))||i<=0?0:i)&&(i=252)}i!==r&&(t.value=i),s.evs||(s.evs={}),this.ignoreEVLimits&&(r=l?252:n?200:0,void 0===s.evs.hp&&(s.evs.hp=r),void 0===s.evs.atk&&(s.evs.atk=r),void 0===s.evs.def&&(s.evs.def=r),void 0===s.evs.spa&&(s.evs.spa=r),void 0===s.evs.spd&&(s.evs.spd=r),void 0===s.evs.spe&&(s.evs.spe=r)),i=""+((s.evs[a]=i)||"")+(this.plus===a?"+":"")+(this.minus===a?"-":""),this.$("input[name=stat-"+a+"]").val(i),this.updateStatGraph()}},statSlided:function(e){this.statSlide(e),this.save()},natureChange:function(e){var t=this.curSet;if(t){e&&(t.nature=e.currentTarget.value),this.plus="",this.minus="";var a,s=BattleNatures[t.nature||"Serious"];for(a in BattleStatNames){var i=""+(t.evs[a]||"");s.plus===a&&(this.plus=a,i+="+"),s.minus===a&&(this.minus=a,i+="-"),this.$chart.find("input[name=stat-"+a+"]").val(i),e||this.setSlider(a,t.evs[a])}this.save(),this.updateStatGraph()}},ivSpreadChange:function(e){var t=this.curSet;if(t){var a=e.currentTarget.value.split("/");if(t.ivs||(t.ivs={}),6===a.length){for(var s=["hp","atk","def","spa","spd","spe"],i=0;i<6;i++)this.$chart.find("input[name=iv-"+s[i]+"]").val(a[i]),t.ivs[s[i]]=parseInt(a[i],10);u(e.currentTarget).val(""),this.save(),this.updateStatGraph()}}},updateDetailsForm:function(){var e="",t=this.curSet,a=this.curTeam.format.includes("letsgo"),s=this.curTeam.format.includes("bdsp"),i=8===this.curTeam.gen&&this.curTeam.format.includes("nationaldex"),r=this.curTeam.format.includes("supernat"),o=this.curTeam.dex.species.get(t.species);if(t){if(e=(e+='<div class="resultheader"><h3>Details</h3></div>')+'<form class="detailsform">'+('<div class="formrow"><label class="formlabel">Level:</label><div><input type="number" min="1" max="100" step="1" name="level" value="'+("number"==typeof t.level?t.level:100)+'" class="textbox inputform numform" /></div></div>'),1<this.curTeam.gen&&(e+='<div class="formrow"><label class="formlabel">Gender:</label><div>',o.gender&&!this.curTeam.format.includes("hackmons")?e+={M:"Male",F:"Female",N:"Genderless"}[o.gender]:(e=(e+='<label><input type="radio" name="gender" value="M"'+("M"===t.gender?" checked":"")+" /> Male</label> ")+'<label><input type="radio" name="gender" value="F"'+("F"===t.gender?" checked":"")+" /> Female</label> ",this.curTeam.format.includes("hackmons")?e+='<label><input type="radio" name="gender" value="N"'+("N"===t.gender?" checked":"")+" /> Genderless</label>":e+='<label><input type="radio" name="gender" value="N"'+(t.gender?"":" checked")+" /> Random</label>"),e+="</div></div>",a?e+='<div class="formrow"><label class="formlabel">Happiness:</label><div><input type="number" name="happiness" value="70" class="textbox inputform numform" /></div></div>':(this.curTeam.gen<8||i)&&(e+='<div class="formrow"><label class="formlabel">Happiness:</label><div><input type="number" min="0" max="255" step="1" name="happiness" value="'+("number"==typeof t.happiness?t.happiness:255)+'" class="textbox inputform numform" /></div></div>'),e=(e=e+'<div class="formrow"><label class="formlabel">Shiny:</label><div><label><input type="radio" name="shiny" value="yes"'+(t.shiny?" checked":"")+" /> Yes</label> ")+'<label><input type="radio" name="shiny" value="no"'+(t.shiny?"":" checked")+" /> No</label></div></div>",s||!o.canGigantamax&&"Gmax"!==o.forme||(e+='<div class="formrow"><label class="formlabel">Gigantamax:</label><div>',"Gmax"===o.forme?e+="Yes":e=(e+='<label><input type="radio" name="gigantamax" value="yes"'+(t.gigantamax?" checked":"")+" /> Yes</label> ")+'<label><input type="radio" name="gigantamax" value="no"'+(t.gigantamax?"":" checked")+" /> No</label>",e+="</div></div>")),2<this.curTeam.gen){for(var e=e+'<div class="formrow" style="display:none"><label class="formlabel">Pokeball:</label><div><select name="pokeball">'+('<option value=""'+(t.pokeball?"":' selected="selected"')+"></option>"),l=this.curTeam.dex.getPokeballs(),n=0;n<l.length;n++)e+='<option value="'+l[n]+'"'+(t.pokeball===l[n]?' selected="selected"':"")+">"+l[n]+"</option>";e+="</select></div></div>"}if(!a&&(7===this.curTeam.gen||i||r||s&&"Unown"===o.baseSpecies)){e=e+('<div class="formrow"><label class="formlabel" title="Hidden Power Type">'+(r?"Tera Type":"Hidden Power")+':</label><div><select name="hptype">')+('<option value=""'+(t.hpType?"":' selected="selected"')+">(automatic type)</option>");for(var c=Dex.types.all(),n=0;n<c.length;n++)c[n].HPivs&&(e+='<option value="'+c[n].name+'"'+(t.hpType===c[n].name?' selected="selected"':"")+">"+c[n].name+"</option>");e+="</select></div></div>"}e+="</form>",o.cosmeticFormes&&(e+='<button class="altform">Change sprite</button>'),this.$chart.html(e)}},detailsChange:function(e){e.preventDefault(),e.stopPropagation();var t,a,s,i,r,o,l=this.curSet;l&&(t=this.curTeam.dex.species.get(l.species),a=this.curTeam.format.includes("letsgo"),s=this.curTeam.format.includes("bdsp"),i=this.curTeam.format.includes("nationaldex"),r=this.curTeam.format.includes("supernat"),100===(o=!(o=parseInt(this.$chart.find("input[name=level]").val(),10))||100<o||o<1?100:o)&&!l.level||(l.level=o),o=parseInt(this.$chart.find("input[name=happiness]").val(),10),isNaN(o)&&(o=255),l.happiness=o=(o=255<o?255:o)<0?255:o,255===l.happiness&&delete l.happiness,"yes"===this.$chart.find("input[name=shiny]:checked").val()?l.shiny=!0:delete l.shiny,"yes"===this.$chart.find("input[name=gigantamax]:checked").val()?l.gigantamax=!0:delete l.gigantamax,"M"===(o=this.$chart.find("input[name=gender]:checked").val())||"F"===o?l.gender=o:delete l.gender,(o=this.$chart.find("select[name=pokeball]").val())&&this.curTeam.dex.items.get(o).isPokeball?l.pokeball=o:delete l.pokeball,o=this.$chart.find("select[name=hptype]").val(),Dex.types.isName(o)?l.hpType=o:delete l.hpType,o="",o+='<span class="detailcell detailcell-first"><label>Level</label>'+(l.level||100)+"</span>",1<this.curTeam.gen&&(o+='<span class="detailcell"><label>Gender</label>'+{M:"Male",F:"Female",N:"&mdash;"}[l.gender||"N"]+"</span>",a?o+='<span class="detailcell"><label>Happiness</label>70</span>':(this.curTeam.gen<8||i)&&(o+='<span class="detailcell"><label>Happiness</label>'+("number"==typeof l.happiness?l.happiness:255)+"</span>"),o+='<span class="detailcell"><label>Shiny</label>'+(l.shiny?"Yes":"No")+"</span>",r?o+='<span class="detailcell"><label>Tera Type</label>'+(l.hpType||"Dark")+"</span>":!a&&(this.curTeam.gen<8||i)&&(o+='<span class="detailcell"><label>HP Type</label>'+(l.hpType||"Dark")+"</span>"),8!==this.curTeam.gen||s||!t.canGigantamax&&"Gmax"!==t.forme||(o+='<span class="detailcell"><label>Gmax</label>'+(l.gigantamax||"Gmax"===t.forme?"Yes":"No")+"</span>")),this.$("button[name=details]").html(o),this.save(),this.updatePokemonSprite())},altForm:function(e){var t=this.curSet,a=0;t||(a=+u(e.currentTarget).closest("li").attr("value"),t=this.curSetList[a]),app.addPopup(i,{curSet:t,index:a,room:this})},chartTypes:{pokemon:"pokemon",item:"item",ability:"ability",move1:"move",move2:"move",move3:"move",move4:"move",stats:"stats",details:"details"},chartClick:function(e){if(this.search.addFilter(e.currentTarget))this.$("input[name="+this.curChartName+"]").val("").select(),this.search.find("");else{var t=u(e.currentTarget).data("entry"),a=t.slice(t.indexOf("|")+1);if("move"===this.curChartType&&"cur"===e.currentTarget.className){for(var s=[],i=1;i<=4;i++){var r=this.$("input[name=move"+i+"]"),o=r.val();o===a?(this.unChooseMove(o),r.val(""),delete this.search.cur[toID(a)]):o&&s.push(o)}if(s.length<4)return this.$("input[name=move1]").val(s[0]||""),this.$("input[name=move2]").val(s[1]||""),this.$("input[name=move3]").val(s[2]||""),this.$("input[name=move4]").val(s[3]||""),void this.$("input[name=move"+(1+s.length)+"]").focus()}this.chartSet(a,!0)}},chartKeydown:function(e){var t,a,s=e.shiftKey||e.ctrlKey||e.altKey||e.metaKey||e.cmdKey;if(13===e.keyCode||9===e.keyCode&&!s)this.curChartType in this.searchChartTypes&&(this.updateChart(),a=this.$chart.find("a.hover"),e.stopPropagation(),e.preventDefault(),a.length?this.search.addFilter(a[0])?(u(e.currentTarget).val("").select(),this.search.find("")):(s=(s=a.data("entry")).slice(s.indexOf("|")+1),this.chartSet(s,!0)):this.chartChange(e,!0));else if(38===e.keyCode){if(e.preventDefault(),e.stopPropagation(),!(t=this.$chart.find("a.hover")).length)return this.$chart.find("a").first().addClass("hover");for(var i=t.parent().prev();i[0]&&"A"!==i[0].firstChild.tagName;)i=i.prev();i[0]&&i.children()[0]&&(t.removeClass("hover"),(t=i.children()).addClass("hover"))}else if(40===e.keyCode){if(e.preventDefault(),e.stopPropagation(),!(t=this.$chart.find("a.hover")).length)return this.$chart.find("a").first().addClass("hover");for(i=t.parent().next();i[0]&&"A"!==i[0].firstChild.tagName;)i=i.next();i[0]&&i.children()[0]&&(t.removeClass("hover"),(t=i.children()).addClass("hover"))}else 27===e.keyCode||8===e.keyCode?!e.currentTarget.value&&this.search.removeFilter()&&this.search.find(""):188===e.keyCode&&(a=this.$chart.find("a").first(),this.search.q&&this.search.addFilter(a[0])&&(e.preventDefault(),e.stopPropagation(),u(e.currentTarget).val("").select(),this.search.find("")))},chartKeyup:function(){this.updateChart()},chartFocus:function(e){var t=u(e.currentTarget),a=e.currentTarget.name,s=this.chartTypes[a],i=!1;t.hasClass("incomplete")&&(i=!0,t.removeClass("incomplete")),this.curChartName!==a&&(this.curSet?(this.curChartName=a,this.curChartType=s,this.updateChart(!1,i)):(i=+t.closest("li").prop("value"),this.curSet=this.curSetList[i],this.curSetLoc=i,this.update(),"stats"===s||"details"===s?this.$("button[name="+a+"]").click():this.$("input[name="+a+"]").select()))},chartChange:function(e,t){var a=e.currentTarget.name;if(this.curChartName===a){var s=toID(e.currentTarget.value),i=(s in BattleAliases&&(s=toID(BattleAliases[s])),"");switch(a){case"pokemon":i=s in BattlePokedex?this.curTeam.dex.species.get(e.currentTarget.value).name:"";break;case"ability":i=s in BattleItems&&"gen8dualwielding"==this.curTeam.format?BattleItems[s].name:s in BattleMovedex&&"gen8trademarked"==this.curTeam.format?BattleMovedex[s].name:s in BattleAbilities?BattleAbilities[s].name:"";break;case"item":i=s in BattleMovedex&&"gen8fortemons"==this.curTeam.format?BattleMovedex[s].name:s in BattleAbilities&&"gen8multibility"==this.curTeam.format?BattleAbilities[s].name:s in BattleItems?BattleItems[s].name:"";break;case"move1":case"move2":case"move3":case"move4":i=s in BattleMovedex?BattleMovedex[s].name:""}i||"pokemon"!==a&&"ability"!==a&&!s?this.chartSet(i,t):u(e.currentTarget).addClass("incomplete")}},searchChange:function(e){91!==e.keyCode&&93!==e.keyCode&&17!==e.keyCode&&(this.curSearchVal=e.currentTarget.value,this.updateTeamList())},chartSetCustom:function(e){var t,a;return"cathy"===(e=toID(e))?((t=this.curSet).name="Cathy",t.species="Trevenant",delete t.level,"pokebank"===(a="bdsp"===(a="gen"===(a=this.curTeam.format).substr(0,3)?a.substr(4):a).substr(0,4)?a.substr(4):a).substr(0,8)&&(a=a.substr(8)),this.curTeam&&this.curTeam.format&&("battlespotsingles"!==a&&"battlespotdoubles"!==a&&"vgc"!==a.substr(0,3)&&"battlefestivaldoubles"!==a||(t.level=50),(a.startsWith("lc")||a.endsWith("lc"))&&(t.level=5)),t.gender="F",t.happiness&&delete t.happiness,t.shiny&&delete t.shiny,t.gigantamax&&delete t.gigantamax,t.item="Starf Berry",t.ability="Harvest",t.moves=["Substitute","Horn Leech","Earthquake","Phantom Force"],t.evs={hp:36,atk:252,def:0,spa:0,spd:0,spe:220},t.ivs={},t.nature="Jolly",this.updateSetTop(),this.$(this.$("input[name=item]").length?"input[name=item]":this.$("input[name=ability]").length?"input[name=ability]":"input[name=move1]").select(),!0):"citizensnips"===e||"snips"===e?((t=this.curSet).name="citizen snips",t.species="Drapion",delete t.level,"pokebank"===(a="bdsp"===(a="gen"===(a=this.curTeam.format).substr(0,3)?a.substr(4):a).substr(0,4)?a.substr(4):a).substr(0,8)&&(a=a.substr(8)),this.curTeam&&this.curTeam.format&&("battlespotsingles"!==a&&"battlespotdoubles"!==a&&"vgc"!==a.substr(0,3)&&"battlefestivaldoubles"!==a||(t.level=50),"lc"===a.substr(0,2)&&(t.level=5)),t.happiness&&delete t.happiness,t.shiny&&delete t.shiny,t.gigantamax&&delete t.gigantamax,t.item="Leftovers",t.ability="Battle Armor",t.moves=["Acupressure","Knock Off","Rest","Sleep Talk"],t.evs={hp:248,atk:0,def:96,spa:0,spd:108,spe:56},t.ivs={},t.nature="Impish",this.updateSetTop(),this.$(this.$("input[name=item]").length?"input[name=item]":this.$("input[name=ability]").length?"input[name=ability]":"input[name=move1]").select(),!0):void 0},chartSet:function(e,t){var a=this.curChartName,s=this.$("input[name="+a+"]");if(!this.chartSetCustom(s.val())){switch(s.val(e).removeClass("incomplete"),a){case"pokemon":this.setPokemon(e,t);break;case"item":this.curSet.item=e,this.updatePokemonSprite(),t&&this.$(this.$("input[name=ability]").length?"input[name=ability]":"input[name=move1]").select();break;case"ability":this.curSet.ability=e,t&&this.$("input[name=move1]").select();break;case"move1":this.unChooseMove(this.curSet.moves[0]),this.curSet.moves[0]=e,this.chooseMove(e),t&&this.$("input[name=move2]").select();break;case"move2":this.curSet.moves[0]||(this.curSet.moves[0]=""),this.unChooseMove(this.curSet.moves[1]),this.curSet.moves[1]=e,this.chooseMove(e),t&&this.$("input[name=move3]").select();break;case"move3":this.curSet.moves[0]||(this.curSet.moves[0]=""),this.curSet.moves[1]||(this.curSet.moves[1]=""),this.unChooseMove(this.curSet.moves[2]),this.curSet.moves[2]=e,this.chooseMove(e),t&&this.$("input[name=move4]").select();break;case"move4":this.curSet.moves[0]||(this.curSet.moves[0]=""),this.curSet.moves[1]||(this.curSet.moves[1]=""),this.curSet.moves[2]||(this.curSet.moves[2]=""),this.unChooseMove(this.curSet.moves[3]),this.curSet.moves[3]=e,this.chooseMove(e),t&&(this.stats(),this.$("button.setstats").focus())}this.save()}},unChooseMove:function(e){var t=this.curSet;if(e&&t&&"gen7hiddentype"!==this.curTeam.format){if("Hidden Power "===e.substr(0,13)&&t.ivs)for(var a in t.ivs)30===t.ivs[a]&&(t.ivs[a]=31),t.ivs[a]<=3&&(t.ivs[a]=0);var s="Gyro Ball"===e?!0:!1;this.chooseMove("",s)}},canHyperTrain:function(e){var t;return!(this.curTeam.gen<7||"gen7hiddentype"===this.curTeam.format)&&(t=this.curTeam.format,!e.level||100===e.level||("battlespot"===(t="gen"===t.substr(0,3)?t.substr(4):t).substr(0,10)||"vgc"===t.substr(0,3)||"ultrasinnohclassic"===t)&&50===e.level)},chooseMove:function(e,t){var a=this.curSet;if(a){var s,i=this.curTeam.gen;if(t&&(s=!1),"Hidden Power "===e.substr(0,13)){if(!this.canHyperTrain(a)){var r=e.substr(13);if(a.ivs={hp:31,atk:31,def:31,spa:31,spd:31,spe:31},2<this.curTeam.gen){var o=this.curTeam.dex.types.get(r).HPivs;for(h in o)a.ivs[h]=o[h]}else{var l=this.curTeam.dex.types.get(r).HPdvs;for(h in l)a.ivs[h]=2*l[h];var r=Math.floor(a.ivs.atk/2),n=Math.floor(a.ivs.def/2),c=Math.floor(a.ivs.spe/2),u=Math.floor(a.ivs.spa/2);a.ivs.hp=2*(r%2*8+n%2*4+c%2*2+u%2),30===a.ivs.hp&&(a.ivs.hp=31)}}}else"Return"===e?this.curSet.happiness=255:"Frustration"===e?this.curSet.happiness=0:"Gyro Ball"===e&&(s=!0);if("gen7hiddentype"!==this.curTeam.format){for(var d=!0,r=("Battle Bond"===a.ability&&(d=!1),6<=this.curTeam.gen?2:4),p=!1,m=a.moves,h=0;h<m.length;++h)if(m[h]){"Hidden Power "===m[h].substr(0,13)&&(p=!0);var v=this.curTeam.dex.moves.get(m[h]);if("transform"===v.id){for(var p=!0,g=!1,f=0;f<m.length;++f)if(f!==h&&m[f]){g=!0;break}g||(d=!1)}else(!("Physical"!==v.category||v.damage||v.ohko||["foulplay","endeavor","counter","bodypress","seismictoss","bide","metalburst","superfang"].includes(v.id)||this.curTeam.gen<8&&"rapidspin"===v.id)||["metronome","assist","copycat","mefirst","photongeyser","shellsidearm"].includes(v.id))&&(d=!1);!1===s&&"Gyro Ball"===e&&(s=void 0)}if(!a.ivs){if(void 0===s&&(!d||i<3))return;a.ivs={}}a.ivs.spe||0===a.ivs.spe||(a.ivs.spe=31),s?a.ivs.spe=p?a.ivs.spe%r:0:!1===s&&(a.ivs.spe=p?30+a.ivs.spe%2:31),i<3||(a.ivs.atk||0===a.ivs.atk||(a.ivs.atk=31),a.ivs.atk=d?p?a.ivs.atk%r:0:p?30+a.ivs.atk%2:31)}}},setPokemon:function(e,t){var a,s,i=this.curSet,r=this.curTeam.dex.species.get(e);r.exists&&i.species!==r.name?(i.name="",i.species=e,i.level&&delete i.level,this.curTeam&&this.curTeam.format&&(a=this.curTeam.format,s=window.BattleFormats&&window.BattleFormats[a],"pokebank"===(a="bdsp"===(a="gen"===a.substr(0,3)?a.substr(4):a).substr(0,4)?a.substr(4):a).substr(0,8)&&(a=a.substr(8)),this.curTeam&&this.curTeam.format&&(("battlespot"===a.substr(0,10)&&"battlespotspecial13"!==a.substr(0,19)||"vgc"===a.substr(0,3)||"battlefestival"===a.substr(0,14))&&(i.level=50),"lc"!==a.substr(0,2)&&"caplc"!==a.substr(0,5)&&"lc"!==a.substr(-2)||(i.level=5),"battlespotspecial17"===a.substr(0,19)&&(i.level=1),s&&s.teambuilderLevel&&(i.level=s.teambuilderLevel))),i.gender&&delete i.gender,r.gender&&"N"!==r.gender&&(i.gender=r.gender),i.happiness&&delete i.happiness,i.shiny&&delete i.shiny,i.gigantamax&&delete i.gigantamax,this.curTeam.format.includes("hackmons")||1!==r.requiredItems.length?i.item="":i.item=r.requiredItems[0],i.ability=r.abilities[0],i.moves=[],i.evs={},i.ivs={},i.nature="",this.updateSetTop(),t&&this.$(i.item||!this.$("input[name=item]").length?this.$("input[name=ability]").length?"input[name=ability]":"input[name=move1]":"input[name=item]").select()):t&&this.$("input[name=item]").select()},getStat:function(e,t,a,s){var i=!this.curTeam.format.includes("letsgo"),r=!i;if(!(t=t||this.curSet))return 0;t.ivs||(t.ivs={hp:31,atk:31,def:31,spa:31,spd:31,spe:31}),t.evs||(t.evs={});var o=this.curTeam.dex.species.get(t.species);if(!o.exists)return 0;t.level||(t.level=100),void 0===t.ivs[e]&&(t.ivs[e]=31);var l,o=o.baseStats[e],n=t.ivs[e]||0,c=(this.curTeam.gen<=2&&(n&=30),t.evs[e]);return void 0===(c=void 0!==a?a:c)&&(c=2<this.curTeam.gen?0:252),"hp"===e?1===o?1:i?Math.floor(Math.floor(2*o+n+Math.floor(c/4)+100)*t.level/100+10):Math.floor(Math.floor(2*o+n+100)*t.level/100+10)+(r?c:0):(l=Math.floor(Math.floor(2*o+n+Math.floor(c/4))*t.level/100+5),i||(l=Math.floor(Math.floor(2*o+n)*t.level/100+5)),s?l*=s:BattleNatures[t.nature]&&BattleNatures[t.nature].plus===e?l*=1.1:BattleNatures[t.nature]&&BattleNatures[t.nature].minus===e&&(l*=.9),i||(o=Math.floor(100*(70/255/10+1)),l=Math.floor(l)*o/100+(r?c:0)),Math.floor(l))},getGen:function(e){return(e=""+e)?"gen"===e.substr(0,3)&&parseInt(e.substr(3,1),10)||6:7}});var o,a=s.MoveSetPopup=Popup.extend({initialize:function(e){var t='<ul class="popupmenu">';this.i=e.i,this.team=e.team;for(var a=0;a<e.team.length;a++){var s=e.team[a];a!==e.i&&a!==e.i+1&&(t+='<li><button name="moveHere" value="'+a+'"><i class="fa fa-arrow-right"></i> Move here</button></li>'),t+="<li"+(a===e.i?' style="opacity:.3"':' style="opacity:.6"')+'><span class="picon" style="display:inline-block;vertical-align:middle;'+Dex.getPokemonIcon(s)+'"></span> '+BattleLog.escapeHTML(s.name||s.species)+"</li>"}a!==e.i&&a!==e.i+1&&(t+='<li><button name="moveHere" value="'+a+'"><i class="fa fa-arrow-right"></i> Move here</button></li>'),this.$el.html(t+="</ul>")},moveHere:function(e){this.close(),e=+e;var t=this.team.splice(this.i,1)[0];e>this.i&&e--,this.team.splice(e,0,t),app.rooms.teambuilder.save(),app.rooms.teambuilder.curSet?(app.rooms.teambuilder.curSetLoc=e,app.rooms.teambuilder.update(),app.rooms.teambuilder.updateChart()):app.rooms.teambuilder.update()}}),e=this.DeleteFolderPopup=Popup.extend({type:"semimodal",initialize:function(e){this.room=e.room,this.folder=e.folder;var t='<form><p>Remove "'+e.folder.slice(0,-1)+'"?</p><p><label><input type="checkbox" name="addname" /> Add "'+BattleLog.escapeHTML(this.folder.slice(0,-1))+'" before team names</label></p>';this.$el.html(t+='<p><button type="submit"><strong>Remove (keep teams)</strong></button> \x3c!--button name="removeDelete"><strong>Remove (delete teams)</strong></button--\x3e <button type="button" name="close" class="autofocus">Cancel</button></p></form>')},submit:function(e){this.room.deleteFolder(this.folder,!!this.$("input[name=addname]")[0].checked),this.close()}}),i=this.AltFormPopup=Popup.extend({type:"semimodal",initialize:function(e){this.room=e.room,this.curSet=e.curSet,this.chartIndex=e.index;var t=this.room.curTeam.dex.species.get(this.curSet.species),a=toID(t.baseSpecies),s=[a].concat(t.cosmeticFormes.map(toID)),i=Dex.resourcePrefix+"sprites/",r=96,o="width: 96px; height: 96px;",l={1:"gen1",2:"gen2",3:"gen3",4:"gen4",5:"gen5",6:"dex",7:"dex",8:"dex"}[Math.max(this.room.curTeam.gen,t.gen)];Dex.prefs("nopastgens")&&(l="dex"),i+=l=Dex.prefs("bwgfx")&&"dex"===l?"gen5":l,"dex"===l&&(r=120,o="width: 120px; height: 120px;");p='<p>Pick a variant or <button name="close">Cancel</button></p><div class="formlist">';for(var n=s.length,c=0;c<n;c++)var u=s[c].substring(a.length),d=u?u[0].toUpperCase()+u.slice(1):"",p=(p=p+('<button name="setForm" value="'+d+'"  style="')+("background-position:"+("-"+(c-1)%7*r+"px -"+Math.floor((c-1)/7)*r+"px")+"; background: url("+i+"/"+a+(d?"-"+u:"")+".png) no-repeat; "+o+'"'))+((d===t.form||""===d&&!t.form?' class="cur"':"")+"></button>");p+="</div>";var l=Math.ceil(n/7),m=Math.ceil(n/l);this.$el.html(p).css({"max-width":(4+r)*m,height:42+(4+r)*l})},setForm:function(e){var t=Dex.species.get(this.curSet.species);e&&e!==t.form?this.curSet.species=Dex.species.get(t.baseSpecies+e).name:e||(this.curSet.species=t.baseSpecies),this.close(),this.room.curSet?this.room.updatePokemonSprite():this.room.update(),this.room.$("input[name=pokemon]").eq(this.chartIndex).val(this.curSet.species),this.room.curTeam.team=Storage.packTeam(this.room.curSetList),Storage.saveTeam(this.room.curTeam)}})}(window,jQuery);
