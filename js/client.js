function toId(){alert("You have an old extension/script for Pokemon Showdown which is incompatible with this client. It needs to be removed or updated.")}!(function(R){Config.sockjsprefix="/showdown",Config.root="/",window.nodewebkit&&(window.gui=require("nw.gui"),window.nwWindow=gui.Window.get()),navigator.userAgent.match(/(iPod|iPhone|iPad)/)&&(window.isiOS=!0,R("head").append('<meta name="apple-mobile-web-app-capable" content="yes" />')),R(document).on("keydown",function(t){27==t.keyCode&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),app.closePopup())}),R(window).on("dragover",function(t){/^text/.test(t.target.type)||t.preventDefault()}),R(document).on("dragenter",function(t){var e;/^text/.test(t.target.type)||(t.preventDefault(),app.dragging||"teambuilder"!==app.curRoom.id||((e=t.originalEvent.dataTransfer).files&&e.files[0]?".txt"===e.files[0].name.slice(-4)&&app.curRoom.defaultDragEnterTeam(t):e.items&&e.items[0]&&("file"===(e=e.items[0]).kind&&"text/plain"===e.type&&app.curRoom.defaultDragEnterTeam(t))),t.originalEvent.dataTransfer.dropEffect="move")}),R(window).on("drop",function(t){var e;/^text/.test(t.target.type)||(t.preventDefault(),app.dragging&&app.draggingRoom?app.rooms[app.draggingRoom].defaultDropTeam(t):t.originalEvent.dataTransfer.files&&t.originalEvent.dataTransfer.files[0]&&(".txt"===(e=t.originalEvent.dataTransfer.files[0]).name.slice(-4)&&"teambuilder"===app.curRoom.id?(app.curRoom.defaultDragEnterTeam(t),app.curRoom.defaultDropTeam(t)):e.type&&"image/"===e.type.substr(0,6)?CustomBackgroundPopup.readFile(e):e.type&&"text/html"===e.type&&BattleRoom.readReplayFile(e)))}),window.nodewebkit&&R(document).on("contextmenu",function(t){t.preventDefault();var e=t.target,o="TEXTAREA"===e.tagName||"INPUT"===e.tagName,i=new gui.Menu,s=(o&&i.append(new gui.MenuItem({label:"Cut",click:function(){document.execCommand("cut")}})),R(e).closest("a")[0]);s&&i.append(new gui.MenuItem({label:"Copy Link URL",click:function(){gui.Clipboard.get().set(s.href)}})),"IMG"===e.tagName&&i.append(new gui.MenuItem({label:"Copy Image URL",click:function(){gui.Clipboard.get().set(e.src)}})),i.append(new gui.MenuItem({label:"Copy",click:function(){document.execCommand("copy")}})),o&&i.append(new gui.MenuItem({label:"Paste",enabled:!!gui.Clipboard.get().get(),click:function(){document.execCommand("paste")}})),i.popup(t.originalEvent.x,t.originalEvent.y)}),!window.Notification&&window.webkitNotification&&(window.Notification=window.webkitNotification),window.selectTab=function(t){return app.tryJoinRoom(t),!1};var t=this.User=Backbone.Model.extend({defaults:{name:"",userid:"",registered:!1,named:!1,avatar:0,settings:{},status:"",away:!1},initialize:function(){app.addGlobalListeners(),app.on("response:userdetails",function(t){t.userid===this.get("userid")&&this.set("avatar",""+t.avatar)},this);var t,o=this,e=(this.on("change:name",function(){if(o.get("named")){for(var t=o.get("name").replace(/[^A-Za-z0-9]+$/,""),e=t.length-1;0<e;e--)/[^\ -\~]/.test(t[e])&&(t=t.slice(0,e)+","+t.slice(e+1));t=(t=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")).replace(/,/g,"[^A-Za-z0-9]?"),o.nameRegExp=new RegExp("(?:\\b|(?!\\w))"+t+"(?:\\b|\\B(?!\\w))","i")}else o.nameRegExp=null}),this.on("change:settings",function(){Storage.prefs("serversettings",o.get("settings"))}),{A:"ＡⱯȺ",B:"ＢƂƁɃ",C:"ＣꜾȻ",D:"ＤĐƋƊƉꝹ",E:"ＥƐƎ",F:"ＦƑꝻ",G:"ＧꞠꝽꝾ",H:"ＨĦⱧⱵꞍ",I:"ＩƗ",J:"ＪɈ",K:"ＫꞢ",L:"ＬꝆꞀ",M:"ＭⱮƜ",N:"ＮȠƝꞐꞤ",O:"ＯǪǬØǾƆƟꝊꝌ",P:"ＰƤⱣꝐꝒꝔ",Q:"ＱꝖꝘɊ",R:"ＲɌⱤꝚꞦꞂ",S:"ＳẞꞨꞄ",T:"ＴŦƬƮȾꞆ",U:"ＵɄ",V:"ＶƲꝞɅ",W:"ＷⱲ",X:"Ｘ",Y:"ＹɎỾ",Z:"ＺƵȤⱿⱫꝢ",a:"ａąⱥɐ",b:"ｂƀƃɓ",c:"ｃȼꜿↄ",d:"ｄđƌɖɗꝺ",e:"ｅɇɛǝ",f:"ｆḟƒꝼ",g:"ｇɠꞡᵹꝿ",h:"ｈħⱨⱶɥ",i:"ｉɨı",j:"ｊɉ",k:"ｋƙⱪꝁꝃꝅꞣ",l:"ｌſłƚɫⱡꝉꞁꝇ",m:"ｍɱɯ",n:"ｎƞɲŉꞑꞥ",o:"ｏǫǭøǿɔꝋꝍɵ",p:"ｐƥᵽꝑꝓꝕ",q:"ｑɋꝗꝙ",r:"ｒɍɽꝛꞧꞃ",s:"ｓꞩꞅẛ",t:"ｔŧƭʈⱦꞇ",u:"ｕưừứữửựųṷṵʉ",v:"ｖʋꝟʌ",w:"ｗⱳ",x:"ｘ",y:"ｙɏỿ",z:"ｚƶȥɀⱬꝣ",AA:"Ꜳ",AE:"ÆǼǢ",AO:"Ꜵ",AU:"Ꜷ",AV:"ꜸꜺ",AY:"Ꜽ",DZ:"ǱǄ",Dz:"ǲǅ",LJ:"Ǉ",Lj:"ǈ",NJ:"Ǌ",Nj:"ǋ",OI:"Ƣ",OO:"Ꝏ",OU:"Ȣ",TZ:"Ꜩ",VY:"Ꝡ",aa:"ꜳ",ae:"æǽǣ",ao:"ꜵ",au:"ꜷ",av:"ꜹꜻ",ay:"ꜽ",dz:"ǳǆ",hv:"ƕ",lj:"ǉ",nj:"ǌ",oi:"ƣ",ou:"ȣ",oo:"ꝏ",ss:"ß",tz:"ꜩ",vy:"ꝡ"}),i={A:"ÀÁÂẦẤẪẨÃĀĂẰẮẴẲȦǠÄǞẢÅǺǍȀȂẠẬẶḀĄ",B:"ḂḄḆ",C:"ĆĈĊČÇḈƇ",D:"ḊĎḌḐḒḎ",E:"ÈÉÊỀẾỄỂẼĒḔḖĔĖËẺĚȄȆẸỆȨḜĘḘḚ",F:"Ḟ",G:"ǴĜḠĞĠǦĢǤƓ",H:"ĤḢḦȞḤḨḪ",I:"ÌÍÎĨĪĬİÏḮỈǏȈȊỊĮḬ",J:"Ĵ",K:"ḰǨḲĶḴƘⱩꝀꝂꝄ",L:"ĿĹĽḶḸĻḼḺŁȽⱢⱠꝈ",M:"ḾṀṂ",N:"ǸŃÑṄŇṆŅṊṈ",O:"ÒÓÔỒỐỖỔÕṌȬṎŌṐṒŎȮȰÖȪỎŐǑȌȎƠỜỚỠỞỢỌỘ",P:"ṔṖ",Q:"",R:"ŔṘŘȐȒṚṜŖṞ",S:"ŚṤŜṠŠṦṢṨȘŞⱾ",T:"ṪŤṬȚŢṰṮ",U:"ÙÚÛŨṸŪṺŬÜǛǗǕǙỦŮŰǓȔȖƯỪỨỮỬỰỤṲŲṶṴ",V:"ṼṾ",W:"ẀẂŴẆẄẈ",X:"ẊẌ",Y:"ỲÝŶỸȲẎŸỶỴƳ",Z:"ŹẐŻŽẒẔ",a:"ẚàáâầấẫẩãāăằắẵẳȧǡäǟảåǻǎȁȃạậặḁ",b:"ḃḅḇ",c:"ćĉċčçḉƈ",d:"ḋďḍḑḓḏ",e:"èéêềếễểẽēḕḗĕėëẻěȅȇẹệȩḝęḙḛ",f:"",g:"ǵĝḡğġǧģǥ",h:"ĥḣḧȟḥḩḫẖ",i:"ìíîĩīĭïḯỉǐȉȋịįḭ",j:"ĵǰ",k:"ḱǩḳķḵ",l:"ŀĺľḷḹļḽḻ",m:"ḿṁṃ",n:"ǹńñṅňṇņṋṉ",o:"òóôồốỗổõṍȭṏōṑṓŏȯȱöȫỏőǒȍȏơờớỡởợọộ",p:"ṕṗ",q:"",r:"ŕṙřȑȓṛṝŗṟ",s:"śṥŝṡšṧṣṩșşȿ",t:"ṫẗťṭțţṱṯ",u:"ùúûũṹūṻŭüǜǘǖǚủůűǔȕȗụṳ",v:"ṽṿ",w:"ẁẃŵẇẅẘẉ",x:"ẋẍ",y:"ỳýŷỹȳẏÿỷẙỵƴ",z:"źẑżžẓẕ"};for(t in e)e[t]=new RegExp("["+e[t]+"]","g");for(t in i)i[t]=new RegExp("["+i[t]+"]","g");this.replaceList=e,this.normalizeList=i},updateSetting:function(t,e){var o=_.clone(this.get("settings"));if(o[t]!==e){switch(t){case"blockPMs":app.send(e?"/blockpms "+e:"/unblockpms");break;case"blockChallenges":app.send(e?"/blockchallenges":"/unblockchallenges");break;case"language":app.send("/language "+e);break;default:throw new TypeError("Unknown setting:"+t)}o[t]=e,this.set("settings",o)}},getActionPHP:function(){var t="/~~"+Config.server.id+"/action.php";return Config.testclient&&(t="https://"+Config.routes.client+t),(this.getActionPHP=function(){return t})()},finishRename:function(t,e){var o;"<!doctype html"===e.slice(0,14).toLowerCase()&&0<(o=e.indexOf(">"))&&(e=e.slice(o+1)),0<=(e="\n"===(e="\r"===e.charAt(0)?e.slice(1):e).charAt(0)?e.slice(1):e).indexOf("<")?app.addPopupMessage("Something is interfering with our connection to the login server. Most likely, your internet provider needs you to re-log-in, or your internet provider is blocking Pokémon Showdown."):";"===e?this.trigger("login:authrequired",t):";;@gmail"===e?this.trigger("login:authrequired",t,"@gmail"):";;"===e.substr(0,2)?this.trigger("login:invalidname",t,e.substr(2)):0<=e.indexOf("\n")||!e?app.addPopupMessage("Something is interfering with our connection to the login server."):app.send("/trn "+t+",0,"+e)},rename:function(e){for(var t in e=e.replace(/[\|,;]+/g,""),this.replaceList)e=e.replace(this.replaceList[t],t);for(var t in this.normalizeList)e=e.replace(this.normalizeList[t],t);var o,i=toUserid(e);i?this.get("userid")!==i?R.post((o=this).getActionPHP(),{act:"getassertion",userid:i,challstr:this.challstr},function(t){o.finishRename(e,t)}):app.send("/trn "+e):app.addPopupMessage("Usernames must contain at least one letter.")},passwordRename:function(e,t,o){var i=this;R.post(this.getActionPHP(),{act:"login",name:e,pass:t,challstr:this.challstr},Storage.safeJSON(function(t){if(t&&t.curuser&&t.curuser.loggedin)i.set("registered",t.curuser),i.finishRename(e,t.assertion);else{if("@gmail"===o)try{gapi.auth2.getAuthInstance().signOut()}catch(t){}app.addPopup(LoginPasswordPopup,{username:e,error:t.error||"Wrong password.",special:o})}}),"text")},challstr:"",receiveChallstr:function(t){var e;t&&(this.challstr=t,R.post((e=this).getActionPHP(),{act:"upkeep",challstr:this.challstr},Storage.safeJSON(function(t){e.loaded=!0,t.username?(t.username=t.username.replace(/[\|,;]+/g,""),t.loggedin&&e.set("registered",{username:t.username,userid:toUserid(t.username)}),e.finishRename(t.username,t.assertion)):app.topbar.updateUserbar()}),"text"))},logout:function(){R.post(this.getActionPHP(),{act:"logout",userid:this.get("userid")}),app.send("/logout"),app.trigger("init:socketclosed","You have been logged out and disconnected.<br /><br />If you wanted to change your name while staying connected, use the 'Change Name' button or the '/nick' command.",!1),app.socket.close()},setPersistentName:function(t){location.host===Config.routes.client&&R.cookie("showdown_username",void 0!==t?t:this.get("name"),{expires:14})}}),k=(this.App=Backbone.Router.extend({root:"/",routes:{"*path":"dispatchFragment"},events:{"submit form":"submitSend"},focused:!0,initialize:function(){(window.app=this).initializeRooms(),this.initializePopups(),this.user=new t,this.ignore={},this.supports={},this.addRoom(""),this.topbar=new Topbar({el:R("#header")}),this.down?this.isDisconnected=!0:(document.location.hostname===Config.routes.client||Config.testclient?this.addRoom("rooms",null,!0):this.addRoom("lobby",null,!0),Storage.whenPrefsLoaded(function(){if(Config.server.registered){void 0!==Dex.prefs("notournaments")&&(Storage.prefs("tournaments",Dex.prefs("notournaments")?"hide":"notify"),Storage.prefs("notournaments",null,!0));var t=Dex.prefs("autojoin")||"",e=[];if("string"==typeof t?"showdown"!==Config.server.id&&(t=""):t=t[Config.server.id]||"",t)for(var o=t.split(","),i=0;i<o.length;i++){var s=toRoomid(o[i]);app.addRoom(s,null,!0,o[i]),"staff"===s||"upperstaff"===s||"showdown"!==Config.server.id&&"lobby"===s||e.push(s)}app.send("/autojoin "+e.join(","));t=Dex.prefs("serversettings")||{};Object.keys(t).length&&app.user.set("settings",t),Backbone.history.start({pushState:!1}),app.ignore=app.loadIgnore()}else app.send("/autojoin"),Backbone.history.start({pushState:!1})}));var o=this;Storage.whenPrefsLoaded(function(){Storage.prefs("bg",null);var t=Dex.prefs("mute"),t=(BattleSound.setMute(t),Dex.prefs("theme")),e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)"),t="dark"===t||"system"===t&&e&&e.matches,t=(R("html").toggleClass("dark",t),e&&"not all"!==e.media&&e.addEventListener("change",function(t){"system"===Dex.prefs("theme")&&R("html").toggleClass("dark",t.matches)}),Dex.prefs("effectvolume")),e=(void 0!==t&&BattleSound.setEffectVolume(t),Dex.prefs("musicvolume"));void 0!==e&&BattleSound.setBgmVolume(e),Dex.prefs("logchat")&&Storage.startLoggingChat(),Dex.prefs("showdebug")&&(t=".debug {display: block;}",(e=R("#debugstyle").get(0))?e.innerHTML=t:R("head").append('<style id="debugstyle">'+t+"</style>")),Dex.prefs("onepanel")&&(o.singlePanelMode=!0,o.updateLayout()),(Dex.prefs("bwgfx")||Dex.prefs("noanim"))&&Dex.loadSpriteData("bw")}),this.on("init:unsupported",function(){o.addPopupMessage("Your browser is unsupported.")}),this.on("init:nothirdparty",function(){o.addPopupMessage("You have third-party cookies disabled in your browser, which is likely to cause problems. You should enable them and then refresh this page.")}),this.on("init:socketclosed",function(t,e){o.isDisconnected||(clearTimeout(this.hostCheckInterval),this.hostCheckInterval=null,!(o.isDisconnected=!0)===e||!o.popups.length&&o.focused||!window.Notification||(o.rooms[""].requestNotifications(),o.rooms[""].notifyOnce("Disconnected","You have been disconnected from Pokémon Showdown.","disconnected")),o.rooms[""].updateFormats(),R(".pm-log-add form").html("<small>You are disconnected and cannot chat.</small>"),R(".chat-log-add").html("<small>You are disconnected and cannot chat.</small>"),R(".battle-log-add").html("<small>You are disconnected and cannot chat.</small>"),o.reconnectPending=t||!0,o.popups.length||o.addPopup(i,{message:t}))}),this.on("init:connectionerror",function(){o.isDisconnected=!0,o.rooms[""].updateFormats(),o.addPopup(i,{cantconnect:!0})}),this.user.on("login:invalidname",function(t,e){o.addPopup(LoginPopup,{name:t,reason:e})}),this.user.on("login:authrequired",function(t,e){o.addPopup(LoginPasswordPopup,{username:t,special:e})}),this.on("response:savereplay",this.uploadReplay,this),this.on("response:rooms",this.roomsResponse,this),(window.nodewebkit?(nwWindow.on("focus",function(){o.focused||(o.focused=!0,o.curRoom&&o.curRoom.dismissNotification(),o.curSideRoom&&o.curSideRoom.dismissNotification())}),nwWindow):(R(window).on("focus click",function(){o.focused||(o.focused=!0,o.curRoom&&o.curRoom.dismissNotification(),o.curSideRoom&&o.curSideRoom.dismissNotification())}),R(window))).on("blur",function(){o.focused=!1}),R(window).on("beforeunload",function(t){if(!(Config.server&&"localhost"===Config.server.host||app.isDisconnected)){for(var e in o.rooms){e=o.rooms[e];if(e&&e.requestLeave&&!e.requestLeave())return t.returnValue="You have active battles.",t.returnValue}return Dex.prefs("refreshprompt")?(t.returnValue="Are you sure you want to refresh?",t.returnValue):void 0}}),R(window).on("keydown",function(t){var e,o=t.target,i=o.tagName.toUpperCase(),o="TEXTAREA"===i&&!o.value.length||"BUTTON"===i,i=-1!==navigator.userAgent.indexOf("Mac");70===t.keyCode&&window.nodewebkit&&(i?t.metaKey:t.ctrlKey)?(t.preventDefault(),t.stopImmediatePropagation(),e=window.getSelection().toString(),(e=window.prompt("find?",e))&&window.find(e)):71===t.keyCode&&window.nodewebkit&&(i?t.metaKey:t.ctrlKey)?(t.preventDefault(),t.stopImmediatePropagation(),(e=window.getSelection().toString())&&window.find(e)):app.curSideRoom&&R(t.target).closest(app.curSideRoom.$el).length?t.shiftKey&&37===t.keyCode&&o?app.moveRoomBy(app.curSideRoom,-1)&&(t.preventDefault(),t.stopImmediatePropagation()):t.shiftKey&&39===t.keyCode&&o?app.moveRoomBy(app.curSideRoom,1)&&(t.preventDefault(),t.stopImmediatePropagation()):37===t.keyCode&&o||window.nodewebkit&&t.ctrlKey&&t.shiftKey&&9===t.keyCode?app.focusRoomBy(app.curSideRoom,-1)&&(t.preventDefault(),t.stopImmediatePropagation()):(39===t.keyCode&&o||window.nodewebkit&&t.ctrlKey&&9===t.keyCode)&&app.focusRoomBy(app.curSideRoom,1)&&(t.preventDefault(),t.stopImmediatePropagation()):t.shiftKey&&37===t.keyCode&&o?app.moveRoomBy(app.curRoom,-1)&&(t.preventDefault(),t.stopImmediatePropagation()):t.shiftKey&&39===t.keyCode&&o?app.moveRoomBy(app.curRoom,1)&&(t.preventDefault(),t.stopImmediatePropagation()):37===t.keyCode&&o||window.nodewebkit&&t.ctrlKey&&t.shiftKey&&9===t.keyCode?app.focusRoomBy(app.curRoom,-1)&&(t.preventDefault(),t.stopImmediatePropagation()):(39===t.keyCode&&o||window.nodewebkit&&t.ctrlKey&&9===t.keyCode)&&app.focusRoomBy(app.curRoom,1)&&(t.preventDefault(),t.stopImmediatePropagation())}),Storage.whenAppLoaded.load(this),this.initializeConnection()},initializeConnection:function(){Storage.whenPrefsLoaded(function(){app.connect()})},connect:function(){if(!this.down){if(Config.bannedHosts)for(var t=0;t<Config.bannedHosts.length;t++){var e=Config.bannedHosts[t];if("string"==typeof e?Config.server.host===e:e.test(Config.server.host)){Config.server.banned=!0;break}}var i,o,s,n,a,r;Config.server.banned?this.addPopupMessage("This server has either been deleted for breaking US law or PS global rules, or it is hosted on a platform that's often used to host rulebreaking servers."):(o=function(){var t=443===Config.server.port||Config.server.https?"https":"http";Config.server.host=R.trim(Config.server.host);try{return"localhost"===Config.server.host?(console.log("Bypassing SockJS for localhost"),console.log("ws"+t.slice("4")+"://"+Config.server.host+":"+Config.server.port+Config.sockjsprefix+"/websocket"),new WebSocket("ws"+t.slice("4")+"://"+Config.server.host+":"+Config.server.port+Config.sockjsprefix+"/websocket")):new SockJS(t+"://"+Config.server.host+":"+Config.server.port+Config.sockjsprefix,[],{timeout:3e5})}catch(t){return i.trigger("init:connectionerror"),null}},(i=this).socket=o(),s=!1,n=Config.server.port===Config.server.altport,a=!1,this.socket.onopen=function(){s=!0,n&&window.ga,i.trigger("init:socketopened");var t=Dex.prefs("avatar");if(t&&i.send("/avatar "+t+",1"),i.sendQueue){var e=i.sendQueue;delete i.sendQueue;for(var o=0;o<e.length;o++)i.send(e[o],!0)}this.hostCheckInterval=setTimeout(function t(){Config.server.host!==R.trim(Config.server.host)?app.socket.close():app.hostCheckInterval=setTimeout(t,500)},500)},this.socket.onmessage=function(t){window.console&&console.log&&console.log("<< "+t.data),i.receive(t.data)},r=function(t){var e=o();return e.onopen=t.onopen,e.onmessage=t.onmessage,e.onclose=t.onclose,e},this.socket.onclose=function(){if(!s)return Config.server.altport&&!n?(n=!0,Config.server.port=Config.server.altport,void(i.socket=r(i.socket))):a?i.trigger("init:connectionerror"):(a=!0,Config.sockjsprefix="",void(i.socket=r(i.socket)));i.trigger("init:socketclosed")})}},dispatchFragment:function(t){!Config.testclient&&location.search&&window.history&&history.replaceState(null,null,location.pathname),t&&t.includes(".")&&(t=""),this.fragment=t=toRoomid(t||""),void 0===this.initialFragment&&(this.initialFragment=t),this.tryJoinRoom(t),this.updateTitle(this.rooms[t])},send:function(t,e){e&&!0!==e?t=e+"|"+t:!0!==e&&(t="|"+t),this.socket&&this.socket.readyState===SockJS.OPEN?(window.console&&console.log&&console.log(">> "+t),this.socket.send(t)):(this.sendQueue||(this.sendQueue=[]),this.sendQueue.push(t))},serializeForm:function(t,e){for(var o=t.querySelectorAll("input[name], select[name], textarea[name], keygen[name]"),i=[],s=0;s<o.length;s++){var n=o[s];"checkbox"===n.type&&!n.value&&e?i.push([n.name,n.checked?"on":"off"]):["checkbox","radio"].includes(n.type)&&!n.checked||i.push([n.name,n.value])}return i},submitSend:function(t){var e=t.currentTarget,o=e.getAttribute("data-submitsend");if(o){for(var i=o,s=this.serializeForm(e,!0),n=0;n<s.length;n++)i=i.replace("{"+s[n][0]+"}",s[n][1]);i=i.replace(/\{[a-z]+\}/g,""),this.send(i),t.currentTarget.innerText="Submitted!",t.preventDefault(),t.stopPropagation()}},sendTeam:function(t){var e=""+Storage.getPackedTeam(t);102394<e.length?alert("Your team is over 100 KB, usually caused by having over 600 Pokemon in it. Please use a smaller team."):this.send("/utm "+e)},receive:function(t){var o,e,i,s,n,a="",r=!1;if(">"===t.charAt(0)){if((c=t.indexOf("\n"))<0)return;a=toRoomid(t.substr(1,c-1)),t=t.substr(c+1)}if("|init|"===t.substr(0,6)){var a=a||"lobby",p=t.substr(6),u=p.indexOf("\n");0<=u&&(p=p.substr(0,u)),p=toID(p),this.rooms[a]||"staff"===a||"upperstaff"===a?this.addRoom(a,p,!0):this.joinRoom(a,p,!0),"chat"===p&&(r=!0)}else{if("|expire|"===(t+"|").substr(0,8))return void((u=this.rooms[a])&&(u.expired=t.substr(8)||!0,u.updateUser&&u.updateUser()));if("|deinit|"===(t+"|").substr(0,8)||"|noinit|"===(t+"|").substr(0,8))return a=a||"lobby",this.rooms[a]&&this.rooms[a].expired?void 0:(p="d"===t.charAt(1),0<=(u=(t=t.substr(8)).indexOf("|"))&&(o=t.substr(u+1),t=t.substr(0,u)),void("namerequired"===t?(e=this).once("init:choosename",function(){e.send("/join "+a)}):"rename"===t?(n=o.split("|"),this.renameRoom(a,n[0],n[1])):"nonexistent"===t&&Config.server.id&&"battle-replay-"===a.slice(0,14)&&o?(s="https://cdn.discordapp.com/attachments/988945578228604999/"+(i=a.slice(14)),R.ajax(s+"/log.txt",{dataType:"text",mode:"no-cors",headers:{"Access-Control-Allow-Origin":"*"}}).done(function(t){t?app.receive(">battle-"+i+"\n|init|battle\n|title|SPC Legacy Replay\n"+t):(o+="\n\nResponse received, but no data.",app.addPopupMessage(o))}).fail(function(){app.removeRoom(a,!0),o+="\n\nThe battle you're looking for has expired. Battles expire after 15 minutes of inactivity unless they're saved.\nIn the future, remember to click \"Save replay\" to save a replay permanently.",app.addPopupMessage(o)})):"nonexistent"===t&&Config.server.id&&"battle-"===a.slice(0,7)&&o?(i=a.slice(7),"showdown"!==Config.server.id&&(i=Config.server.id+"-"+i),s="https://"+Config.routes.replays+"/"+i,R.ajax(s+".json",{dataType:"json"}).done(function(t){var e;t?(e=t.p1+" vs. "+t.p2,app.receive(">battle-"+i+"\n|init|battle\n|title|"+e+"\n"+t.log),app.receive(">battle-"+i+"\n|expire|<a href="+s+' target="_blank" class="no-panel-intercept">Open replay in new tab</a>')):(o+="\n\nResponse received, but no data.",app.addPopupMessage(o))}).fail(function(){app.removeRoom(a,!0),o+="\n\nThe battle you're looking for has expired. Battles expire after 15 minutes of inactivity unless they're saved.\nIn the future, remember to click \"Save replay\" to save a replay permanently.",app.addPopupMessage(o)})):(p?this.rooms[a]&&"chat"===this.rooms[a].type?(this.removeRoom(a,!0),this.updateAutojoin()):this.removeRoom(a,!0):(this.unjoinRoom(a),"lobby"===a&&this.joinRoom("rooms")),o&&this.addPopupMessage(o))));"|N|"===t.substr(0,3)&&(u=t.substr(1).split("|"),app.ignore[toUserid(u[2])]&&(app.ignore[toUserid(u[1])]=1))}if(a)this.rooms[a]&&this.rooms[a].receive(t),r&&this.updateAutojoin();else switch((n="|"===t.charAt(0)?t.substr(1).split("|"):[])[0]){case"customgroups":0<(c=t.indexOf("\n"))&&this.receive(t.substr(c+1));var l=t.slice(14,c);this.parseGroups(l);break;case"challstr":n[2]?this.user.receiveChallstr(n[1]+"|"+n[2]):this.user.receiveChallstr(n[1]);break;case"formats":this.parseFormats(n);break;case"updateuser":0<(c=t.indexOf("\n"))&&(this.receive(t.substr(c+1)),n=t.slice(1,c).split("|"));var c,l=BattleTextParser.parseNameParts(n[1]),d=!!+n[2],h=toUserid(l.name),m=(h===this.user.get("userid")&&l.name!==this.user.get("name")&&R.post(app.user.getActionPHP(),{act:"changeusername",username:l.name},function(){},"text"),_.clone(app.user.get("settings")));if(4<n.length){var f,g=JSON.parse(n[4]);for(f in g)m[f]=g[f]}this.user.set({name:l.name,userid:h,named:d,avatar:n[3],settings:m,status:l.status,away:l.away}),this.user.setPersistentName(d?l.name:null),d&&this.trigger("init:choosename"),app.ignore[h]&&(delete app.ignore[h],app.saveIgnore());break;case"nametaken":app.addPopup(LoginPopup,{name:n[1]||"",error:n[2]||""});break;case"queryresponse":l=JSON.parse(t.substr(16+n[1].length));app.trigger("response:"+n[1],l);break;case"updatechallenges":this.rooms[""]&&this.rooms[""].updateChallenges(JSON.parse(t.substr(18)));break;case"updatesearch":this.rooms[""]&&this.rooms[""].updateSearch(JSON.parse(t.substr(14)));break;case"popup":var b,d="semimodal";"|wide|"===(t=t.substr(7)).substr(0,6)&&(t=t.substr(6),b=960),"|modal|"===t.substr(0,7)&&(t=t.substr(7),d="modal"),"|html|"===t.substr(0,6)?(t=t.substr(6),app.addPopup(k,{type:d,maxWidth:b,htmlMessage:BattleLog.sanitizeHTML(t)})):app.addPopup(k,{type:d,maxWidth:b,message:t.replace(/\|\|/g,"\n")}),this.rooms[""]&&this.rooms[""].resetPending();break;case"disconnect":app.trigger("init:socketclosed",BattleLog.sanitizeHTML(t.substr(12)));break;case"pm":for(var v=t.split("\n"),y=0;y<v.length;y++){var w=(n=v[y].slice(1).split("|")).slice(3).join("|");this.rooms[""].addPM(n[1],w,n[2]),toUserid(n[1])!==app.user.get("userid")&&(app.user.lastPM=toUserid(n[1]))}break;case"roomerror":this.unjoinRoom(n[1]),this.addPopupMessage(n.slice(2).join("|"));break;case"refresh":document.location.reload(!0);break;case"c":case"chat":if("~"===n[1]&&"/warn "===n[2].substr(0,6)){app.addPopup(C,{warning:n[2].substr(6)});break}default:this.rooms.lobby&&this.rooms.lobby.receive(t)}},saveIgnore:function(){Storage.prefs("ignorelist",Object.keys(this.ignore))},loadIgnore:function(){var t=Storage.prefs("ignorelist");if(!t)return{};for(var e={},o=0;o<t.length;o++)e[t[o]]=1;return e},parseGroups:function(t){var e=null;try{e=JSON.parse(t)}catch(t){}if(e){for(var o={},i=0;i<e.length;i++){var s,n,a=e[i];a&&(s=a.symbol||" ",n=a.name,"normal"!==(a=a.type||"user")||Config.defaultOrder||(Config.defaultOrder=i+.5),n||(Config.defaultGroup=s),o[s]={name:n?BattleLog.escapeHTML(n+" ("+s+")"):null,type:a,order:i+1})}Config.groups=o}},parseFormats:function(t){var e=!1,o="",i=0,s=!1;window.NonBattleGames={rps:"Rock Paper Scissors"},window.BattleFormats={};for(var n,a,r,p,u,l,c,d,h,m,f=1;f<t.length;f++)e?(o=t[f],e=!1):",LL"===t[f]?app.localLadder=!0:""===t[f]||","===t[f].charAt(0)&&!isNaN(t[f].substr(1))?(e=!0,t[f]&&i!==(a=parseInt(t[f].substr(1),10)||0)&&(i=a,s=!0)):(u=!(p=r=a=!0),c=l=null,d=0<=(h=(n=t[f]).lastIndexOf(","))?parseInt(n.substr(h+1),16):NaN,isNaN(d)?(",#"===n.substr(n.length-2)&&(l="preset",n=n.substr(0,n.length-2)),",,"===n.substr(n.length-2)?(r=!1,n=n.substr(0,n.length-2)):","===n.substr(n.length-1)&&(a=!1,n=n.substr(0,n.length-1))):(n=n.substr(0,h),1&d&&(l="preset"),2&d||(a=!1),4&d||(r=!1),8&d||(p=!1),16&d&&(c=50),32&d&&(u=!0)),g=toID(n),h=b="",(d=!l&&!n.includes("Custom Game"))&&(h=n,(h=0<(m=(h="gen"!==g.slice(0,3)?"[Gen 6] "+n:h).indexOf("("))&&")"===n.slice(-1)?R.trim(h.slice(0,m)):h)!==n&&((b=(b=toID(h)).startsWith("gen8nd")?"gen8nationaldex"+b.slice(6):b).startsWith("gen8natdex")&&(b="gen8nationaldex"+b.slice(10)),BattleFormats[b]?BattleFormats[b].isTeambuilderFormat=!0:BattleFormats[b]={id:b,name:h,team:l,section:o,column:i,rated:!1,isTeambuilderFormat:!0,effectType:"Format"},d=!1)),BattleFormats[g]&&BattleFormats[g].isTeambuilderFormat&&(d=!0),BattleFormats[g]&&delete BattleFormats[g],BattleFormats[g]={id:g,name:n,team:l,section:o,column:i,searchShow:a,challengeShow:r,tournamentShow:p,rated:a&&"unrated"!==g.substr(4,7),teambuilderLevel:c,partner:u,teambuilderFormat:b,isTeambuilderFormat:d,effectType:"Format"});var g,b,v={};for(g in BattleFormats)!(b=BattleFormats[BattleFormats[g].teambuilderFormat])||v[b.id]||b.searchShow||b.challengeShow||b.tournamentShow||(b.battleFormat?(v[b.id]=1,b.battleFormat=""):b.battleFormat=g);s&&(app.supports.formatColumns=!0),this.trigger("init:formats")},uploadReplay:function(t){var o=t.id,e=Config.server.id&&toID(Config.server.id.split(":")[0]),i=t.silent;e&&"showdown"!==e&&(o=e+"-"+o),R.post(app.user.getActionPHP(),{act:"uploadreplay",log:t.log,serverid:e,password:t.password||"",id:o},function(t){var e;i||("success"===(e=t.split(":"))[0]?app.addPopup(n,{id:e[1]||o}):"hash mismatch"===t?app.addPopupMessage("Someone else is already uploading a replay of this battle. Try again in five seconds."):"not found"===t?app.addPopupMessage("This server isn't registered, and doesn't support uploading replays."):"invalid id"===t?app.addPopupMessage("This server is using invalid battle IDs, so this replay can't be uploaded."):app.addPopupMessage("Error while uploading replay: "+t))})},roomsResponse:function(t){t&&(this.roomsData=t),app.topbar.updateTabbar()},addGlobalListeners:function(){R(document).on("click","a",function(t){if("closebutton"!==this.className&&!(0<=this.className.indexOf("minilogo"))&&this.href){var e=this.host===Config.routes.replays&&"showdown"===Config.server.id;if((e||[Config.routes.client,"psim.us",location.host].includes(this.host))&&"no-panel-intercept"!==this.className&&!t.cmdKey&&!t.metaKey&&!t.ctrlKey){var o=this.pathname.substr(1);if("report"===(o="appeal"!==o&&"appeals"!==o?o:"view-help-request--appeal")&&(o="view-help-request--report"),e&&(o&&"search"!==o?"battle-"!==o.slice(0,7)&&(o="battle-"+o):o="."),o.indexOf("/")<0&&o.indexOf(".")<0&&!/^(rooms?suggestions?|suggestions?|adminrequests?|bugs?|bugreports?|rules?|faq|credits?|news|privacy|contact|dex|insecure|replays?|forgotpassword|devdiscord)$/.test(o))return this.dataset&&"replace"===this.dataset.target&&(e=R(this).closest(".ps-room")[0])&&e.id&&(e=e.id.slice(5),window.app.renameRoom(e,o),window.app.rooms[o].join(),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation()),window.app.tryJoinRoom(o),t.preventDefault(),t.stopPropagation(),void t.stopImmediatePropagation()}window.nodewebkit&&"_blank"===this.target?(gui.Shell.openExternal(this.href),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation()):"noopener"===this.rel?(Dex.prefs("chatformatting")||{}).hideinterstice||BattleLog.interstice.isWhitelisted(this.href)||(this.href=BattleLog.interstice.getURI(this.href)):"_blank"===this.target&&(this.rel="noopener")}})},initializeRooms:function(){this.rooms=Object.create(null),this.roomList=[],this.sideRoomList=[],R(window).on("resize",_.bind(this.resize,this))},fixedWidth:!0,resize:function(){window.screen&&screen.width&&320<=screen.width?this.fixedWidth&&(document.getElementById("viewport").setAttribute("content","width=device-width"),this.fixedWidth=!1):this.fixedWidth||(document.getElementById("viewport").setAttribute("content","width=320"),this.fixedWidth=!0),!app.roomsFirstOpen&&!this.down&&916<=R(window).width()&&document.location.hostname===Config.routes.client&&this.addRoom("rooms"),this.updateLayout()},curRoom:null,curSideRoom:null,sideRoom:null,joinRoom:function(t,e,o){if(this.rooms[t])return this.focusRoom(t),this.rooms[t].rejoin&&this.rooms[t].rejoin(),this.rooms[t];"battle-gen5"!==t.substr(0,11)||Dex.loadedSpriteData.bw||Dex.loadSpriteData("bw");var i=this._addRoom(t,e,o);return this.focusRoom(t),i},unjoinRoom:function(t,e){this.removeRoom(t,!0),this.curRoom&&this.navigate(this.curRoom.id,{replace:!0}),this.updateAutojoin()},tryJoinRoom:function(t){this.joinRoom(t)},addRoom:function(t,e,o,i){this._addRoom(t,e,o,i),this.updateSideRoom(),this.updateLayout()},_addRoom:function(t,e,o,i){if(this.rooms[t]){if(!e||this.rooms[t].type===e)return this.rooms[t];var s=this.rooms[t],n=this.roomList.indexOf(s);0<=n&&this.roomList.splice(n,1),0<=(n=this.sideRoomList.indexOf(s))&&this.sideRoomList.splice(n,1),s.destroy(),delete this.rooms[t]}var n=t?R('<div class="ps-room" style="display:none"></div>').appendTo("body"):R("#mainmenu"),a="",r=("string"==typeof e&&(a=e,e=null),{"":MainMenuRoom,teambuilder:TeambuilderRoom,rooms:RoomsRoom,battles:BattlesRoom,ladder:LadderRoom,lobby:ChatRoom,staff:ChatRoom,constructor:ChatRoom}),p={html:HTMLRoom,battle:BattleRoom,chat:ChatRoom},p=(e=(e=(e=a?p[a]:e)||r[t])||(t.startsWith("battle-")||t.startsWith("game-")?BattleRoom:t.startsWith("view-")?HTMLRoom:ChatRoom),this.rooms[t]=new e({id:t,el:n,nojoin:o,title:i}));return s&&(this.curRoom===s&&(this.curRoom=p),this.curSideRoom===s&&(this.curSideRoom=p),this.sideRoom===s&&(this.sideRoom=p)),["","teambuilder","ladder","rooms"].indexOf(p.id)<0&&(p.isSideRoom?this.sideRoomList:this.roomList).push(p),p},focusRoom:function(t,e){var o=this.rooms[t];return!!o&&(BattleTooltips.hideTooltip(),this.curRoom===o||this.curSideRoom===o?(o.focus(null,e),!0):(this.updateSideRoom(t),this.updateLayout(),this.curSideRoom!==o&&(this.curRoom?(this.curRoom.hide(),this.curRoom=null):this.rooms[""]&&this.rooms[""].hide(),this.curRoom=window.room=o,this.updateLayout(),this.curRoom.id===t&&(this.fragment=t,this.navigate(t),this.updateTitle(this.curRoom))),void o.focus(null,e)))},focusRoomLeft:function(t){var e=this.rooms[t];return!!e&&(this.curRoom===e?(e.focus(null,!0),!0):(this.curSideRoom===e&&(this.sideRoom=this.curSideRoom=this.sideRoomList[0]||null),e.isSideRoom=!1,this.curRoom?(this.curRoom.hide(),this.curRoom=null):this.rooms[""]&&this.rooms[""].hide(),this.curRoom=e,this.updateLayout(),this.curRoom.id===t&&this.navigate(t),void e.focus(null,!0)))},focusRoomRight:function(t){var e=this.rooms[t];return!!e&&(this.curSideRoom===e?(e.focus(null,!0),!0):(this.curRoom===e&&(this.curRoom=this.roomList[this.roomList.length-1]||this.rooms[""]),e.isSideRoom=!0,this.curSideRoom&&(this.curSideRoom.hide(),this.curSideRoom=null),this.curSideRoom=this.sideRoom=e,this.updateLayout(),void e.focus(null,!0)))},updateLayout:function(){if(this.curRoom){if(!this.sideRoom||this.singlePanelMode)this.curRoom.show("full"),this.curSideRoom&&(this.curSideRoom.hide(),this.curSideRoom=null),""===this.curRoom.id&&(R(window).width()<this.curRoom.bestWidth?this.curRoom.$el.addClass("tiny-layout"):this.curRoom.$el.removeClass("tiny-layout"));else{var t=this.curRoom.minWidth||this.curRoom.bestWidth,e=this.curRoom.minMainWidth||t,o=this.sideRoom.minWidth||this.sideRoom.bestWidth,i=R(window).width();if(this.curRoom.isSideRoom){if(i>=this.rooms[""].tinyWidth+e)this.curSideRoom=this.sideRoom=this.curRoom,this.curRoom=this.rooms[""],t=this.curRoom.tinyWidth,o=this.sideRoom.minWidth||this.sideRoom.bestWidth;else if(this.sideRoom)return this.curSideRoom&&(this.curSideRoom.hide(),this.curSideRoom=null),this.curRoom.show("full"),void this.topbar.updateTabbar()}else""===this.curRoom.id&&(e=t=this.curRoom.tinyWidth);if(i<e+o)this.curSideRoom&&(this.curSideRoom.hide(),this.curSideRoom=null),R(window).width()<this.curRoom.bestWidth?this.curRoom.$el.addClass("tiny-layout"):this.curRoom.$el.removeClass("tiny-layout"),this.curRoom.show("full");else{if(this.curSideRoom=this.sideRoom,t===this.curRoom.tinyWidth){if(i<this.curRoom.bestWidth+570)return this.curRoom.show("left",t),this.curRoom.$el.addClass("tiny-layout"),this.curSideRoom.show("right",t),void this.topbar.updateTabbar();t=this.curRoom.minWidth||this.curRoom.bestWidth,this.curRoom.$el.removeClass("tiny-layout")}var s=this.curRoom.maxWidth||this.curRoom.bestWidth,n=this.sideRoom.maxWidth||this.sideRoom.bestWidth,a=t;s+n<=i?a=s:0<(n=s-t+n-o)&&(a=Math.floor(t+(s-t)*(i-t-o)/n)),a<e&&(a=e),"battle"===this.curRoom.type&&"battle"!==this.sideRoom.type&&(0<(t=Math.floor((i-e-o)/2))&&(a+=t),s<a&&(a=s)),this.curRoom.show("left",a),this.curSideRoom.show("right",a)}}this.topbar.updateTabbar()}},updateSideRoom:function(t){if(t&&this.rooms[t].isSideRoom)this.sideRoom=this.rooms[t],this.curSideRoom&&this.curSideRoom!==this.sideRoom&&(this.curSideRoom.hide(),this.curSideRoom=this.sideRoom);else if(!this.sideRoom)for(var e in this.rooms)this.rooms[e].isSideRoom&&(this.sideRoom=this.rooms[e])},leaveRoom:function(t,e){var o=this.rooms[t];return!!o&&(!(o.requestLeave&&!o.requestLeave(e))&&this.removeRoom(t))},renameRoom:function(t,e,o){var o=o||e,i=this.rooms[t];return!!i&&(this.rooms[e]?(this.removeRoom(t,!0),!1):(i.id=e,i.battle&&(i.battle.roomid=e),i.title=o,i.$el[0].id="room-"+e,this.rooms[e]=i,delete this.rooms[t],this.updateLayout(),this.topbar.updateTabbar(),this.rooms[e]===this.curRoom&&this.updateTitle(this.rooms[e]),void this.updateAutojoin()))},removeRoom:function(t,e){var o=this.rooms[t];if(!o)return!1;o===this.curRoom&&this.focusRoom(""),delete this.rooms[t];var i=this.roomList.indexOf(o);return 0<=i&&this.roomList.splice(i,1),0<=(i=this.sideRoomList.indexOf(o))&&this.sideRoomList.splice(i,1),o.destroy(e),o===this.sideRoom&&(this.sideRoom=null,this.curSideRoom=null,this.updateSideRoom()),this.updateLayout(),!0},moveRoomBy:function(t,e){var o,i=this.roomList.indexOf(t);return 0<=i?!((o=i+e)<0)&&(o>=this.roomList.length?(this.roomList.splice(i,1),this.sideRoomList.unshift(t),this.focusRoomRight(t.id)):(this.roomList.splice(i,1),this.roomList.splice(o,0,t),this.topbar.updateTabbar()),t.focusText(),"chat"===t.type&&this.updateAutojoin(),!0):0<=(i=this.sideRoomList.indexOf(t))&&(!((o=i+e)>=this.sideRoomList.length)&&(o<0?(this.sideRoomList.splice(i,1),this.roomList.push(t),this.focusRoomLeft(t.id)):(this.sideRoomList.splice(i,1),this.sideRoomList.splice(o,0,t),this.topbar.updateTabbar()),t.focusText(),"chat"===t.type&&this.updateAutojoin(),!0))},focusRoomBy:function(t,e,o){this.arrowKeysUsed=!0;var i,s=this.roomList.concat(this.sideRoomList);return t&&"rooms"===t.id?!!s.length&&(this.focusRoom(s[e<0?s.length-1:0].id,o),!0):0<=(i=s.indexOf(t))&&(s[i=i+e]?this.focusRoom(s[i].id,o):this.joinRoom("rooms"),!0)},openInNewWindow:function(t){window.nodewebkit?gui.Shell.openExternal(t):window.open(t,"_blank")},clickLink:function(t){if(window.nodewebkit)return gui.Shell.openExternal(t.target.href),!1},roomTitleChanged:function(t){t.id===this.fragment&&this.updateTitle(t)},updateTitle:function(t){document.title=t.title?t.title+" - Showdown!":"Showdown!"},updateAutojoin:function(){if(Config.server.registered){for(var t=[],e=0,o=this.roomList.concat(this.sideRoomList),i=0;i<o.length;i++){var s=o[i];if("chat"===s.type&&(t.push(!(0<=s.id.indexOf("-"))&&s.title||s.id),"staff"!==s.id&&"upperstaff"!==s.id&&("showdown"===Config.server.id||"lobby"!==s.id)&&15<=++e))break}var n=Dex.prefs("autojoin")||"";if("string"!=typeof n){if(n[Config.server.id]===t.join(","))return;if(t.length)n[Config.server.id]=t.join(",");else{delete n[Config.server.id];var a,r=!1;for(a in n)if("showdown"!==a){r=!0;break}r||(n=n.showdown||"")}}else if("showdown"!==Config.server.id){if(!t.length)return;(n={showdown:n})[Config.server.id]=t.join(",")}else{if(n===t.join(","))return;n=t.join(",")}Storage.prefs("autojoin",n)}},playNotificationSound:function(){window.BattleSound&&!Dex.prefs("mute")&&BattleSound.playSound("audio/notification.wav",Dex.prefs("notifvolume"))},popups:null,initializePopups:function(){this.popups=[]},addPopup:function(t,e){if(void 0===(e=e||{}).sourceEl&&app.dispatchingButton&&(e.sourceEl=app.dispatchingButton),void 0===e.sourcePopup&&app.dispatchingPopup&&(e.sourcePopup=app.dispatchingPopup),!this.dismissingSource||R(e.sourceEl)[0]!==this.dismissingSource){for(;this.popups.length;){var o=this.popups[this.popups.length-1];if(e.sourcePopup===o)break;o=o.sourceEl?o.sourceEl[0]:null;if(this.popups.pop().remove(),R(e.sourceEl)[0]===o)return}var i,s=new(t=t||k)(e);return s.lastFocusedEl=document.activeElement,"normal"===s.type?R("body").append(s.el):(i=R('<div class="ps-overlay"></div>').appendTo("body").append(s.el),"semimodal"===s.type&&i.on("click",function(t){t.currentTarget===t.target&&s.close()})),s.domInitialize&&s.domInitialize(e),s.$(".autofocus").select().focus(),i&&i.scrollTop(0),this.popups.push(s),s}},addPopupMessage:function(t){app.addPopup(k,{message:t})},addPopupPrompt:function(t,e,o){var i=o?e:"OK";o=o||e,app.addPopup(s,{message:t,button:i,callback:o})},closePopup:function(t){var e;return!!this.popups.length&&((e=this.popups.pop()).lastFocusedEl&&e.lastFocusedEl.focus&&e.lastFocusedEl.focus(),e.remove(),this.reconnectPending&&this.addPopup(i,{message:this.reconnectPending}),!0)},dismissPopups:function(){for(var t=!1;this.popups.length;){var e=this.popups[this.popups.length-1];if("normal"!==e.type)return t;t=(t=e.sourceEl?e.sourceEl[0]:t)||!0,this.popups.pop().remove()}return t}}),this.Room=Backbone.View.extend({className:"ps-room",constructor:function(t){this.events||(this.events={}),this.events["click button"]||(this.events["click button"]="dispatchClickButton"),this.events.click||(this.events.click="dispatchClickBackground"),Backbone.View.apply(this,arguments),t&&t.nojoin||this.join(),t&&t.title&&(this.title=t.title),this.el.id="room-"+this.id},dispatchClickButton:function(t){var e=t.currentTarget;e.name&&(app.dismissingSource=app.dismissPopups(),app.dispatchingButton=e,t.preventDefault(),t.stopImmediatePropagation(),this[e.name](e.value,e),delete app.dismissingSource,delete app.dispatchingButton)},dispatchClickBackground:function(t){app.dismissPopups(),t.shiftKey||window.getSelection&&!window.getSelection().isCollapsed||this.focus(t)},send:function(t){app.send(t,this.id)},receive:function(t){},bestWidth:659,show:function(t,e){switch(this.leftWidth=0,t){case"left":this.$el.css({left:0,width:e,right:"auto"});break;case"right":this.$el.css({left:e+1,width:"auto",right:0}),this.leftWidth=e;break;case"full":this.$el.css({left:0,width:"auto",right:0})}this.$el.show(),this.dismissAllNotifications(!0)},hide:function(){this.blur(),this.$el.hide()},focus:function(){},blur:function(){},join:function(){},leave:function(){},requestNotifications:function(){try{window.webkitNotifications&&webkitNotifications.requestPermission?webkitNotifications.requestPermission():window.Notification&&Notification.requestPermission&&Notification.requestPermission(function(t){})}catch(t){}},notificationClass:"",notifications:null,subtleNotification:!1,notify:function(t,e,o,i){if(!i||!app.focused||this!==app.curRoom&&this!=app.curSideRoom){o=o||"message";var s=!1;if(this.notifications||(this.notifications={},s=!0),!app.focused||this!==app.curRoom&&this!=app.curSideRoom)if(window.nodewebkit&&!nwWindow.setBadgeLabel)nwWindow.requestAttention(!0);else if(window.Notification){try{var n=this.notifications[o]=new Notification(t,{lang:"en",body:e,tag:this.id+":"+o}),a=this;n.onclose=function(){a.dismissNotification(o)},n.onclick=function(){window.focus(),a.clickNotification(o)},Dex.prefs("temporarynotifications")&&(n.cancel?setTimeout(function(){n.cancel()},5e3):n.close&&setTimeout(function(){n.close()},5e3)),i&&(n.psAutoclose=!0)}catch(t){}s=!0}else n=(window.macgap&&macgap.growl.notify({title:t,content:e}),{}),this.notifications[o]=n,i&&(n.psAutoclose=!0);else this.notifications[o]={};s&&(this.notificationClass=" notifying",app.topbar.updateTabbar())}},subtleNotifyOnce:function(){app.focused&&(this===app.curRoom||this==app.curSideRoom)||this.notifications||this.subtleNotification||(this.subtleNotification=!0,this.notificationClass=" subtle-notifying",app.topbar.updateTabbar())},notifyOnce:function(t,e,o){return this.notify(t,e,o,!0)},closeNotification:function(t,e){if(!t)return this.closeAllNotifications();if(window.nodewebkit&&nwWindow.requestAttention(!1),this.notifications&&this.notifications[t]){if(!e)try{this.notifications[t].close()}catch(t){}delete this.notifications[t],_.isEmpty(this.notifications)&&(this.notifications=null,this.notificationClass=this.subtleNotification?" subtle-notifying":"",app.topbar.updateTabbar())}},closeAllNotifications:function(t){if(this.notifications||this.subtleNotification){if(window.nodewebkit&&nwWindow.requestAttention(!1),this.subtleNotification=!1,this.notifications){for(var e in this.notifications)try{this.notifications[e].close()}catch(t){}this.notifications=null}this.notificationClass="",t||app.topbar.updateTabbar()}},dismissNotification:function(t){if(!t)return this.dismissAllNotifications();if(window.nodewebkit&&nwWindow.requestAttention(!1),this.notifications&&this.notifications[t]){try{this.notifications[t].close()}catch(t){}var e;this.notifications&&!this.notifications[t]&&(this.notifications[t].psAutoclose?(delete this.notifications[t],this.notifications&&!_.isEmpty(this.notifications)||(this.notifications=null,this.notificationClass=this.subtleNotification?" subtle-notifying":"",app.topbar.updateTabbar())):this.notifications[t]={},this.lastMessageDate&&((e=Dex.prefs("logtimes")||(Storage.prefs("logtimes",{}),Dex.prefs("logtimes")))[Config.server.id]||(e[Config.server.id]={}),e[Config.server.id][this.id]=this.lastMessageDate,Storage.prefs.save()))}},dismissAllNotifications:function(t){if(this.notifications||this.subtleNotification){if(window.nodewebkit&&nwWindow.requestAttention(!1),this.subtleNotification=!1,this.notifications){for(var e in this.notifications)if(this.notifications[e].psAutoclose){try{this.notifications[e].close()}catch(t){}delete this.notifications[e]}this.notifications&&!_.isEmpty(this.notifications)||(this.notifications=null)}var o;this.notifications||(this.notificationClass="",t||app.topbar.updateTabbar()),this.lastMessageDate&&((o=Dex.prefs("logtimes")||(Storage.prefs("logtimes",{}),Dex.prefs("logtimes")))[Config.server.id]||(o[Config.server.id]={}),o[Config.server.id][this.id]=this.lastMessageDate,Storage.prefs.save())}},clickNotification:function(t){this.dismissNotification(t),app.focusRoom(this.id)},close:function(){app.leaveRoom(this.id)},destroy:function(t){this.closeAllNotifications(!0),t||this.leave(),this.remove(),delete this.app}}),this.Popup=Backbone.View.extend({type:"normal",className:"ps-popup",constructor:function(t){var e,o,i,s,n,a,r,p;this.events||(this.events={}),this.events["click button"]||(this.events["click button"]="dispatchClickButton"),this.events["submit form"]||(this.events["submit form"]="dispatchSubmit"),t&&t.sourceEl&&(this.sourceEl=t.sourceEl=R(t.sourceEl)),t.type&&(this.type=t.type),t.position&&(this.position=t.position),t.buttons&&(this.buttons=t.buttons),t.submit&&(this.submit=t.submit),Backbone.View.apply(this,arguments),"normal"!==this.type||this.sourceEl||(this.type="semimodal"),"normal"!==this.type&&"semimodal"!==this.type||!this.sourceEl||(e=this.$el,o=R('<div style="position:relative;height:0;overflow:hidden"></div>').appendTo("body").append(e),e.css("position","absolute"),e.css("margin","0"),e.css("width",this.width-22),i=this.sourceEl.offset(),s=R(window).height(),n=e.outerHeight(),a=e.outerWidth(),r=this.sourceEl.outerHeight(),"right"===this.position?(s>i.top+n+5&&(i.top<2*s/3||i.top+200<s)?e.css("top",i.top):e.css("bottom",Math.max(s-i.top-r,0)),(p=i.left+this.sourceEl.outerWidth())+a>R(window).width()?e.css("right",1):e.css("left",p)):(s>i.top+r+n+5&&(i.top+r<2*s/3||i.top+r+200<s)?e.css("top",i.top+r):n+5<=i.top?e.css("bottom",Math.max(s-i.top,0)):n+10<s?e.css("bottom",5):e.css("top",0),(s=R(window).width()-i.left)<a+10?e.css("right",10):e.css("left",i.left)),e.detach(),o.remove())},initialize:function(t){this.type||(this.type="semimodal"),this.$el.html('<form><p style="white-space:pre-wrap;word-wrap:break-word">'+(t.htmlMessage||BattleLog.parseMessage(t.message))+'</p><p class="buttonbar">'+(t.buttons||'<button type="button" name="close" class="autofocus"><strong>OK</strong></button>')+"</p></form>").css("max-width",t.maxWidth||480)},dispatchClickButton:function(t){var e=t.currentTarget;e.name&&(app.dispatchingButton=e,app.dispatchingPopup=this,t.preventDefault(),t.stopImmediatePropagation(),this[e.name](e.value,e),delete app.dispatchingButton,delete app.dispatchingPopup)},dispatchSubmit:function(t){t.preventDefault(),t.stopPropagation();for(var e=R(t.currentTarget).serializeArray(),o={},i=0,s=e.length;i<s;i++){var n=e[i].name,a=e[i].value;o[n]?(o[n].push||(o[n]=[o[n]]),o[n].push(a||"")):o[n]=a||""}this.submit(o)},send:function(t){app.send(t)},remove:function(){var t=this.$el.parent();Backbone.View.prototype.remove.apply(this,arguments),t.hasClass("ps-overlay")&&t.remove()},close:function(){app.closePopup()},register:function(){var t=app.user.get("registered");app.closePopup(),t&&t.userid===app.user.get("userid")?app.addPopupMessage("You are already registered!"):app.addPopup(RegisterPopup)}})),s=this.PromptPopup=k.extend({initialize:function(t){var e;t&&t.message&&"function"==typeof t.callback&&(this.callback=t.callback,e="<form>",e=(e=(e+='<p><label class="label">'+t.message)+'<input class="textbox autofocus" type="text" name="data" value="'+BattleLog.escapeHTML(t.value||"")+'" /></label></p>')+'<p class="buttonbar"><button type="submit"><strong>'+t.button+'</strong></button> <button type="button" name="close">Cancel</button></p>',this.$el.html(e+="</form>"))},submit:function(t){this.close(),this.callback(t.data)}}),b=(Config.groups=Config.groups||{"~":{name:"Administrator (~)",type:"leadership",order:10001},"#":{name:"Room Owner (#)",type:"leadership",order:10002},"&":{name:"Administrator (&amp;)",type:"leadership",order:10003},"★":{name:"Host (★)",type:"staff",order:10004},"@":{name:"Moderator (@)",type:"staff",order:10005},"%":{name:"Driver (%)",type:"staff",order:10006},"§":{name:"Section Leader (§)",type:"staff",order:10007},"*":{name:"Bot (*)",type:"normal",order:10008},"☆":{name:"Player (☆)",type:"normal",order:10009},"+":{name:"Voice (+)",type:"normal",order:10010}," ":{type:"normal",order:10011},"!":{name:"<span style='color:#777777'>Muted (!)</span>",type:"punishment",order:10012},"✖":{name:"<span style='color:#777777'>Namelocked (✖)</span>",type:"punishment",order:10013},"‽":{name:"<span style='color:#777777'>Locked (‽)</span>",type:"punishment",order:10014}},this.UserPopup=k.extend({initialize:function(t){t.userid=toID(t.name);var e=t.name;this.data=t=_.extend(t,b.dataCache[t.userid]),t.name=e,app.on("response:userdetails",this.update,this),app.send("/cmd userdetails "+t.userid),this.update()},events:{"click .ilink":"clickLink","click .trainersprite.yours":"avatars"},update:function(t){t&&t.userid===this.data.userid?(t=_.extend(this.data,t),b.dataCache[t.userid]=_.clone(t),delete b.dataCache[t.userid].roomGroup):t=this.data;var e=t.userid,o=t.name,i=t.avatar||"",s=(Config.groups[t.roomGroup]||{}).name||"",n=Config.groups[t.group||Config.defaultGroup||" "]||null,a="",r=(n&&n.name&&toID(n.name)!==toID(t.customgroup)&&("punishment"===n.type?s=n.name:s&&s!==n.name?a="Global "+n.name:s="Global "+n.name),app.user.get("userid")),n='<div class="userdetails">',i=(i&&(n+='<img class="trainersprite'+(e===r?" yours":"")+'" src="'+Dex.resolveAvatar(i)+'" />'),n+='<strong><a href="//'+Config.routes.users+"/"+e+'" target="_blank">'+BattleLog.escapeHTML(o)+"</a></strong><br />",!1===t.rooms);if((t.status||i)&&(o=i?"(Offline)":t.status.startsWith("!")?t.status.slice(1):t.status,n+='<span class="userstatus'+(i?" offline":"")+'">'+BattleLog.escapeHTML(o)+"<br /></span>"),s&&(n+='<small class="usergroup roomgroup">'+s+"</small>",a&&(n+="<br />")),a&&(n+='<small class="usergroup globalgroup">'+a+"</small>"),t.customgroup&&toID(t.customgroup)!==toID(a||s)&&((s||a)&&(n+="<br />"),n+='<small class="usergroup globalgroup">'+BattleLog.escapeHTML(t.customgroup)+"</small>"),t.rooms){var p,u,l,c,d,h,m="",f="",g="";for(p in t.rooms)"global"!==p&&(u="",/[A-Za-z0-9]/.test(p.charAt(0))||(u='<small style="color: #888; font-size: 100%">'+p.charAt(0)+"</small>"),"battle-"===(l=toRoomid(p)).substr(0,7)?(h=t.rooms[p].p1.substr(1),c=t.rooms[p].p2.substr(1),d=r===toUserid(h)||r===toUserid(c),h='<span title="'+(BattleLog.escapeHTML(h)||"?")+" v. "+(BattleLog.escapeHTML(c)||"?")+'"><a href="'+app.root+l+'" class="ilink'+(d||app.rooms[p]?" yours":"")+'">'+u+l.substr(7)+"</a></span>",t.rooms[p].isPrivate?(g?g+=", ":g="<br /><em>Private rooms:</em> ",g+=h):(m?m+=", ":m="<br /><em>Battles:</em> ",m+=h)):(h='<a href="'+app.root+l+'" class="ilink'+(app.rooms[p]?" yours":"")+'">'+u+l+"</a>",t.rooms[p].isPrivate?(g?g+=", ":g="<br /><em>Private rooms:</em> ",g+=h):(f?f+=", ":f="<br /><em>Chatrooms:</em> ",f+=h)));n+='<small class="rooms">'+m+f+g+"</small>"}n+='</div><p class="buttonbar">',e!==app.user.get("userid")&&app.user.get("named")?n+='<button name="challenge">Challenge</button> <button name="pm">Chat</button> <button name="userOptions">…</button>':(n+="<button disabled>Challenge</button>",e===app.user.get("userid")?n+=' <button name="pm">Chat self</button></p><hr /><p class="buttonbar" style="text-align: right"><button name="login"><i class="fa fa-pencil"></i> Change name</button> <button name="logout"><i class="fa fa-power-off"></i> Log out</button>':n+=" <button disabled>Chat self</button>"),this.$el.html(n+="</p>")},clickLink:function(t){var e;t.cmdKey||t.metaKey||t.ctrlKey||(t.preventDefault(),t.stopPropagation(),this.close(),e=R(t.currentTarget).attr("href").substr(app.root.length),app.tryJoinRoom(e))},avatars:function(){app.addPopup(AvatarsPopup)},challenge:function(){app.rooms[""].requestNotifications(),this.close(),app.focusRoom(""),app.rooms[""].challenge(this.data.name)},pm:function(){app.rooms[""].requestNotifications(),this.close(),app.focusRoom(""),app.rooms[""].focusPM(this.data.name)},login:function(){app.addPopup(LoginPopup)},logout:function(){app.user.logout(),this.close()},userOptions:function(){app.addPopup(e,{name:this.data.name,userid:this.data.userid})}},{dataCache:{}})),e=this.UserOptions=k.extend({initialize:function(t){this.name=t.name,this.userid=t.userid,this.update()},update:function(){this.$el.html('<p><button name="toggleIgnoreUser">'+(app.ignore[this.userid]?"Unignore":"Ignore")+'</button></p><p><button name="report">Report</button></p>')},report:function(){app.joinRoom("view-help-request-report-user-"+this.userid)},toggleIgnoreUser:function(){var t="User '"+this.name+"'",e=(app.ignore[this.userid]?(delete app.ignore[this.userid],t+=" no longer ignored."):(app.ignore[this.userid]=1,t+=" ignored. (Moderator messages will not be ignored.)"),app.saveIgnore(),R(".pm-window-"+this.userid));if(e.length&&"none"!==e.css("display"))e.find(".inner").append('<div class="chat">'+BattleLog.escapeHTML(t)+"</div>");else{e=app.curRoom&&app.curRoom.add?app.curRoom:app.curSideRoom;if(!e||!e.add)return app.addPopupMessage(t),this.update();e.add(t)}app.dismissPopups()}}),i=this.ReconnectPopup=k.extend({type:"modal",initialize:function(t){app.reconnectPending=!1;var e="<form>";t.cantconnect?(e+="<p class=\"error\">Couldn't connect to server! Try hit 'Retry' if you have not already as the server may not have had enough time to restart.</p>",window.wiiu&&"https:"===document.location.protocol?e+='<p class="error">The Wii U does not support secure connections.</p><p class="buttonbar"><button name="tryhttp" autofocus><strong>Connect insecurely</button> <button name="close">Work offline</button></p>':"https:"===document.location.protocol?e+='<p class="buttonbar"><button type="submit"><strong>Retry</strong></button> <button name="tryhttp">Retry with HTTP</button> <button name="close">Work offline</button></p>':e+='<p class="buttonbar"><button type="submit"><strong>Retry</strong></button> <button name="close">Work offline</button></p>'):t.message&&!0!==t.message?e=e+("<p>"+t.message)+'</p><p class="buttonbar"><button type="submit" class="autofocus"><strong>Reconnect</strong></button> <button type="button" name="close">Work offline</button></p>':e+='<p>You have been disconnected &ndash; possibly because the server was restarted.</p><p class="buttonbar"><button type="submit" class="autofocus"><strong>Reconnect</strong></button> <button type="button" name="close">Work offline</button></p>',this.$el.html(e+="</form>")},tryhttp:function(){document.location.replace("http://"+document.location.host+document.location.pathname+"?insecure")},submit:function(t){document.location.reload()}}),n=(this.ProxyPopup=k.extend({type:"modal",initialize:function(t){this.callback=t.callback;var e=(e="<form>")+'<p>Because of <a href="https://en.wikipedia.org/wiki/Same-origin_policy" target="_blank">your browser\'s security restrictions</a> for <code>testclient.html</code>, we need to do this manually:</p>'+('<iframe id="overlay_iframe" src="'+t.uri+'" style="width: 100%; height: 50px;" class="textbox"></iframe>');this.$el.html(e=(e=(e+="<p>Please copy <strong>all the text</strong> from the box above and paste it in the box below.</p>")+'<p>(You should probably <a href="https://github.com/smogon/pokemon-showdown-client#test-keys" target="_blank">set up</a> <code>config/testclient-key.js</code> so you don\'t have to do this every time.)</p>'+'<p><label class="label" style="float: left;">Data from the box above:</label> <input style="width: 100%;" class="textbox autofocus" type="text" name="result" /></p>')+'<p class="buttonbar"><button type="submit"><strong>Submit</strong></button> <button type="button" name="close">Cancel</button></p>'+"</form>").css("min-width",500)},submit:function(t){this.close(),this.callback(t.result)}}),this.ReplayUploadedPopup=k.extend({type:"semimodal",events:{"click a":"clickClose"},initialize:function(t){var e="<p>Your replay has been uploaded! It's available at:</p>";e+='<p> <a class="replay-link" href="https://'+Config.routes.replays+"/"+t.id+'" target="_blank" class="no-panel-intercept">https://'+Config.routes.replays+"/"+t.id+'</a> <button name="copyReplayLink">Copy</button></p>',this.$el.html(e+='<p><button class="autofocus" name="close">Close</button><p>').css("max-width",620)},clickClose:function(){this.close()},submit:function(t){this.close()},copyReplayLink:function(){var t=this.$(".replay-link")[0],e=document.createElement("input");e.id="dummyReplayLink",e.value=t.href,e.style.position="absolute",t.appendChild(e),e.select(),document.execCommand("copy"),t.removeChild(e)}})),C=this.RulesPopup=k.extend({type:"modal",initialize:function(t){var e="warning"in t,o="";e&&(o+='<p><strong style="color:red">'+(BattleLog.escapeHTML(t.warning)||"You have been warned for breaking the rules.")+"</strong></p>"),o+="<h2>Pok&eacute;mon Showdown Rules</h2><p><b>Global</b></p><p><b>1.</b> Be nice to people. Respect people. Don't be rude or mean to people.</p><p><b>2.</b> Follow US laws (PS is based in the US). No porn (minors use PS), don't distribute pirated material, and don't slander others.</p><p><b>3.</b>&nbsp;No sex. Don't discuss anything sexually explicit, not even in private messages, not even if you're both adults.</p><p><b>4.</b>&nbsp;No cheating. Don't exploit bugs to gain an unfair advantage. Don't game the system (by intentionally losing against yourself or a friend in a ladder match, by timerstalling, etc). Don't impersonate staff if you're not.</p><p><b>5.</b> Moderators have discretion to punish any behaviour they deem inappropriate, whether or not it's on this list. If you disagree with a moderator ruling, appeal to an administrator (a user with &amp; next to their name) or <a href='https://pokemonshowdown.com/appeal'>Discipline Appeals</a>.</p><p>(Note: The First Amendment does not apply to PS, since PS is not a government organization.)</p><p><b>Chat</b></p><p><b>1.</b> Do not spam, flame, or troll. This includes advertising, raiding, asking questions with one-word answers in the lobby, and flooding the chat such as by copy/pasting logs in the lobby.</p><p><b>2.</b> Don't call unnecessary attention to yourself. Don't be obnoxious. ALL CAPS and <i>formatting</i> are acceptable to emphasize things, but should be used sparingly, not all the time.</p><p><b>3.</b> No minimodding: don't mod if it's not your job. Don't tell people they'll be muted, don't ask for people to be muted, and don't talk about whether or not people should be muted ('inb4 mute', etc). This applies to bans and other punishments, too.</p><p><b>4.</b> We reserve the right to tell you to stop discussing moderator decisions if you become unreasonable or belligerent</p><p><b>5.</b> English only, unless specified otherwise.</p><p>(Note: You can opt out of chat rules in private chat rooms and battle rooms, but only if all ROs or players agree to it.)</p>",e||(o+='<p><b>Usernames</b></p><p>Your username can be chosen and changed at any time. Keep in mind:</p><p><b>1.</b> Usernames may not impersonate a recognized user (a user with %, @, #, or &amp; next to their name) or a famous person/organization that uses PS or is associated with Pokémon.</p><p><b>2.</b> Usernames may not be derogatory or insulting in nature, to an individual or group (insulting yourself is okay as long as it\'s not too serious).</p><p><b>3.</b> Usernames may not directly reference sexual activity, or be excessively disgusting.</p><p>This policy is less restrictive than that of many places, so you might see some "borderline" nicknames that might not be accepted elsewhere. You might consider it unfair that they are allowed to keep their nickname. The fact remains that their nickname follows the above rules, and if you were asked to choose a new name, yours does not.</p>'),e?(o+='<p class="buttonbar"><button name="close" disabled>Close</button><small class="overlay-warn"> You will be able to close this in 5 seconds</small></p>',setTimeout(_.bind(this.rulesTimeout,this),5e3)):(this.type="semimodal",o+='<p class="buttonbar"><button name="close" class="autofocus">Close</button></p>'),this.$el.css("max-width",760).html(o)},rulesTimeout:function(){this.$("button")[0].disabled=!1,this.$(".overlay-warn").remove()}})}).call(this,jQuery);
